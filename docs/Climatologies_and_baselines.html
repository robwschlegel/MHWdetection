<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="AJ Smit" />

<meta name="date" content="2019-03-19" />

<title>Alternative climatologies and baselines</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">MHWdetection</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/jdblischak/workflowr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Alternative climatologies and baselines</h1>
<h4 class="author"><em>AJ Smit</em></h4>
<h4 class="date"><em>2019-03-19</em></h4>

</div>


<p><strong>Last updated:</strong> 2019-03-19</p>
<strong>workflowr checks:</strong> <small>(Click a bullet for more information)</small>
<ul>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>R Markdown file:</strong> up-to-date </summary></p>
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Environment:</strong> empty </summary></p>
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Seed:</strong> <code>set.seed(20190319)</code> </summary></p>
<p>The command <code>set.seed(20190319)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Session information:</strong> recorded </summary></p>
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Repository version:</strong> <a href="https://github.com/robwschlegel/MHWdetection/tree/64ac134076a04088c834291ce86c6405eedaf672" target="_blank">64ac134</a> </summary></p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility. The version displayed above was the version of the Git repository at the time these results were generated. <br><br> Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    vignettes/data/sst_ALL_clim_only.Rdata
    Ignored:    vignettes/data/sst_ALL_event_aov_tukey.Rdata
    Ignored:    vignettes/data/sst_ALL_flat.Rdata
    Ignored:    vignettes/data/sst_ALL_miss.Rdata
    Ignored:    vignettes/data/sst_ALL_miss_cat_chi.Rdata
    Ignored:    vignettes/data/sst_ALL_miss_clim_event_cat.Rdata
    Ignored:    vignettes/data/sst_ALL_miss_clim_only.Rdata
    Ignored:    vignettes/data/sst_ALL_repl.Rdata
    Ignored:    vignettes/data/sst_ALL_smooth.Rdata
    Ignored:    vignettes/data/sst_ALL_smooth_aov_tukey.Rdata
    Ignored:    vignettes/data/sst_ALL_smooth_event.Rdata
    Ignored:    vignettes/data/sst_ALL_trend.Rdata
    Ignored:    vignettes/data/sst_ALL_trend_clim_event_cat.Rdata

Untracked files:
    Untracked:  analysis/bibliography.bib
    Untracked:  analysis/data/
    Untracked:  code/functions.R
    Untracked:  code/workflow.R
    Untracked:  data/sst_WA.csv
    Untracked:  docs/figure/

Unstaged changes:
    Modified:   NEWS.md

</code></pre>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes. </details>
</li>
</ul>
<details> <summary> <small><strong>Expand here to see past versions:</strong></small> </summary>
<ul>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
File
</th>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
<th style="text-align:left;">
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWdetection/blob/64ac134076a04088c834291ce86c6405eedaf672/analysis/Climatologies_and_baselines.Rmd" target="_blank">64ac134</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-03-19
</td>
<td style="text-align:left;">
Publish analysis files
</td>
</tr>
</tbody>
</table>
</ul>
<p></details></p>
<hr />
<div id="background" class="section level1">
<h1>Background</h1>
<p>A time series of temperatures taken at a specific locality is a sample of the thermal environment. Because it is a sample, which is used to approximate the true state of the environment, the representivity of the data is subject to certain limitations that have an influence on their accuracy and precision—in other words, on how well the data represent reality. Here we will not concern ourselves with matters of precision and accuracy; rather, we shall deal with ways to produce climatologies from a time series of daily thermal measurements.</p>
<p>A climatological mean is a multi-year average over a base period of typically 30 years duration. Sometimes the climatology is also called a ‘climate normal.’ It predicts the temperatures over an annual cycle that will most likely be experienced at a particular place and time.</p>
<p>Another concept that we use here instead of a climatology is a baseline… <definition to follow>.</p>
<div class="figure">
<img src="fig/heatwaveR_v3.svg" alt="Figure 1. Processing pipeline in the detect() algorithm with emphasis on the climatology and baseline procedures. The dark black arrows indicate the options that are currently available." style="width:100.0%" />
<p class="caption"><strong>Figure 1.</strong> Processing pipeline in the <code>detect()</code> algorithm with emphasis on the climatology and baseline procedures. The dark black arrows indicate the options that are currently available.</p>
</div>
<div id="the-default-climatology-and-threshold" class="section level2">
<h2>The default climatology and threshold</h2>
<p>Central to the functioning of the <strong>heatwaveR</strong> detect algorithm is the climatology, which is the reference against which the extremes are calculated. For historical reasons—which also turn out to make good practical sense—it has become standard practice to base a climatology on 30 years’ worth of data, updated at the start of each new decade (the most recent being 1981-2010). For the <strong>heatwaveR</strong> package we recommend the same. Because heat wave detection is based on daily data, a daily climatology is required. That is, the mean value for each of the days in a 365 (non-leap) or 366 (leap) day long year. In the case of gridded data, we also require that the climatology is at the same spatial resolution as the SST time series within which the extreme events are sought. In the case of the dOISST v2. data, it is independently calculated at each of the 1/4° grid cells, and for station data it must be representative of that station and preferably also obtained with the same instrument that yielded the seawater temperature time series entering the event detection algorithm (in fact, the algorithm will by default use the daily time series to derive the climatology).</p>
<p>In a daily climatology, there will be one mean temperature for each day of the year (365 or 366 days, depending on how leap years are dealt with). How the daily mean is calculated can vary somewhat from application to application. The <code>detect()</code> function applies a window centred on a sliding Julian day for the pooling of values that will form the basis for calculation of the climatology and threshold percentile. We use a default of 5 days, which gives a window width of 11 days centred on the 6th day of the series of 11 days. For example, the mean temperature for Julian day 6 will be comprised of all temperatures measured from Julian days 1 to 11, across 30 years, i.e. 330 temperature measurements are summarised in this climatological daily mean. A sliding window centred on Julian day 7 will comprise all temperatures measured on Julian days 2 to 12 over the 30 years; etc. Currently we do not provide the option to calculate a weighted mean; rather, each day receives the same weighting as any other day, irrespective of how far the day is from the one on which the sliding window is centred. Climatologies produced with sliding windows of width 1, 11, 31, and 61 days are presented in Figure 1. In the figure we see that the wider the sliding window becomes the less day-to-day noise is retained in the climatology.</p>
<pre class="r"><code>library(tidyverse) # misc. data processing conveniences
library(lubridate) # for working with dates
library(heatwaveR)</code></pre>
<pre class="r"><code># Using a built-in data set
# smoothPercentile = FALSE
res.1.F &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;),
                  windowHalfWidth = 0, smoothPercentile = F, clmOnly = TRUE)
res.11.F &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;),
                   smoothPercentile = F, clmOnly = TRUE)
res.31.F &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;),
                   windowHalfWidth = 15, smoothPercentile = F, clmOnly = TRUE)
res.61.F &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;),
                   windowHalfWidth = 30, smoothPercentile = F, clmOnly = TRUE)</code></pre>
<pre class="r"><code>res.1.F &lt;- res.1.F %&gt;% 
  mutate(width = &quot;1&quot;)
res.11.F &lt;- res.11.F %&gt;% 
  mutate(width = &quot;11&quot;)
res.31.F &lt;- res.31.F %&gt;% 
  mutate(width = &quot;31&quot;)
res.61.F &lt;- res.61.F %&gt;% 
  mutate(width = &quot;61&quot;)
no_smooth &lt;- rbind(res.1.F, res.11.F, res.31.F, res.61.F)

plt1 &lt;- ggplot(data = no_smooth,
       aes(x = doy, y = seas)) +
  geom_line(aes(colour = width, size = width)) +
  geom_line(aes(y = thresh, colour = width, size = width)) +
  scale_colour_manual(name = &quot;Width&quot;,
                      values = c(&quot;grey50&quot;, &quot;orange&quot;, &quot;purple&quot;, &quot;black&quot;)) +
  scale_size_manual(values = c(0.4, 0.4, 0.4, 0.8), guide = FALSE) +
  labs(x = &quot;Julian day&quot;, y = &quot;SST (°C)&quot;, title = &quot;Annual cycle climatology and threshold&quot;,
       subtitle = &quot;1983-01-01 to 2012-12-31 reference period; smooth off&quot;) +
  theme_publ()
ggsave(plt1, file = &quot;climat_1.png&quot;, width = 6, height = 2.8, dpi = 120)</code></pre>
<div class="figure">
<img src="fig/climat_1.png" alt="Figure 2. Daily climatologies of the mean (lower lines) and 90th percentile (top lines) produced by the detect() function, with various windowHalfWidth values and with smoothPercentile switched off." style="width:80.0%" />
<p class="caption"><strong>Figure 2.</strong> Daily climatologies of the mean (lower lines) and 90th percentile (top lines) produced by the <code>detect()</code> function, with various <code>windowHalfWidth</code> values and with <code>smoothPercentile</code> switched off.</p>
</div>
<p>To produce smoother climatologies, we can additionally enable a moving average smoother. The result is shown in Figure 3.</p>
<pre class="r"><code>#smoothPercentile = TRUE
res.11.T &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;), clmOnly = TRUE)
res.31.T &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;), clmOnly = TRUE, windowHalfWidth = 15)
res.61.T &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;), clmOnly = TRUE, windowHalfWidth = 30)</code></pre>
<pre class="r"><code>res.11.T &lt;- res.11.T %&gt;% 
  mutate(width = &quot;11&quot;)
res.31.T &lt;- res.31.T %&gt;% 
  mutate(width = &quot;31&quot;)
res.61.T &lt;- res.61.T %&gt;% 
  mutate(width = &quot;61&quot;)
smooth &lt;- rbind(res.11.T, res.31.T, res.61.T)

plt2 &lt;- ggplot(data = smooth,
       aes(x = doy, y = seas)) +
  geom_line(aes(colour = width, size = width)) +
  geom_line(aes(y = thresh, colour = width, size = width)) +
  scale_colour_manual(name = &quot;Width&quot;,
                      values = c(&quot;orange&quot;, &quot;purple&quot;, &quot;black&quot;)) +
  scale_size_manual(values = c(0.4, 0.4, 0.8), guide = FALSE) +  
  labs(x = &quot;Julian day&quot;, y = &quot;SST (°C)&quot;, title = &quot;Annual cycle climatology and threshold&quot;,
       subtitle = &quot;1983-01-01 to 2012-12-31 reference period; smooth on&quot;) +
  theme_publ()
ggsave(plt2, file = &quot;climat_2.png&quot;, width = 6, height = 2.8, dpi = 120)</code></pre>
<div class="figure">
<img src="fig/climat_2.png" alt="Figure 3. Daily climatologies of the mean (lower lines) and 90th percentile (upper lines) produced by the detect() function, with various windowHalfWidth values and with smoothPercentile at the default value of 31 days." style="width:80.0%" />
<p class="caption"><strong>Figure 3.</strong> Daily climatologies of the mean (lower lines) and 90th percentile (upper lines) produced by the <code>detect()</code> function, with various <code>windowHalfWidth</code> values and with <code>smoothPercentile</code> at the default value of 31 days.</p>
</div>
<div id="fourier-analysis-of-time-series-to-construct-a-smooth-climatology" class="section level3">
<h3>Fourier analysis of time series to construct a smooth climatology</h3>
<pre class="r"><code>library(fda)
clm &lt;- res.1.F %&gt;% 
  as_tibble

b7 &lt;- create.fourier.basis(rangeval = range(clm$doy), nbasis = 7)
# plot(b7)

# b7.val &lt;- as_tibble(eval.basis(clm$doy, basisobj = b7))
# b7.val &lt;- cbind(doy = clm$doy, b7.val) %&gt;% 
#   gather(key = &quot;basis&quot;, value = &quot;value&quot;, -doy) %&gt;% 
#   as_tibble()

# create smooth seasonal climatology
b7.seas.smth &lt;- smooth.basis(argvals = clm$doy, y = clm$seas, fdParobj = b7)$fd
clm.seas.smth &lt;- eval.fd(clm$doy, b7.seas.smth)

# create  smooth threshold
b7.thresh.smth &lt;- smooth.basis(argvals = clm$doy, y = clm$thresh, fdParobj = b7)$fd
clm.thresh.smth &lt;- eval.fd(clm$doy, b7.thresh.smth)

temps &lt;- as_tibble(data.frame(doy = clm$doy,
                              seas.unsmth_1 = clm$seas,
                              seas.smth_11 = res.11.T$seas,
                              clim.fourier_7 = clm.seas.smth,
                              thresh.unsmth_1 = clm$thresh,
                              thresh.smth_11 = res.11.T$thresh,
                              thresh.fourier_7 = clm.thresh.smth))</code></pre>
<pre class="r"><code>library(forcats)
plt3 &lt;- temps %&gt;% 
  gather(key = &quot;type&quot;, value = &quot;temperature&quot;, -doy) %&gt;% 
  ggplot(aes(x = doy, y = temperature)) +
  geom_line(aes(colour = fct_inorder(type), size = fct_inorder(type))) +
  scale_colour_manual(name = &quot;Smooth&quot;,
                      values = c(&quot;grey50&quot;, &quot;purple&quot;, &quot;black&quot;, &quot;grey50&quot;, &quot;purple&quot;, &quot;black&quot;),
                      labels = c(&quot;1, unsmooth&quot;, &quot;11, smooth&quot;, &quot;Fourier&quot;),
                      breaks = c(&quot;seas.unsmth_1&quot;, &quot;seas.smth_11&quot;, &quot;clim.fourier_7&quot;)) +
  scale_size_manual(values = c(0.4, 0.4, 0.8, 0.4, 0.4, 0.8), guide = FALSE) +
  labs(x = &quot;Julian day&quot;, y = &quot;SST (°C)&quot;, title = &quot;Annual cycle climatology and threshold&quot;,
       subtitle = &quot;1983-01-01 to 2012-12-31 reference period&quot;) +
  theme_publ()
ggsave(plt3, file = &quot;climat_3.png&quot;, width = 6, height = 2.8, dpi = 120)
# plot(b7.seas.smth[1:7])
# b7.PCA = pca.fd(b7.seas.smth, nharm=6)</code></pre>
<div class="figure">
<img src="fig/climat_3.png" alt="Figure 4. Daily climatologies of the mean (lower lines) and 90th percentile (upper lines) produced by the detect() function; 1, unsmooth indicates that a windowHalfWidth of 0 days had been set, and that the data had not been subjected to smoothPercentile; 11, smooth is the default settings of the detect() function; and Fourier indicates that an alternative climatology had been produced through the application of a Fourier analysis with 7 basis points." style="width:80.0%" />
<p class="caption"><strong>Figure 4.</strong> Daily climatologies of the mean (lower lines) and 90th percentile (upper lines) produced by the <code>detect()</code> function; “1, unsmooth” indicates that a <code>windowHalfWidth</code> of 0 days had been set, and that the data had not been subjected to <code>smoothPercentile</code>; “11, smooth” is the default settings of the <code>detect()</code> function; and “Fourier” indicates that an alternative climatology had been produced through the application of a Fourier analysis with 7 basis points.</p>
</div>
<pre class="r"><code># library(TSA)
# # compute the Fourier Transform
# p &lt;- periodogram(y)
# dd &lt;- data.frame(freq = p$freq, spec = p$spec)
# order &lt;- dd[order(-dd$spec), ]
# top6 &lt;- head(order, 6)
# # display the 6 highest &quot;power&quot; frequencies
# top6
# # convert frequency to time periods
# time &lt;- 1/top6$f
# time</code></pre>
<pre class="r"><code># fft(y)
# spectrum(y)</code></pre>
<pre class="r"><code># require(graphics)
# spec.y &lt;- spec.pgram(y)
# plot(spec.y, plot.type = &quot;coherency&quot;)
# plot(spec.y, plot.type = &quot;phase&quot;)
# library(GeneCycle)
# GeneCycle::periodogram(y)</code></pre>
</div>
</div>
<div id="using-a-custom-baseline" class="section level2">
<h2>Using a custom baseline</h2>
<p>Should one want to use a different baseline to calculate the climatology against which the events should be detected, this is now possible.</p>
<pre class="r"><code># Again, using the built-in time series
# The Hobday et al. (2016) default definition applied above is available in
# `res.11.T`; we repeat it her and return the original time series with the
# climatology so as to have data in the specified format as required by the
# detect function, `detect_event()`:

res.11.T.full &lt;- ts2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;), clmOnly = FALSE)

# Calculate an anomaly:
daily.dat &lt;- res.11.T.full %&gt;%
  mutate(anom = temp - mean(temp, na.rm = TRUE),
         num = seq(1:length(temp)))

# Let us remove the long-term non-linear trend from the WA anomaly data using a 
# generalised additive model; first, define the GAM:
library(mgcv)
library(broom)
mod.gam &lt;- gam(temp ~ s(num, k = 20), data = daily.dat)
daily.dat2 &lt;- augment(mod.gam)
daily.dat2 &lt;- cbind(daily.dat2, daily.dat[, c(&quot;doy&quot;, &quot;t&quot;, &quot;anom&quot;)])

raw.clim &lt;- ts2clm(daily.dat2, x = t, y = anom,
                   climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;), clmOnly = FALSE)

detrended.clim &lt;- ts2clm(daily.dat2, x = t, y = .resid,
                   climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;), clmOnly = FALSE)

# Plot the two climatologies (raw vs. detrended):
plt4 &lt;- ggplot(data = filter(raw.clim, t &lt; &quot;1983-01-01&quot;), aes(x = doy, y = seas)) +
  geom_line(colour = &quot;black&quot;) +
  geom_line(data = filter(detrended.clim, t &lt; &quot;1983-01-01&quot;),
            colour = &quot;red&quot;, alpha = 0.6) +
  theme_publ()
ggsave(plt4, file = &quot;climat_4.png&quot;, width = 12, height = 6, dpi = 120)
# ... there is a tiny, almost imperceptable difference between the two...

# Calculate events in the original WA SST (anomaly) relative to a climatology 
# created from the detrended WA SST data:
raw.res &lt;- detect_event(raw.clim, x = t, y = anom,
                              seasClim = seas,
                              threshClim = thresh)

detrended.res &lt;- detect_event(raw.clim, x = t, y = anom,
                              seasClim = detrended.clim$seas,
                              threshClim = detrended.clim$thresh)</code></pre>
<div class="figure">
<img src="fig/climat_4.png" alt="Figure 5. Daily climatologies of the WA SST (anomalies). The black line is the climatology prepared from the raw data, and the red line represents the daily SST anomalies that had been detrended using a generalised additive model. The lines plot practically on top of each other, so differences are barely perceptable; yet, despite these apparently small differences, there are large consequences for the events that are detected, as can be seen in the printout of the top 10 events, as seen below." style="width:80.0%" />
<p class="caption"><strong>Figure 5.</strong> Daily climatologies of the WA SST (anomalies). The black line is the climatology prepared from the raw data, and the red line represents the daily SST anomalies that had been detrended using a generalised additive model. The lines plot practically on top of each other, so differences are barely perceptable; yet, despite these apparently small differences, there are large consequences for the events that are detected, as can be seen in the printout of the top 10 events, as seen below.</p>
</div>
<pre class="r"><code>raw.res</code></pre>
<pre class="r"><code>detrended.res</code></pre>
<p>The events that get detected are somewhat different now. Notice that in <code>detrended.clim</code>, <code>seas</code> and <code>thresh</code> are unfortunately the ones that were calculated together with raw (anomaly) time series, not the <code>seas</code> and <code>thresh</code> that were actually used and included against climSeas and climThresh. We will fix that.</p>
</div>
<div id="using-a-custom-climatology" class="section level2">
<h2>Using a custom climatology</h2>
<p>If one would rather supply a pre-calculated climatology, and not calculate one from a baseline, this is also now possible.</p>
<pre class="r"><code># Pull out the climatologies from the built in time series
# ts1_clim &lt;- detect_evets2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;))$clim %&gt;%
#   dplyr::select(doy, seas, thresh, var_clim_year) %&gt;%
#   base::unique() %&gt;%
#   dplyr::arrange(doy)
# ts2_clim &lt;- detect_evets2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;))$clim %&gt;%
#   dplyr::select(doy, seas, thresh, var_clim_year) %&gt;%
#   base::unique() %&gt;%
#   dplyr::arrange(doy)
# ts3_clim &lt;- detect_evets2clm(sst_WA, climatologyPeriod = c(&quot;1983-01-01&quot;, &quot;2012-12-31&quot;))$clim %&gt;%
#   dplyr::select(doy, seas, thresh, var_clim_year) %&gt;%
#   base::unique() %&gt;%
#   dplyr::arrange(doy)
# 
# # Calculate events in one time series with a climatology from another
# res_clim_diff &lt;- detect_event(ts1, alt_clim = TRUE, alt_clim_data = ts2_clim)</code></pre>
<p>Note how the climatologies are the same below:</p>
<pre class="r"><code># head(ts2_clim)
# head(res_clim_diff$clim)</code></pre>
<p>Should the provided climatology be to low, the function will return a warning letting the user know this.</p>
<pre class="r"><code># # Calculate events in one time series with a climatology from another
# res_clim_diff &lt;- detect_event(ts1, alt_clim = TRUE, alt_clim_data = ts3_clim)</code></pre>
<div id="refs">

</div>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
</div>
</div>

<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

<hr>
<p>
  This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a>
  analysis was created with
  <a href="https://github.com/jdblischak/workflowr">workflowr</a> 1.1.1
</p>
<hr>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
