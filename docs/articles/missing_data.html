<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assessing the effect of random missing data • MHWdetection</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Assessing the effect of random missing data">
<meta property="og:description" content="This vignette goes into depth on the effects of missing data on the detection of events.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MHWdetection</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/r_vs_python.html">Python vs. R - default outputs</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_arguments.html">Python vs. R - default arguments</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_additional.html">Python vs. R - additional functions</a>
    </li>
    <li>
      <a href="../articles/Short_climatologies.html">Short climatologies</a>
    </li>
    <li>
      <a href="../articles/Climatologies_and_baselines.html">Alternative climatologies and baselines</a>
    </li>
    <li>
      <a href="../articles/time_series_duration.html">Effects of short time series</a>
    </li>
    <li>
      <a href="../articles/missing_data.html">Effects of missing data</a>
    </li>
    <li>
      <a href="../articles/gridded_products.html">Difference between gridded products</a>
    </li>
    <li>
      <a href="../articles/best_practices.html">Best practices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/robwschlegel/MHWdetection">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Assessing the effect of random missing data</h1>
                        <h4 class="author">Robert W Schlegel</h4>
            
            <h4 class="date">2018-09-05</h4>
      
      
      <div class="hidden name"><code>missing_data.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The purpose of this vignette is to quantify the effects that missing data have on the detection of events. Specifically, the relationship between the percentage of missing data, as well as the consecutive number of missing days, on how much the seasonal climatology, the 90th percentile threshold, and the MHW metrics may differ from those detected against the same time series with no missing data.</p>
<p>The missing data will be ‘created’ by striking out existing data from the three pre-packaged time series in the <code>__heatwaveR__</code> package, which themselves have no missing data. This will be done in two ways:</p>
<ul>
<li>the first method will be to simply use a random selection algorithm to indiscriminately remove an increasing proportion of the data;</li>
<li>the second method will be to systematically remove data from specific days/times of the year to simulate missing data that users may encounter in a real-world scenario
<ul>
<li>one method will be to remove only weekend days from the data</li>
<li>another method is to remove only winter data to simulate ice-cover</li>
</ul>
</li>
</ul>
<p>It is hypothesised that the more consecutive missing days of data there are, the bigger the effect will be on the results. It is also hypothesised that consecutive missing days will have a more pronounced effect/be a better indicator of time series strength than the simple proportion of missing data. A third hypothesis is that there will be a relatively clear threshold for consecutive missing days that will prevent accurate MHW detection.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(broom)
<span class="kw">library</span>(heatwaveR)
<span class="kw">library</span>(lubridate) <span class="co"># This is intentionally activated after data.table</span>
<span class="kw">library</span>(fasttime)
<span class="kw">library</span>(ggpubr)
<span class="kw">library</span>(boot)
<span class="kw">library</span>(FNN)
<span class="kw">library</span>(mgcv)
<span class="kw">library</span>(padr)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A clomp of functions used below</span>
<span class="co"># Written out here for tidiness/convenience</span>

<span class="co"># Quantify consecutive missing days</span>
con_miss &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  ex1 &lt;-<span class="st"> </span><span class="kw">rle</span>(<span class="kw">is.na</span>(df<span class="op">$</span>temp))
  ind1 &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">seq_along</span>(ex1<span class="op">$</span>lengths), ex1<span class="op">$</span>lengths)
  s1 &lt;-<span class="st"> </span><span class="kw">split</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(df), ind1)
  res &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind,
                 <span class="kw">lapply</span>(s1[ex1<span class="op">$</span>values <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="cf">function</span>(x)
                   <span class="kw">data.frame</span>(<span class="dt">index_start =</span> <span class="kw">min</span>(x), <span class="dt">index_end =</span> <span class="kw">max</span>(x))
                   )) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">duration =</span> index_end <span class="op">-</span><span class="st"> </span>index_start <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(duration) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>())
  <span class="kw">return</span>(res)
}

<span class="co"># Function for knocking out data but maintaing the time series consistency</span>
random_knockout &lt;-<span class="st"> </span><span class="cf">function</span>(df, prop){
  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># group_by(site) %&gt;% </span>
<span class="st">    </span><span class="kw">sample_frac</span>(<span class="dt">size =</span> prop) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># arrange(site, t) %&gt;%</span>
<span class="st">    </span><span class="kw">arrange</span>(t) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/padr/topics/pad">pad</a></span>(<span class="dt">interval =</span> <span class="st">"day"</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">full_join</span>(sst_cap, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"t"</span>, <span class="st">"temp"</span>, <span class="st">"site"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">miss =</span> <span class="kw">as.character</span>(<span class="dv">1</span><span class="op">-</span>prop))
  <span class="kw">return</span>(res)
}

<span class="co"># Calculate only events</span>
detect_event_event &lt;-<span class="st"> </span><span class="cf">function</span>(df, <span class="dt">y =</span> temp){
  ts_y &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">substitute</span>(y), df)
  df<span class="op">$</span>temp &lt;-<span class="st"> </span>ts_y
  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event</a></span>(df)<span class="op">$</span>event
  <span class="kw">return</span>(res)
  }

<span class="co"># Run an ANOVA on each metric of the combined event results and get the p-value</span>
event_aov_p &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  aov_models &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw">grep</span>(<span class="st">"miss"</span>, <span class="kw">names</span>(df))] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">aov</span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>miss)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a></span>(.), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">p.value =</span> <span class="kw">round</span>(p.value, <span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(term <span class="op">!=</span><span class="st"> "Residuals"</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(metric, p.value)
  <span class="kw">return</span>(aov_models)
  }

<span class="co"># Run an ANOVA on each metric of the combined event results and get CI</span>
event_aov_CI &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  aov_models &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw">grep</span>(<span class="st">"miss"</span>, <span class="kw">names</span>(df))] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">aov</span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>miss)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/confint_tidy">confint_tidy</a></span>(., <span class="dt">parm =</span> ), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">miss =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">"0"</span>, <span class="st">"0.1"</span>, <span class="st">"0.24"</span>, <span class="st">"0.50"</span>), <span class="kw">nrow</span>(.)<span class="op">/</span><span class="dv">4</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(metric, miss, <span class="kw">everything</span>())
  <span class="kw">return</span>(aov_models)
  }

<span class="co"># A particular summary output</span>
event_output &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(miss) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># select(-event_no) %&gt;% </span>
<span class="st">    </span><span class="kw">summarise_all</span>(<span class="kw">c</span>(<span class="st">"mean"</span>, <span class="st">"sd"</span>))
  <span class="kw">return</span>(res)
  }</code></pre></div>
</div>
<div id="random-missing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#random-missing-data" class="anchor"></a>Random missing data</h2>
<div id="knocking-out-data" class="section level3">
<h3 class="hasAnchor">
<a href="#knocking-out-data" class="anchor"></a>Knocking out data</h3>
<p>First up we begin with the random removal of increasing proportions of the data. We are going to use the full 33 year time series for these missing data experiments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First put all of the data together and create a site column</span>
sst_ALL &lt;-<span class="st"> </span><span class="kw">rbind</span>(sst_Med, sst_NW_Atl, sst_WA) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">site =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">"Med"</span>, <span class="st">"NW_Atl"</span>, <span class="st">"WA"</span>), <span class="dt">each =</span> <span class="dv">12053</span>))

<span class="co"># Create a data.frame with the first and last day of each time series </span>
<span class="co"># to ensure that all time series are the same length</span>
sst_cap &lt;-<span class="st"> </span>sst_ALL <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(t <span class="op">==</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">"1982-01-01"</span>) <span class="op">|</span><span class="st"> </span>t <span class="op">==</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">"2014-12-31"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()

<span class="co"># Now let's create a few data.frames with increased proportions of missing data</span>
sst_ALL_miss &lt;-<span class="st"> </span>sst_ALL <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">site2 =</span> site) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site2) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop_10 =</span> <span class="kw">map</span>(data, random_knockout, <span class="dt">prop =</span> <span class="fl">0.9</span>),
         <span class="dt">prop_25 =</span> <span class="kw">map</span>(data, random_knockout, <span class="dt">prop =</span> <span class="fl">0.75</span>),
         <span class="dt">prop_50 =</span> <span class="kw">map</span>(data, random_knockout, <span class="dt">prop =</span> <span class="fl">0.5</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> prop, <span class="dt">value =</span> output, <span class="op">-</span>site2) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>site, <span class="op">-</span>prop) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">site =</span> site2)</code></pre></div>
</div>
<div id="consecutive-missing-days" class="section level3">
<h3 class="hasAnchor">
<a href="#consecutive-missing-days" class="anchor"></a>Consecutive missing days</h3>
<p>With some data randomly removed, let’s see how consecutive these missing data are.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># And now the results</span>
sst_ALL_con &lt;-<span class="st"> </span>sst_ALL_miss <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, miss) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data2 =</span> <span class="kw">map</span>(data, con_miss)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="co"># Visualise</span>
<span class="kw">ggplot</span>(sst_ALL_con, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.factor</span>(duration), <span class="dt">y =</span> count, <span class="dt">fill =</span> site)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(site<span class="op">~</span>miss, <span class="dt">scales =</span> <span class="st">"free_x"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"consecutive missing days"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="missing_data_files/figure-html/con-miss-1.png" alt="Bar plots showing the count of consecutive missing days of data per time series at the three different missing proportions." width="768"><p class="caption">
Bar plots showing the count of consecutive missing days of data per time series at the three different missing proportions.
</p>
</div>
<p>It is reassuring to see that for the 10% and 25% missing data time series there are very few days of consecutive missing data greater than two. This is good because the default MHW detection algorithm setting is to interpolate over days with 2 or fewer missing values. It is therefore unlikely that 1 or 2 consecutive days of missing data will affect the resultant clims or MHWs.</p>
</div>
<div id="seasonal-signal" class="section level3">
<h3 class="hasAnchor">
<a href="#seasonal-signal" class="anchor"></a>Seasonal signal</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_ALL_clim &lt;-<span class="st"> </span>sst_ALL <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">miss =</span> <span class="st">"0"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rbind</span>(., sst_ALL_miss) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, miss) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">clim =</span> <span class="kw">map</span>(data, ts2clm, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2014-12-31"</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># gather(key = clim, value = output, -site) %&gt;% </span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="co"># Pull out only seas and thresh for eas of plotting</span>
sst_ALL_clim_only &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>doy, seas<span class="op">:</span>var) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>()

<span class="co"># visualise</span>
<span class="kw">ggplot</span>(sst_ALL_clim_only, <span class="kw">aes</span>(<span class="dt">y =</span> seas, <span class="dt">x =</span> doy, <span class="dt">colour =</span> miss)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>site, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"calendar day of year"</span>, <span class="dt">y =</span> <span class="st">"temp (C)"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="missing_data_files/figure-html/clim_miss_seas-1.png" alt="The seasonal signals created from time series with increasingly large proportions of missing data." width="768"><p class="caption">
The seasonal signals created from time series with increasingly large proportions of missing data.
</p>
</div>
<p>As we may see in the figure above, there is no perceptible difference in the seasonal signal created from time series with varying amounts of missing data.</p>
</div>
<div id="th-percentile-threshold" class="section level3">
<h3 class="hasAnchor">
<a href="#th-percentile-threshold" class="anchor"></a>90th percentile threshold</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sst_ALL_clim_only, <span class="kw">aes</span>(<span class="dt">y =</span> thresh, <span class="dt">x =</span> doy, <span class="dt">colour =</span> miss)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>site, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"calendar day of year"</span>, <span class="dt">y =</span> <span class="st">"temp (C)"</span>)</code></pre></div>
<p><img src="missing_data_files/figure-html/clim-miss-thresh-1.png" width="768" style="display: block; margin: auto;"></p>
<p>In the figure above we are able to see that the 90th percentile threshold is lower for the time series missing 50% of their data, but that 10% and 25% do not appear different. This is most pronounced for the Western Australia (WA) time series. This will likely have a significant impact on the size of the MHWs detected.</p>
<p>Before we calculate the MHW metrics, let’s look at the output of an ANOVA comparing the seasonal and threshold values against one another across the different proportions of missing data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_ALL_clim_aov &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>t, <span class="op">-</span><span class="st"> </span>temp, <span class="op">-</span>doy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">miss =</span> <span class="kw">as.factor</span>(miss)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_p)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() 

<span class="kw">ggplot</span>(sst_ALL_clim_aov, <span class="kw">aes</span>(<span class="dt">x =</span> site, <span class="dt">y =</span> metric)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> p.value)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">round</span>(p.value, <span class="dv">2</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="dt">midpoint =</span> <span class="fl">0.1</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="missing_data_files/figure-html/clim-miss-AOV-p-1.png" alt="Heatmap showing the ANOVA results for the comparisons of the clim values for the four different proportions of missing data. Only the variance in the climatologies are significantly different at p &lt; 0.05." width="768"><p class="caption">
Heatmap showing the ANOVA results for the comparisons of the clim values for the four different proportions of missing data. Only the variance in the climatologies are significantly different at p &lt; 0.05.
</p>
</div>
<p>If one were to compare this heatmap to those generated by reducing <a href="https://robwschlegel.github.io/MHWdetection/articles/time_series_duration.html">time series length</a>, one would see that the effect of shorter time series on discrepancy between the thresholds is much greater than for missing data.</p>
</div>
<div id="mhw-metrics" class="section level3">
<h3 class="hasAnchor">
<a href="#mhw-metrics" class="anchor"></a>MHW metrics</h3>
<p>Now that we know that as much as 50% missing data from a time series does not produce significantly different thresholds, we now want to see what the downstream effects of these slight differences are on the MHW metrics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate events</span>
sst_ALL_event &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, miss) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_event)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="co">#%&gt;% </span>
  <span class="co"># filter(date_start &gt;= "2002-01-01", date_end &lt;= "2011-12-31") %&gt;% </span>
  <span class="co"># select(-c(index_start:index_end, date_start:date_end))</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ANOVA p</span>
sst_ALL_aov_p &lt;-<span class="st"> </span>sst_ALL_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site, miss, duration, intensity_mean, intensity_max, intensity_cumulative) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_p)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="co">#%&gt;% </span>
  <span class="co"># spread(key = metric, value = p.value)</span>

<span class="co"># visualise</span>
<span class="kw">ggplot</span>(sst_ALL_aov_p, <span class="kw">aes</span>(<span class="dt">x =</span> site, <span class="dt">y =</span> metric)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> p.value)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">round</span>(p.value, <span class="dv">2</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="dt">midpoint =</span> <span class="fl">0.1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="fl">0.5</span>))</code></pre></div>
<div class="figure" style="text-align: center">
<img src="missing_data_files/figure-html/compare-shorten-p-1.png" alt="Heatmap showing the ANOVA results for the comparisons of the main four MHW metrics for the four different proportions of missing data. There are no significant differences." width="768"><p class="caption">
Heatmap showing the ANOVA results for the comparisons of the main four MHW metrics for the four different proportions of missing data. There are no significant differences.
</p>
</div>
<p>As we may see in the figure above, there are no significant differences between the main MHW metrics depending on how much data are missing from a time series. The metrics differ most in the North West Atlantic (NW_Atl) time series, but are not significant.</p>
</div>
</div>
<div id="non-random-missing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#non-random-missing-data" class="anchor"></a>Non-random missing data</h2>
<div id="ice-cover" class="section level3">
<h3 class="hasAnchor">
<a href="#ice-cover" class="anchor"></a>Ice-cover</h3>
</div>
<div id="missing-weekends" class="section level3">
<h3 class="hasAnchor">
<a href="#missing-weekends" class="anchor"></a>Missing weekends</h3>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#random-missing-data">Random missing data</a></li>
      <li><a href="#non-random-missing-data">Non-random missing data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert W. Schlegel, Eric C. J. Oliver, Alistair J. Hobday, Albertus J. Smit.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
