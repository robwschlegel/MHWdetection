<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assessing the effects of long-term trends • MHWdetection</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Assessing the effects of long-term trends">
<meta property="og:description" content="This vignette investigates the effects of long-term trends on the MHWs detected in a time series.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MHWdetection</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/r_vs_python.html">Python vs. R - default outputs</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_arguments.html">Python vs. R - default arguments</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_additional.html">Python vs. R - additional functions</a>
    </li>
    <li>
      <a href="../articles/Short_climatologies.html">Short climatologies</a>
    </li>
    <li>
      <a href="../articles/Climatologies_and_baselines.html">Alternative climatologies and baselines</a>
    </li>
    <li>
      <a href="../articles/time_series_duration.html">Effects of short time series</a>
    </li>
    <li>
      <a href="../articles/missing_data.html">Effects of missing data</a>
    </li>
    <li>
      <a href="../articles/gridded_products.html">Difference between gridded products</a>
    </li>
    <li>
      <a href="../articles/best_practices.html">Best practices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/robwschlegel/MHWdetection">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Assessing the effects of long-term trends</h1>
                        <h4 class="author">Robert W Schlegel</h4>
            
            <h4 class="date">2019-03-07</h4>
      
      
      <div class="hidden name"><code>trend.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The last major variable we want to look at that could potentially affect accurate MHW detection is the long-term (secular) trend present in a time series. To do so we will be using the same de-trended data from the previous two vignettes and slowly adding in decadal trends from 0.01 to 0.30 °C/dec in 0.0.1 °C/dec steps.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(broom)
<span class="kw">library</span>(heatwaveR, <span class="dt">lib.loc =</span> <span class="st">"../../R-packages/"</span>)
<span class="co"># cat(paste0("heatwaveR version = ",packageDescription("heatwaveR")$Version))</span>
<span class="kw">library</span>(lubridate) <span class="co"># This is intentionally activated after data.table</span>
<span class="kw">library</span>(fasttime)
<span class="kw">library</span>(ggpubr)
<span class="kw">library</span>(boot)
<span class="kw">library</span>(FNN)
<span class="kw">library</span>(mgcv)
<span class="co"># library(padr)</span>
<span class="kw">library</span>(ggridges)</code></pre></div>
</div>
<div id="trending" class="section level2">
<h2 class="hasAnchor">
<a href="#trending" class="anchor"></a>Trending</h2>
<p>The following chunks contain the code used to systematically add increasing decadal trends to the three reference time series.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First load the de-trended data created in the duration vignette</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_detrend.Rdata"</span>)

<span class="co"># Function for adding trends to data</span>
<span class="co"># rate &lt;- 0.1</span>
add_trend &lt;-<span class="st"> </span><span class="cf">function</span>(rate){
  daily_step &lt;-<span class="st"> </span>rate<span class="op">/</span><span class="fl">3652.5</span>
  res &lt;-<span class="st"> </span>sst_ALL_detrend <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">row_index =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>(),
           <span class="dt">temp =</span> temp<span class="op">+</span>(row_index<span class="op">*</span>daily_step)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">trend =</span> <span class="kw">as.character</span>(rate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>row_index)
  <span class="kw">return</span>(res)
}

## NB: Not repeating these results as there is no variance possible
<span class="co"># Wrapper function</span>
<span class="co"># This then allows for easier replication</span>
<span class="co"># It expects the data passed to it to already be nested</span>
<span class="co"># trend_repl &lt;- function(rate) {</span>
<span class="co">#   res &lt;- purrr::rerun(100, add_trend(rate)) %&gt;%</span>
<span class="co">#     map_df(as.data.frame, .id = "rep") %&gt;% </span>
<span class="co">#     select(rate, rep, everything())</span>
<span class="co">#   return(res)</span>
<span class="co"># }</span>

<span class="co"># Randomly knockout 0 - 50% of data</span>
<span class="co"># The knockout_repl() function repeats random_knockout() 100 times</span>
<span class="co"># for each step in the missing data progression</span>
doMC<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/doMC/topics/registerDoMC">registerDoMC</a></span>(<span class="dt">cores =</span> <span class="dv">50</span>)
sst_ALL_trend &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/ldply">ldply</a></span>(<span class="kw">seq</span>(<span class="fl">0.00</span>, <span class="fl">0.30</span>, <span class="fl">0.01</span>), add_trend, <span class="dt">.parallel =</span> T)
<span class="kw">save</span>(sst_ALL_trend, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate decadal trends</span>
decadal_trend &lt;-<span class="st"> </span><span class="cf">function</span>(df) {
  df2 &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">date =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span>(t, <span class="st">"month"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">temp =</span> <span class="kw">mean</span>(temp,<span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">year =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(date),
           <span class="dt">num =</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">n</span>()))
    dt &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">as.numeric</span>(<span class="kw">coef</span>(<span class="kw">gls</span>(
      temp <span class="op">~</span><span class="st"> </span>num, <span class="dt">correlation =</span> <span class="kw">corARMA</span>(<span class="dt">form =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>year, <span class="dt">p =</span> <span class="dv">2</span>),
      <span class="dt">method =</span> <span class="st">"REML"</span>, <span class="dt">data =</span> df2, <span class="dt">na.action =</span> na.exclude))[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span><span class="dv">120</span>), <span class="dv">3</span>)
  <span class="kw">return</span>(dt)
}</code></pre></div>
</div>
<div id="climatology-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#climatology-statistics" class="anchor"></a>Climatology statistics</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This file is not uploaded to GitHub as it is too large</span>
<span class="co"># One must first run the above code locally to generate and save the file</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_trend.Rdata"</span>)

<span class="co"># Calculate climatologies, events, and categories on shrinking time series</span>
clim_event_cat_calc &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">clims =</span> <span class="kw">map</span>(data, ts2clm, 
                       <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>)),
           <span class="dt">events =</span> <span class="kw">map</span>(clims, detect_event),
           <span class="dt">cats =</span> <span class="kw">map</span>(events, category)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>data, <span class="op">-</span>clims)
  <span class="kw">return</span>(res)
}

<span class="co"># Calculate all of the MHW related results</span>
doMC<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/doMC/topics/registerDoMC">registerDoMC</a></span>(<span class="dt">cores =</span> <span class="dv">50</span>)
sst_ALL_trend_clim_event_cat &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/ddply">ddply</a></span>(sst_ALL_trend, <span class="kw">c</span>(<span class="st">"trend"</span>, <span class="st">"site"</span>), 
                                           clim_event_cat_calc, <span class="dt">.parallel =</span> T)
<span class="kw">save</span>(sst_ALL_trend_clim_event_cat, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend_clim_event_cat.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This file is not uploaded to GitHub as it is too large</span>
<span class="co"># One must first run the above code locally to generate and save the file</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_clim_event_cat.Rdata"</span>)

<span class="co"># Wrapper function to speed up the extraction of clims</span>
trend_clim_only &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">select</span>(<span class="op">-</span>cats) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(events) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">row_number</span>() <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(events) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(trend<span class="op">:</span>doy, seas<span class="op">:</span>thresh) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(doy)
}

<span class="co"># Pull out only seas and thresh for ease of plotting</span>
doMC<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/doMC/topics/registerDoMC">registerDoMC</a></span>(<span class="dt">cores =</span> <span class="dv">50</span>)
sst_ALL_trend_clim_only &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/ddply">ddply</a></span>(sst_ALL_trend_clim_event_cat, <span class="kw">c</span>(<span class="st">"trend"</span>, <span class="st">"site"</span>), 
                                      trend_clim_only, <span class="dt">.parallel =</span> T)
<span class="kw">save</span>(sst_ALL_trend_clim_only, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend_clim_only.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_clim_only.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sst_ALL_trend_clim_only, 
       <span class="kw">aes</span>(<span class="dt">y =</span> seas, <span class="dt">x =</span> doy, <span class="dt">colour =</span> <span class="kw">as.numeric</span>(trend))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="kw">aes</span>(<span class="dt">group =</span> trend)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_viridis_c</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>site, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Calendar day of year"</span>, <span class="dt">y =</span> <span class="st">"Temp. (°C)"</span>, <span class="dt">colour =</span> <span class="st">"trend (°C/dec)"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="trend_files/figure-html/clim-trend-seas-1.png" alt="The seasonal signals created from time series with increasingly large decadal trends added." width="768"><p class="caption">
The seasonal signals created from time series with increasingly large decadal trends added.
</p>
</div>
<p>Looking at the range of seasonal signals we see how pronounced the effect of adding a decadal trend is to <code>WA</code> over the other two time series. This is because the proportionate to the overall range of the seasonal signal, we are adding much more to the <code>WA</code> time series than the others.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sst_ALL_trend_clim_only, 
       <span class="kw">aes</span>(<span class="dt">y =</span> thresh, <span class="dt">x =</span> doy, <span class="dt">colour =</span> <span class="kw">as.numeric</span>(trend))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="kw">aes</span>(<span class="dt">group =</span> trend)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_viridis_c</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>site, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Calendar day of year"</span>, <span class="dt">y =</span> <span class="st">"Temp. (°C)"</span>, <span class="dt">colour =</span> <span class="st">"trend (°C/dec)"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="trend_files/figure-html/clim-trend-thresh-1.png" alt="The 90th percentile thresholds created from time series with increasingly large decadal trends added." width="768"><p class="caption">
The 90th percentile thresholds created from time series with increasingly large decadal trends added.
</p>
</div>
<p>Interestingly the increase in the 90th percentile threshold appears to be similar for the 90th percentile threshold as it is for the seasonal signal. This implies that the upcoming results are likely to vary from the previous two vignettes.</p>
<div id="anova-p-values" class="section level3">
<h3 class="hasAnchor">
<a href="#anova-p-values" class="anchor"></a>ANOVA <em>p</em>-values</h3>
<p>Given that there are perceptible differences in the seasonal signals as decadal trends increase, an ANOVA will almost certainly determine these differences to be significant.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run an ANOVA on each metric of the event results from </span>
<span class="co"># the same amount of trending data and get the p-value</span>
aov_p &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  aov_models &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw">grep</span>(<span class="st">"trend"</span>, <span class="kw">names</span>(df))] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">aov</span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>trend)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a></span>(.), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">p.value =</span> <span class="kw">round</span>(p.value, <span class="dv">4</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(term <span class="op">!=</span><span class="st"> "Residuals"</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(metric, p.value)
  <span class="kw">return</span>(aov_models)
  }

<span class="co"># Run an ANOVA on each metric and then a Tukey test</span>
aov_tukey &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  aov_tukey &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw">grep</span>(<span class="st">"trend"</span>, <span class="kw">names</span>(df))] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">TukeyHSD</span>(<span class="kw">aov</span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>trend))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a></span>(.), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">p.value =</span> <span class="kw">round</span>(adj.p.value, <span class="dv">4</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># filter(term != "Residuals") %&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(metric, comparison, adj.p.value) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># filter(adj.p.value &lt;= 0.05) %&gt;% </span>
<span class="st">    </span><span class="kw">arrange</span>(metric, adj.p.value)
  <span class="kw">return</span>(aov_tukey)
}

<span class="co"># Quick wrapper for getting results for ANOVA and Tukey on clims</span>
<span class="co"># df &lt;- sst_ALL_trend_clim_only %&gt;%</span>
<span class="co">#   filter(site == "WA") %&gt;%</span>
<span class="co">#   select(-site)</span>
clim_aov_tukey &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># filter(trend != "0.00") %&gt;% </span>
<span class="st">    </span><span class="kw">select</span>(trend, seas, thresh) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">trend =</span> <span class="kw">as.factor</span>(trend)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">aov =</span> <span class="kw">map</span>(data, aov_p),
           <span class="dt">tukey =</span> <span class="kw">map</span>(data, aov_tukey)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>data)
  <span class="kw">return</span>(res)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This file is not uploaded to GitHub as it is too large</span>
<span class="co"># One must first run the above code locally to generate and save the file</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_clim_only.Rdata"</span>)
doMC<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/doMC/topics/registerDoMC">registerDoMC</a></span>(<span class="dt">cores =</span> <span class="dv">50</span>)
sst_ALL_trend_clim_aov_tukey &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/ddply">ddply</a></span>(sst_ALL_trend_clim_only, <span class="kw">c</span>(<span class="st">"site"</span>), 
                                            clim_aov_tukey, <span class="dt">.parallel =</span> T)
<span class="kw">save</span>(sst_ALL_trend_clim_aov_tukey, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend_clim_aov_tukey.Rdata"</span>)
<span class="co"># rm(sst_ALL_smooth, sst_ALL_smooth_aov_tukey)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_clim_aov_tukey.Rdata"</span>)

sst_ALL_trend_clim_aov &lt;-<span class="st"> </span>sst_ALL_trend_clim_aov_tukey <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>tukey) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="kw">ggplot</span>(sst_ALL_trend_clim_aov, <span class="kw">aes</span>(<span class="dt">x =</span> site, <span class="dt">y =</span> metric)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> p.value)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">round</span>(p.value, <span class="dv">2</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="dt">midpoint =</span> <span class="fl">0.1</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="trend_files/figure-html/clim-trend-AOV-p-1.png" alt="Heatmap showing the ANOVA results for the comparisons of the clim values for the different proportions of trending data. The 90th percentile thresholds are significantly different at p &lt; 0.05 but the seasonal signals are not." width="768"><p class="caption">
Heatmap showing the ANOVA results for the comparisons of the clim values for the different proportions of trending data. The 90th percentile thresholds are significantly different at p &lt; 0.05 but the seasonal signals are not.
</p>
</div>
<p>We may see in the figure above that the climatologies do not differ appreciably across all of the decadal trends used for the <code>Med</code> and <code>NW_Atl</code>. The climatologies do however differ significantly for the <code>WA</code> time series.</p>
</div>
<div id="post-hoc-tukey-test" class="section level3">
<h3 class="hasAnchor">
<a href="#post-hoc-tukey-test" class="anchor"></a>Post-hoc Tukey test</h3>
<p>And now to see where exactly the <code>WA</code> climatologies begin to diverge.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_ALL_trend_clim_tukey &lt;-<span class="st"> </span>sst_ALL_trend_clim_aov_tukey <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>aov) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="co"># Create a summary for better plotting</span>
clim_tukey_summary &lt;-<span class="st"> </span>sst_ALL_trend_clim_tukey <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">separate</span>(comparison, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">"comp_left"</span>, <span class="st">"comp_right"</span>), <span class="dt">sep =</span> <span class="st">"-"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">comp_left =</span> <span class="kw">as.numeric</span>(comp_left),
         <span class="dt">comp_right =</span> <span class="kw">as.numeric</span>(comp_right)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(comp_left <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>comp_right <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">comp_dif =</span> <span class="kw">abs</span>(<span class="kw">round</span>(comp_right <span class="op">-</span><span class="st"> </span>comp_left, <span class="dv">2</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(adj.p.value <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, metric, comp_dif)

<span class="kw">ggplot</span>(clim_tukey_summary, <span class="kw">aes</span>(<span class="dt">x =</span> comp_dif, <span class="dt">y =</span> site)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>metric, <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.3</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Trend (°C/dec)"</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,
       <span class="dt">colour =</span> <span class="st">"Sig. dif.</span><span class="ch">\n</span><span class="st">out of 100"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="trend_files/figure-html/clim-tukey-line-1.png" alt="Segments showing the range of decadal trends added to the data when climatologies were significantly different." width="768"><p class="caption">
Segments showing the range of decadal trends added to the data when climatologies were significantly different.
</p>
</div>
<p>In the figure above we see that the <code>WA</code> seasonal signals become significantly different at a decadal trend of 0.25°C/dec, and the 90th percentile threshold becomes sig. dif. at 0.24°C/dec.</p>
</div>
<div id="kolmogorov-smirnov-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#kolmogorov-smirnov-tests" class="anchor"></a>Kolmogorov-Smirnov tests</h3>
<p>Now knowing that the daily values that make up the climatologies tend to differ based on the decadal trend added, as seen with the ANOVA and Tukey results, we want to check where the distributions of the climatologies themselves begin to differ. We will do this through a series of pair-wise two-sample KS tests.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract the true climatologies</span>
sst_ALL_trend_clim_only_<span class="dv">0</span> &lt;-<span class="st"> </span>sst_ALL_trend_clim_only <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(trend <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)

<span class="co"># KS function</span>
<span class="co"># Takes one rep of trending data and compares it against the complete signal</span>
clim_KS_p &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  df_comp &lt;-<span class="st"> </span>sst_ALL_trend_clim_only_<span class="dv">0</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(site <span class="op">==</span><span class="st"> </span>df<span class="op">$</span>site[<span class="dv">1</span>])
  res &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">site =</span> df<span class="op">$</span>site[<span class="dv">1</span>],
                    <span class="dt">seas =</span> <span class="kw">round</span>(<span class="kw">ks.test</span>(df<span class="op">$</span>seas, df_comp<span class="op">$</span>seas)<span class="op">$</span>p.value, <span class="dv">4</span>),
                    <span class="dt">thresh =</span> <span class="kw">round</span>(<span class="kw">ks.test</span>(df<span class="op">$</span>thresh, df_comp<span class="op">$</span>thresh)<span class="op">$</span>p.value, <span class="dv">4</span>))
  <span class="kw">return</span>(res)
}

<span class="co"># The KS results</span>
<span class="kw">suppressWarnings</span>( <span class="co"># Suppress perfect match warnings</span>
sst_ALL_trend_clim_KS_p &lt;-<span class="st"> </span>sst_ALL_trend_clim_only <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(trend <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">trend =</span> <span class="kw">as.factor</span>(trend)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">site2 =</span> site) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site2, trend) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, clim_KS_p)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site, trend, seas, thresh) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> metric, <span class="dt">value =</span> p.value, <span class="op">-</span>site, <span class="op">-</span><span class="st"> </span>trend)
)
<span class="kw">save</span>(sst_ALL_trend_clim_KS_p, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend_clim_KS_p.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_clim_KS_p.Rdata"</span>)

<span class="co"># Filter non-significant results</span>
KS_sig &lt;-<span class="st"> </span>sst_ALL_trend_clim_KS_p <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(p.value <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, trend, metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ungroup</span>()

<span class="co"># Manually pad in NA for trending percentages with no significant differences</span>
<span class="co"># KS_sig &lt;- rbind(KS_sig, data.frame(site = "Med", metric = "thresh", perc = 100:74, count = NA))</span>
<span class="co"># KS_sig &lt;- rbind(KS_sig, data.frame(site = "NW_Atl", metric = "thresh", perc = 100:79, count = NA))</span>
<span class="co"># KS_sig &lt;- rbind(KS_sig, data.frame(site = "WA", metric = "thresh", perc = 100:92, count = NA))</span>

<span class="kw">ggplot</span>(KS_sig, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(trend), <span class="dt">y =</span> site)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> site)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>metric, <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="co"># scale_x_reverse(breaks = seq(5, 35, 5)) +</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Added decadal trend (°C)"</span>, <span class="dt">y =</span> <span class="ot">NULL</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="trend_files/figure-html/KS-clims-1.png" alt="Dot and line plot showing the _p_-value results from KS tests comparing the climatology statistics for increasingly large decadal trends against the de-trended climatologies for each of the three reference time series." width="768"><p class="caption">
Dot and line plot showing the <em>p</em>-value results from KS tests comparing the climatology statistics for increasingly large decadal trends against the de-trended climatologies for each of the three reference time series.
</p>
</div>
<p>Surprisingly the above figure shows that the seasonal signal is much more sensitive than the 90th percentile threshold to the addition of decadal trends. The <code>WA</code> time series remains the most sensitive with sig. dif. occurring at an added decadal trend of 0.05°C. The interesting thing here is that the <code>NW_Atl</code> threshold never had a significantly different distribution regardless of the amount added.</p>
<p>Thinking about this more I have alighted upon the idea that because the threshold is determined by the largest values detected on any given <em>calendar day</em>, the size of the deadal trend present in the data could be deminished by the fact that some of the values creating the threshold will be from the earlier portion of the time series before the decadal trend realy starts having an effect.</p>
</div>
</div>
<div id="mhw-metrics" class="section level2">
<h2 class="hasAnchor">
<a href="#mhw-metrics" class="anchor"></a>MHW metrics</h2>
<div id="anova" class="section level3">
<h3 class="hasAnchor">
<a href="#anova" class="anchor"></a>ANOVA</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Quick wrapper for getting results for ANOVA and Tukey on event metrics</span>
<span class="co"># df &lt;- sst_ALL_trend_clim_event_cat %&gt;%</span>
<span class="co">#   filter(site == "WA") %&gt;%</span>
<span class="co">#   select(-site)</span>
event_aov_tukey &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>cats) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">unnest</span>(events) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(<span class="kw">row_number</span>() <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">unnest</span>(events) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># select(trend) %&gt;% </span>
<span class="st">    </span><span class="co"># filter(trend != "0.00") %&gt;% </span>
<span class="st">    </span><span class="kw">select</span>(trend, duration, intensity_mean, intensity_max, intensity_cumulative) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">trend =</span> <span class="kw">as.factor</span>(trend)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">aov =</span> <span class="kw">map</span>(data, aov_p),
           <span class="dt">tukey =</span> <span class="kw">map</span>(data, aov_tukey)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>data)
  <span class="kw">return</span>(res)
}

<span class="co"># This file is not uploaded to GitHub as it is too large</span>
<span class="co"># One must first run the above code locally to generate and save the file</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_clim_event_cat.Rdata"</span>)
doMC<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/doMC/topics/registerDoMC">registerDoMC</a></span>(<span class="dt">cores =</span> <span class="dv">50</span>)
sst_ALL_trend_event_aov_tukey &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/ddply">ddply</a></span>(sst_ALL_trend_clim_event_cat, <span class="kw">c</span>(<span class="st">"site"</span>), 
                                             event_aov_tukey, <span class="dt">.parallel =</span> T)
<span class="kw">save</span>(sst_ALL_trend_event_aov_tukey, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend_event_aov_tukey.Rdata"</span>)
<span class="co"># rm(sst_ALL_smooth, sst_ALL_smooth_aov_tukey)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_event_aov_tukey.Rdata"</span>)

<span class="co"># ANOVA p</span>
sst_ALL_trend_event_aov_p &lt;-<span class="st"> </span>sst_ALL_trend_event_aov_tukey <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>tukey) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()

event_aov_plot &lt;-<span class="st"> </span>sst_ALL_trend_event_aov_p <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(p.value <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>())

<span class="co"># visualise</span>
<span class="co"># ggplot(event_aov_plot, aes(x = site, y = metric)) +</span>
<span class="co">#   geom_tile(aes(fill = count)) +</span>
<span class="co">#   geom_text(aes(label = count)) +</span>
<span class="co">#   scale_fill_viridis_c() +</span>
<span class="co">#   theme(axis.text.y = element_text(angle = 90, hjust = 0.5))</span></code></pre></div>
<p>There is no figure here because there is nothing to show. None of the metrics for any of the time series were significantly different.</p>
</div>
<div id="post-hoc-tukey-test-1" class="section level3">
<h3 class="hasAnchor">
<a href="#post-hoc-tukey-test-1" class="anchor"></a>Post-hoc Tukey test</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_ALL_trend_event_tukey &lt;-<span class="st"> </span>sst_ALL_trend_event_aov_tukey <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>aov) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="co"># Create a summary for better plotting</span>
event_tukey_summary &lt;-<span class="st"> </span>sst_ALL_trend_event_tukey <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">separate</span>(comparison, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">"comp_left"</span>, <span class="st">"comp_right"</span>), <span class="dt">sep =</span> <span class="st">"-"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">comp_left =</span> <span class="kw">as.numeric</span>(comp_left),
         <span class="dt">comp_right =</span> <span class="kw">as.numeric</span>(comp_right)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(comp_left <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>comp_right <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">comp_dif =</span> <span class="kw">abs</span>(<span class="kw">round</span>(comp_right <span class="op">-</span><span class="st"> </span>comp_left, <span class="dv">2</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(adj.p.value <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, metric, comp_dif)

<span class="co"># ggplot(event_tukey_summary, aes(x = comp_dif, y = site)) +</span>
<span class="co">#   geom_line(aes(colour = count)) +</span>
<span class="co">#   geom_point(aes(colour = count), size = 0.5) +</span>
<span class="co">#   facet_wrap(~metric, ncol = 1) +</span>
<span class="co">#   scale_colour_viridis_c() +</span>
<span class="co">#   # scale_x_reverse(breaks = seq(5, 35, 5)) +</span>
<span class="co">#   labs(x = "trending data (%)", y = NULL,</span>
<span class="co">#        colour = "Sig. dif.\nout of 100")</span></code></pre></div>
<p>Nope, no differences on a pair-wise basis. How could there be when the ANOVAs weren’t significant.</p>
</div>
<div id="confidence-intervals" class="section level3">
<h3 class="hasAnchor">
<a href="#confidence-intervals" class="anchor"></a>Confidence intervals</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate CIs using a bootstrapping technique to deal with the non-normal small sample sizes</span>

<span class="co"># df &lt;- sst_ALL_both_event %&gt;%</span>
<span class="co">#   filter(lubridate::year(date_peak) &gt;= 2012,</span>
<span class="co">#          site == "WA",</span>
<span class="co">#          trend == "detrended") %&gt;%</span>
<span class="co">#   select(year_index, duration, intensity_mean, intensity_max, intensity_cumulative) #%&gt;%</span>
  <span class="co"># select(site, trend, year_index, duration, intensity_mean, intensity_max, intensity_cumulative) #%&gt;%   </span>
  <span class="co"># nest(-site, -trend)</span>
Bmean &lt;-<span class="st"> </span><span class="cf">function</span>(data, indices) {
  d &lt;-<span class="st"> </span>data[indices] <span class="co"># allows boot to select sample </span>
    <span class="kw">return</span>(<span class="kw">mean</span>(d))
} 

event_CI &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  df_conf &lt;-<span class="st"> </span><span class="kw">gather</span>(df, <span class="dt">key =</span> <span class="st">"metric"</span>, <span class="dt">value =</span> <span class="st">"value"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(metric) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># ggplot(aes(x = value)) +</span>
<span class="st">    </span><span class="co"># geom_histogram(aes(fill = metric)) +</span>
<span class="st">    </span><span class="co"># facet_wrap(~metric, scales = "free_x")</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">lower =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/boot/topics/boot.ci">boot.ci</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/boot/topics/boot">boot</a></span>(<span class="dt">data=</span>value, <span class="dt">statistic=</span>Bmean, <span class="dt">R=</span><span class="dv">1000</span>), <span class="dt">type =</span> <span class="st">"basic"</span>)<span class="op">$</span>basic[<span class="dv">4</span>],
              <span class="dt">mid =</span> <span class="kw">mean</span>(value),
              <span class="dt">upper =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/boot/topics/boot.ci">boot.ci</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/boot/topics/boot">boot</a></span>(<span class="dt">data=</span>value, <span class="dt">statistic=</span>Bmean, <span class="dt">R=</span><span class="dv">1000</span>), <span class="dt">type =</span> <span class="st">"basic"</span>)<span class="op">$</span>basic[<span class="dv">5</span>],
              <span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate_if</span>(is.numeric, round, <span class="dv">4</span>)
  <span class="kw">return</span>(df_conf)
}

sst_ALL_trend_event_CI &lt;-<span class="st"> </span>sst_ALL_trend_clim_event_cat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>cats) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(events) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">row_number</span>() <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(events) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site, trend, duration, intensity_mean, intensity_max, intensity_cumulative) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site, <span class="op">-</span>trend) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_CI)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="kw">save</span>(sst_ALL_trend_event_CI, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend_event_CI.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_event_CI.Rdata"</span>)

<span class="kw">ggplot</span>(sst_ALL_trend_event_CI, <span class="kw">aes</span>(<span class="dt">x =</span> trend)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="dt">width =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="fl">0.8</span>,
                <span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper)) <span class="op">+</span>
<span class="st">  </span><span class="co"># geom_text(aes(label = n, y = upper*1.3, colour = trend), size = 3) +</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mid), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(metric<span class="op">~</span>site, <span class="dt">scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Trend (°C)"</span>, <span class="dt">y =</span> <span class="ot">NULL</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="trend_files/figure-html/event-CI-plot1-1.png" alt="Confidence intervals of the MHW metrics when increasing decadal trends were added." width="768"><p class="caption">
Confidence intervals of the MHW metrics when increasing decadal trends were added.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># CI_plot_1</span></code></pre></div>
<p>Because this set of data is smaller than the previous two vignettes I have used basic bootstrapping to create the CIs above. From these we see that the duration and int. cum. of all of the time series tend to increase as the decadal trend increase, but this is never significant. The patterns for mean and max int. are different for each time series. The <code>Med</code> remains relatively flat regardless of decadal trend, <code>WA</code> increases, and <code>NW_Atl</code> decreases. This is likely due to the distribution of MHWs throughout the time series.</p>
</div>
</div>
<div id="categories" class="section level2">
<h2 class="hasAnchor">
<a href="#categories" class="anchor"></a>Categories</h2>
<div id="chi-squared" class="section level3">
<h3 class="hasAnchor">
<a href="#chi-squared" class="anchor"></a><em>chi</em>-squared</h3>
<p>In order to detemine if the count of MHWs, both total and individual categories, differs based on the decadal trends present in the data, we will be performing a series of <em>chi</em>-squared tests for each site.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Simple wrapper for nesting</span>
<span class="co"># df &lt;- sst_ALL_trend_cat_all %&gt;% </span>
<span class="co">#   filter(site == "WA")</span>
chi_p &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span><span class="kw">chisq.test</span>(<span class="kw">table</span>(df<span class="op">$</span>trend, df<span class="op">$</span>category), <span class="dt">correct =</span> <span class="ot">FALSE</span>)
  res_tidy &lt;-<span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a></span>(res)
  <span class="kw">return</span>(res_tidy<span class="op">$</span>p.value)
}

<span class="co"># Load and extract category data</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_clim_event_cat.Rdata"</span>)
<span class="kw">suppressWarnings</span>( <span class="co"># Suppress warning about category levels not all being present</span>
sst_ALL_trend_cat &lt;-<span class="st"> </span>sst_ALL_trend_clim_event_cat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>events) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>()
)

<span class="co"># Get data into the expected format</span>
sst_ALL_trend_cat_total &lt;-<span class="st"> </span>sst_ALL_trend_cat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(trend, site, category) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">category =</span> <span class="st">"total"</span>)

sst_ALL_trend_cat_all &lt;-<span class="st"> </span>sst_ALL_trend_cat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(trend, site, category) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rbind</span>(sst_ALL_trend_cat_total)

<span class="co"># Calculate chi-squared p-value </span>
sst_ALL_trend_cat_chi &lt;-<span class="st"> </span>sst_ALL_trend_cat_all <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">p.value =</span> <span class="kw">map</span>(data, chi_p)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="kw">save</span>(sst_ALL_trend_cat_chi, <span class="dt">file =</span> <span class="st">"data/sst_ALL_trend_cat_chi.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">"data/sst_ALL_trend_cat_chi.Rdata"</span>)

knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(sst_ALL_trend_cat_chi, <span class="dt">caption =</span> <span class="st">"Table showing the significant difference (_p_-value) for the count of different categories of events for each site based on the trends introduced into the data. No differences were found."</span>)</code></pre></div>
<table class="table">
<caption>Table showing the significant difference (<em>p</em>-value) for the count of different categories of events for each site based on the trends introduced into the data. No differences were found.</caption>
<thead><tr class="header">
<th align="left">site</th>
<th align="right">p.value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Med</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">NW_Atl</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">WA</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#trending">Trending</a></li>
      <li><a href="#climatology-statistics">Climatology statistics</a></li>
      <li><a href="#mhw-metrics">MHW metrics</a></li>
      <li><a href="#categories">Categories</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert W. Schlegel, Eric C. J. Oliver, Alistair J. Hobday, Albertus J. Smit.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
