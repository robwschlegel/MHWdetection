<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assessing the effects of time series duration • MHWdetection</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Assessing the effects of time series duration">
<meta property="og:description" content="This vignette investigates the effects of time series duration on the accurate detection of MHWs.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MHWdetection</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/r_vs_python.html">Python vs. R - default outputs</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_arguments.html">Python vs. R - default arguments</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_additional.html">Python vs. R - additional functions</a>
    </li>
    <li>
      <a href="../articles/Short_climatologies.html">Short climatologies</a>
    </li>
    <li>
      <a href="../articles/Climatologies_and_baselines.html">Alternative climatologies and baselines</a>
    </li>
    <li>
      <a href="../articles/time_series_duration.html">Effects of short time series</a>
    </li>
    <li>
      <a href="../articles/missing_data.html">Effects of missing data</a>
    </li>
    <li>
      <a href="../articles/gridded_products.html">Difference between gridded products</a>
    </li>
    <li>
      <a href="../articles/best_practices.html">Best practices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/robwschlegel/MHWdetection">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Assessing the effects of time series duration</h1>
                        <h4 class="author">Robert W Schlegel</h4>
            
            <h4 class="date">2019-01-23</h4>
      
      
      <div class="hidden name"><code>time_series_duration.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>It has been shown that the length (duration) of a time series may be one of the most important factors in determining the usefulness of those data for any number of applications <span class="citation">(Schlegel and Smit 2016)</span>. For the detection of MHWs it is recommended that one has at least 30 years of data in order to accurately detect the events therein. This is no longer an issue for most ocean surfaces because many high quality SST products, such as NOAA OISST, are now in exceedence of the 30-year minimum. However, besides issues relating to the coarseness of these older products, there are many other reasons why one would want to detect MHWs in products with shorter records. <em>In situ</em> measurements along the coast are one good example of this, another being the use of the newer higher resolution SST products, a third being the use of reanalysis/model products for the detection of events in 3D. It is therefore necessary to quantify the effects that shorter time series duration (&lt; 30 years) has on the accurate detection of events. Once any discrepancies have been accounted for, best practices must be developed to allow users to improve the precision of the detection of events in their shorter time series.</p>
</div>
<div id="time-series-shortening" class="section level2">
<h2 class="hasAnchor">
<a href="#time-series-shortening" class="anchor"></a>Time series shortening</h2>
<p>A time series derives it’s usefulness from it’s length. This is generally because the greater the number of observations (larger sample size), the more confident one can be about the resultant statistics. This is particularly true for decadal scale measurements and is why the WMO recommends a minimum of 30 years of data before drawing any conclusions about decadal (long-term) trends observed in a time series. We however want to look not at decadal scale trends, but rather at how observed MHWs compare against one another when they have been detected using longer or shorter time series. In order to to quantify this effect we will use the minimum and maximum range of time series available to us. The maximum length will be 33 years, as this is the full extent of the NOAA OISST data included in <strong><code>heatwaveR</code></strong>. The minimum length will be 3 years, as it is not possible to calculate the climatology statistics with fewer years than this. Any time series under 5 – 10 years in length will almost certainly create wildly inaccurate results, so we use these short time series more as a proof against their usability, rather than to show that they may be a viable option.</p>
<p>Before we can discuss shortening techniques, we must first consider the inherent decadal trend in the time series themselves. This is usually the primary driver for much of the event detection changes over time <span class="citation">(Oliver et al. 2018)</span>. Therefore, if we truly want to understand the effect that a shortened time series may have on event detection, apart from the effect of the decadal trend, we must de-trend the time series first. It is however worthwhile to compare results from the different time series lengths with and without the long-term trends removed. To this end there is an entire separate <a href="https://robwschlegel.github.io/MHWdetection/articles/trend.html">vignette</a> that quantifies the effect of long-term trends on the detection of events.</p>
<p>The time series shortening technique proposed here is <a href="https://robwschlegel.github.io/MHWdetection/articles/Short_climatologies.html">re-sampling</a>. This methodology takes the full 33 year de-trended time series and randomly samples <em>n</em> years from it to simulate a 3 – 33 year long time series. One then uses the jumbled up, randomly selected years of data to create the seasonal signal and 90th percentile threshold (hereafter referred to as “the climatologies”). The real temperature data, in the correct annual order, are still used against the re-sample created climatologies. Re-sampling the time series in this way is useful because it allows us to replicate random climatology creation 100 (or more) times for each time series length in order to produce a more confident estimation of how likely climatologies generated from certain time series lengths are to impact the accuracy of event detection.</p>
<p>The WMO recommends that the period used to create a climatology be 30 years in length, starting on the first year of a decade (e.g. 1981), however; because we are going to be running these analyses on time series of many different lengths, it will be more consistent to use all of the years present in each as the climatology period. For example, if a time series spans 1983 – 2014, that will be the period used for calculating the climatologies. Likewise, should the time series only span the years 2006 – 2014, that will be the period used.</p>
</div>
<div id="re-sampling" class="section level2">
<h2 class="hasAnchor">
<a href="#re-sampling" class="anchor"></a>Re-sampling</h2>
<p>In this section we will compare the detection of events when we shorten them using <a href="https://robwschlegel.github.io/MHWdetection/articles/Short_climatologies.html">re-sampling</a> to simulate 100 time series at each length of 3 – 33 year. This is presently being done with the three pre-packaged time series available in the <strong><code>heatwaveR</code></strong> package and the python distribution, but eventually will be run on the global data.</p>
<p>The effect this has on the climatologies will be quantified through the following statistics:</p>
<ul>
<li>for each day-of-year (doy) in the climatology, the SD of the climatological means of the 100 re-samplings;</li>
<li>for each doy, the RMSE of the re-sampled means relative to the true climatology (i.e. the one produced from the 33-year long time series);</li>
<li>An ANOVA will compare the climatologies created from different lengths;</li>
<li>A post-hoc Tukey test to determine where the difference in time series length for climatology creation become significant;</li>
<li>Pairwise Kolmogorov-Smirnoff tests will be used to determine if the distributions of the climatologies differ</li>
</ul>
<p>The effect this has on the MHW metrics will be quantified with the following statistics:</p>
<ul>
<li>SD of the MHW metrics from each 100 re-samplings per time series length;</li>
<li>ANOVA comparing the primary metrics for MHWs detected using different time series lengths;</li>
<li>A post-hoc Tukey test to show where the difference in time series length for event detection become significant;</li>
<li>Confidence intervals (CIs) for the measured metrics</li>
</ul>
<p>In addition to checking all of the statistics mentioned above, it is also necessary to record what the overall relationship is with the reduction of time series length and the resultant climatologies/metrics. This will form part of the best practice advice later.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(broom)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(heatwaveR)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lubridate) <span class="co"># This is intentionally activated after data.table</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(fasttime)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggpubr)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(boot)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(FNN)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mgcv)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(doMC); doMC<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/doMC/topics/registerDoMC">registerDoMC</a></span>(<span class="dt">cores =</span> <span class="dv">3</span>)</a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Remove the trend from a time series</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">detrend &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  resids &lt;-<span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/broom/topics/reexports">augment</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lm">lm</a></span>(temp <span class="op">~</span><span class="st"> </span>t, df))</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">temp =</span> temp <span class="op">-</span><span class="st"> </span>resids<span class="op">$</span>.fitted)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co"># ggplot(sst_ALL_detrend, aes(x = t, y = temp)) +</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co">#   geom_point() +</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">#   geom_smooth(method = "lm") +</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co">#   facet_wrap(~site, nrow = 3)</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co"># A clomp of functions used below</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co"># Written out here for tidiness/convenience</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co"># Calculate only events</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">detect_event_event &lt;-<span class="st"> </span><span class="cf">function</span>(df, <span class="dt">y =</span> temp){</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">  ts_y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/eval">eval</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">substitute</a></span>(y), df)</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">  df<span class="op">$</span>temp &lt;-<span class="st"> </span>ts_y</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">  res &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event</a></span>(df)<span class="op">$</span>event</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">  }</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co"># Run an ANOVA on each metric of the combined event results and get the p-value</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">event_aov_p &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">  aov_models &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">grep</a></span>(<span class="st">"year_index"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(df))] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/aov">aov</a></span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>year_index)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"><span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/broom/topics/reexports">tidy</a></span>(.), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">p.value =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(p.value, <span class="dv">4</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(term <span class="op">!=</span><span class="st"> "Residuals"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="st">    </span><span class="kw">select</span>(metric, p.value)</a>
<a class="sourceLine" id="cb2-32" data-line-number="32">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(aov_models)</a>
<a class="sourceLine" id="cb2-33" data-line-number="33">  }</a>
<a class="sourceLine" id="cb2-34" data-line-number="34"></a>
<a class="sourceLine" id="cb2-35" data-line-number="35"><span class="co"># Run an ANOVA on each metric and then a Tukey test</span></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">event_aov_tukey &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb2-37" data-line-number="37">  aov_tukey &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">grep</a></span>(<span class="st">"year_index"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(df))] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38"><span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/TukeyHSD">TukeyHSD</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/aov">aov</a></span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>year_index))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-39" data-line-number="39"><span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/broom/topics/reexports">tidy</a></span>(.), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">p.value =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(adj.p.value, <span class="dv">4</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41"><span class="st">    </span><span class="co"># filter(term != "Residuals") %&gt;%</span></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"><span class="st">    </span><span class="kw">select</span>(metric, comparison, adj.p.value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43"><span class="st">    </span><span class="co"># filter(adj.p.value &lt;= 0.05) %&gt;% </span></a>
<a class="sourceLine" id="cb2-44" data-line-number="44"><span class="st">    </span><span class="kw">arrange</span>(metric, adj.p.value)</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(aov_tukey)</a>
<a class="sourceLine" id="cb2-46" data-line-number="46">  }</a>
<a class="sourceLine" id="cb2-47" data-line-number="47"></a>
<a class="sourceLine" id="cb2-48" data-line-number="48"><span class="co"># Calculate CIs using a bootstrapping technique to deal with the non-normal small sample sizes</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49"></a>
<a class="sourceLine" id="cb2-50" data-line-number="50"><span class="co"># df &lt;- sst_ALL_both_event %&gt;%</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51"><span class="co">#   filter(lubridate::year(date_peak) &gt;= 2012,</span></a>
<a class="sourceLine" id="cb2-52" data-line-number="52"><span class="co">#          site == "WA",</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53"><span class="co">#          trend == "detrended") %&gt;%</span></a>
<a class="sourceLine" id="cb2-54" data-line-number="54"><span class="co">#   select(year_index, duration, intensity_mean, intensity_max, intensity_cumulative) #%&gt;%</span></a>
<a class="sourceLine" id="cb2-55" data-line-number="55">  <span class="co"># select(site, trend, year_index, duration, intensity_mean, intensity_max, intensity_cumulative) #%&gt;%   </span></a>
<a class="sourceLine" id="cb2-56" data-line-number="56">  <span class="co"># nest(-site, -trend)</span></a>
<a class="sourceLine" id="cb2-57" data-line-number="57"></a>
<a class="sourceLine" id="cb2-58" data-line-number="58">Bmean &lt;-<span class="st"> </span><span class="cf">function</span>(data, indices) {</a>
<a class="sourceLine" id="cb2-59" data-line-number="59">  d &lt;-<span class="st"> </span>data[indices] <span class="co"># allows boot to select sample </span></a>
<a class="sourceLine" id="cb2-60" data-line-number="60">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(d))</a>
<a class="sourceLine" id="cb2-61" data-line-number="61">} </a>
<a class="sourceLine" id="cb2-62" data-line-number="62"></a>
<a class="sourceLine" id="cb2-63" data-line-number="63">event_aov_CI &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb2-64" data-line-number="64">  df_conf &lt;-<span class="st"> </span><span class="kw">gather</span>(df, <span class="dt">key =</span> <span class="st">"metric"</span>, <span class="dt">value =</span> <span class="st">"value"</span>, <span class="op">-</span>year_index) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-65" data-line-number="65"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(year_index, metric) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-66" data-line-number="66"><span class="st">    </span><span class="co"># ggplot(aes(x = value)) +</span></a>
<a class="sourceLine" id="cb2-67" data-line-number="67"><span class="st">    </span><span class="co"># geom_histogram(aes(fill = metric)) +</span></a>
<a class="sourceLine" id="cb2-68" data-line-number="68"><span class="st">    </span><span class="co"># facet_wrap(~metric, scales = "free_x")</span></a>
<a class="sourceLine" id="cb2-69" data-line-number="69"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/boot/topics/boot.ci">boot.ci</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/boot/topics/boot">boot</a></span>(<span class="dt">data=</span>value, <span class="dt">statistic=</span>Bmean, <span class="dt">R=</span><span class="dv">1000</span>), <span class="dt">type =</span> <span class="st">"basic"</span>)<span class="op">$</span>basic[<span class="dv">4</span>],</a>
<a class="sourceLine" id="cb2-70" data-line-number="70">              <span class="dt">mid =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(value),</a>
<a class="sourceLine" id="cb2-71" data-line-number="71">              <span class="dt">upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/boot/topics/boot.ci">boot.ci</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/boot/topics/boot">boot</a></span>(<span class="dt">data=</span>value, <span class="dt">statistic=</span>Bmean, <span class="dt">R=</span><span class="dv">1000</span>), <span class="dt">type =</span> <span class="st">"basic"</span>)<span class="op">$</span>basic[<span class="dv">5</span>],</a>
<a class="sourceLine" id="cb2-72" data-line-number="72">              <span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-73" data-line-number="73"><span class="st">    </span><span class="kw">mutate_if</span>(is.numeric, round, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb2-74" data-line-number="74">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(df_conf)</a>
<a class="sourceLine" id="cb2-75" data-line-number="75">  }</a>
<a class="sourceLine" id="cb2-76" data-line-number="76"></a>
<a class="sourceLine" id="cb2-77" data-line-number="77"><span class="co"># A particular summary output</span></a>
<a class="sourceLine" id="cb2-78" data-line-number="78">event_output &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb2-79" data-line-number="79">  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-80" data-line-number="80"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(year_index) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-81" data-line-number="81"><span class="st">    </span><span class="co"># select(-event_no) %&gt;% </span></a>
<a class="sourceLine" id="cb2-82" data-line-number="82"><span class="st">    </span><span class="kw">summarise_all</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mean"</span>, <span class="st">"sd"</span>))</a>
<a class="sourceLine" id="cb2-83" data-line-number="83">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb2-84" data-line-number="84">}</a>
<a class="sourceLine" id="cb2-85" data-line-number="85"></a>
<a class="sourceLine" id="cb2-86" data-line-number="86"><span class="co"># Quick wrapper for getting results for ANOVA on clims</span></a>
<a class="sourceLine" id="cb2-87" data-line-number="87">clim_aov &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb2-88" data-line-number="88">  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-89" data-line-number="89"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>t, <span class="op">-</span><span class="st"> </span>temp, <span class="op">-</span>doy) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-90" data-line-number="90"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">year_index =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(year_index)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-91" data-line-number="91"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-92" data-line-number="92"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, trend) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-93" data-line-number="93"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-94" data-line-number="94"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_p)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-95" data-line-number="95"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-96" data-line-number="96"><span class="st">    </span><span class="kw">unnest</span>()</a>
<a class="sourceLine" id="cb2-97" data-line-number="97">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb2-98" data-line-number="98">}</a>
<a class="sourceLine" id="cb2-99" data-line-number="99"></a>
<a class="sourceLine" id="cb2-100" data-line-number="100"><span class="co"># Quick wrapper for getting results for Tukey on clims</span></a>
<a class="sourceLine" id="cb2-101" data-line-number="101">clim_tukey &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb2-102" data-line-number="102">  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-103" data-line-number="103"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>t, <span class="op">-</span><span class="st"> </span>temp, <span class="op">-</span>doy) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-104" data-line-number="104"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">year_index =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(year_index)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-105" data-line-number="105"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-106" data-line-number="106"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, trend) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-107" data-line-number="107"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-108" data-line-number="108"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_tukey)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-109" data-line-number="109"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-110" data-line-number="110"><span class="st">    </span><span class="kw">unnest</span>()</a>
<a class="sourceLine" id="cb2-111" data-line-number="111">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb2-112" data-line-number="112">}</a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># First put all of the data together and create a site column</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">sst_ALL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(sst_Med, sst_NW_Atl, sst_WA) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">site =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Med"</span>, <span class="st">"NW_Atl"</span>, <span class="st">"WA"</span>), <span class="dt">each =</span> <span class="dv">12053</span>))</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co"># Then create a de-trended version</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">sst_ALL_detrend &lt;-<span class="st"> </span>sst_ALL <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="st">  </span><span class="kw">do</span>(<span class="kw">detrend</span>(.)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="st">  </span><span class="kw">as.tibble</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">doy =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/day.html">yday</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(t))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(site, doy, t, temp)</a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># df &lt;- sst_ALL_repl %&gt;% </span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#   mutate(year_index2 = year_index) %&gt;% </span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#   filter(year_index2 == 2010) %&gt;% </span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#   select(-year_index2)</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">parse_date_sst &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  parsed &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">y =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(t),</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">           <span class="dt">m =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/month.html">month</a></span>(t),</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">           <span class="dt">d =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/day.html">day</a></span>(t)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="st">    </span><span class="co"># group_by(site, rep, doy) %&gt;%</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="st">    </span><span class="co"># summarise(n())</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(year_index), <span class="dv">2014</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">t =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/fasttime/topics/fastPOSIXct">fastPOSIXct</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(y, m, d, <span class="dt">sep =</span> <span class="st">"-"</span>)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>y, <span class="op">-</span>m, <span class="op">-</span>d) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/na.fail">na.omit</a></span>() <span class="co"># because of complications due to leap years</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(parsed)</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">}</a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Calculate one specific clim period</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># df &lt;- sst_ALL_parse %&gt;% </span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#   filter(rep == 1, site == "WA", year_index2 == 2010) %&gt;% </span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="co"># group_by(rep, site, year_index2) %&gt;% </span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="co"># select(-rep, -site, -year_index2, -doy)</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">ts2clm_sub &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  year_start &lt;-<span class="st"> </span>df<span class="op">$</span>year_index[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  res &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(df, <span class="dt">climatologyPeriod =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(year_start,<span class="st">"-01-01"</span>), <span class="st">"2014-12-31"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="st">    </span><span class="co"># filter(lubridate::year(t) &gt;= year_index) %&gt;%</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">year_index =</span> year_start)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co"># </span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co"># # Calculate the full range of clims in a time series</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co"># ts2clm_ALL &lt;- function(df){</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#   seq_year &lt;- seq(min(lubridate::year(df$t)), </span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">#                   max(lubridate::year(df$t))-2)</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="co">#   res &lt;- plyr::ldply(seq_year, .fun = ts2clm_sub, .parallel = T, df = df)</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="co">#   return(res)</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"><span class="co"># }</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co"># df &lt;- sst_ALL_detrend %&gt;% </span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="co">#   filter(site == "Med") #%&gt;% </span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#   # select(-site)</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"></a>
<a class="sourceLine" id="cb5-27" data-line-number="27">sample_all &lt;-<span class="st"> </span><span class="cf">function</span>(n_sample, df){</a>
<a class="sourceLine" id="cb5-28" data-line-number="28">  res &lt;-<span class="st"> </span><span class="kw">sample_n</span>(df, <span class="dt">size =</span> n_sample, <span class="dt">replace =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">year_index =</span> <span class="dv">2014</span><span class="op">-</span>n_sample<span class="op">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-30" data-line-number="30">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb5-31" data-line-number="31">}</a>
<a class="sourceLine" id="cb5-32" data-line-number="32"></a>
<a class="sourceLine" id="cb5-33" data-line-number="33">sst_repl &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</a>
<a class="sourceLine" id="cb5-34" data-line-number="34">  n_range &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">3</span>, <span class="dv">33</span>)</a>
<a class="sourceLine" id="cb5-35" data-line-number="35">  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, doy) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-37" data-line-number="37"><span class="st">    </span><span class="kw">do</span>(plyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/plyr/topics/ldply">ldply</a></span>(n_range, <span class="dt">.fun =</span> sample_all, <span class="dt">.parallel =</span> T, <span class="dt">df =</span> .)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-38" data-line-number="38"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-39" data-line-number="39"><span class="st">    </span><span class="kw">as.tibble</span>(.)</a>
<a class="sourceLine" id="cb5-40" data-line-number="40">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb5-41" data-line-number="41">}</a>
<a class="sourceLine" id="cb5-42" data-line-number="42"></a>
<a class="sourceLine" id="cb5-43" data-line-number="43"><span class="co"># Re-sample the data 100 times</span></a>
<a class="sourceLine" id="cb5-44" data-line-number="44">sst_ALL_repl &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/rerun.html">rerun</a></span>(<span class="dv">100</span>, <span class="kw">sst_repl</span>(sst_ALL_detrend)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-45" data-line-number="45"><span class="st">  </span><span class="kw">map_df</span>(as.data.frame, <span class="dt">.id =</span> <span class="st">"rep"</span>)</a>
<a class="sourceLine" id="cb5-46" data-line-number="46"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(sst_ALL_repl, <span class="dt">file =</span> <span class="st">"data/sst_ALL_repl.Rdata"</span>)</a>
<a class="sourceLine" id="cb5-47" data-line-number="47"></a>
<a class="sourceLine" id="cb5-48" data-line-number="48"><span class="co"># Correct dates for upcoming climatology calculations</span></a>
<a class="sourceLine" id="cb5-49" data-line-number="49">sst_ALL_parse &lt;-<span class="st"> </span>sst_ALL_repl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-50" data-line-number="50"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">year_index2 =</span> year_index) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-51" data-line-number="51"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, rep, doy, year_index2) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-52" data-line-number="52"><span class="st">  </span><span class="kw">parse_date_sst</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-53" data-line-number="53"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-54" data-line-number="54"><span class="st">  </span><span class="co"># select(-year_index2) %&gt;% </span></a>
<a class="sourceLine" id="cb5-55" data-line-number="55"><span class="st">  </span><span class="kw">as.tibble</span>(.)</a>
<a class="sourceLine" id="cb5-56" data-line-number="56"></a>
<a class="sourceLine" id="cb5-57" data-line-number="57"><span class="co"># Calculate climatologies</span></a>
<a class="sourceLine" id="cb5-58" data-line-number="58">sst_ALL_clim &lt;-<span class="st"> </span>sst_ALL_parse <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-59" data-line-number="59"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(rep, site, year_index2) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-60" data-line-number="60"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-61" data-line-number="61"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">clims =</span> <span class="kw">map</span>(data, ts2clm_sub))</a>
<a class="sourceLine" id="cb5-62" data-line-number="62">  <span class="co"># do(ts2clm_sub(df = .))</span></a>
<a class="sourceLine" id="cb5-63" data-line-number="63">  <span class="co"># do(ts2clm_sub(year_index = year_index, df = .))</span></a>
<a class="sourceLine" id="cb5-64" data-line-number="64"></a>
<a class="sourceLine" id="cb5-65" data-line-number="65"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(sst_ALL_smooth, <span class="dt">file =</span> <span class="st">"data/sst_ALL_smooth.Rdata"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># This file is not uploaded to GitHub as it is too large</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># One must first run the above code locally to generate and save the file</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(<span class="st">"data/sst_ALL_smooth.Rdata"</span>)</a></code></pre></div>
<div id="climatology-statistics" class="section level3">
<h3 class="hasAnchor">
<a href="#climatology-statistics" class="anchor"></a>Climatology statistics</h3>
<div id="doy-sd" class="section level4">
<h4 class="hasAnchor">
<a href="#doy-sd" class="anchor"></a>doy SD</h4>
<p>(ECJO)[I have a hard time seeing what the doy std. dev. and RMSE are telling us. Is it information contributing to the question we are asking? I don’t think so….] (RWS)[This was incorporated at the outset of the project, but I’m not certain it is still the focus of the paper. It may get cut when I re-think what is the central question we are trying to answer.]</p>
<p>By looking at how the standard deviaiton (SD) changes over a year, we can see how re-sampling a greater number of times may or may not affect the accuracy of the climatologies created.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># for each day-of-year (doy) in the climatology, calculate the SD of the climatological means of the 100 re-samplings;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">sst_ALL_sd &lt;-<span class="st"> </span>sst_ALL_smooth <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, id, doy) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">seas_sd =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(seas),</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">            <span class="dt">thresh_sd =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(thresh),</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">            <span class="dt">var_sd =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/sd">sd</a></span>(var)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>id, <span class="op">-</span>doy)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="kw">ggplot</span>(sst_ALL_sd, <span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> id)) <span class="op">+</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="st">  </span><span class="kw">facet_grid</span>(variable <span class="op">~</span><span class="st"> </span>site)</a></code></pre></div>
<!-- Hmmm.... Interesting how the seasonal and threshold signals of increased summer variance comes through so nicely in the `Med` data the fewer samples are taken. The other two time series produce somewhat strange signals. We can see that the 30 year, and to a lesser extent 20 year, re-sampled time series are much smoother than the 10 year re-sample. The `WA` data are either very strange, or very exposed to particularly intense events in the middle of summer. -->
</div>
<div id="doy-rmse" class="section level4">
<h4 class="hasAnchor">
<a href="#doy-rmse" class="anchor"></a>doy RMSE</h4>
<p>Calculating the RMSE for each doy will also help us in understanding how the increased sample size will increase the accuracy of the climatologies.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># Base 30 year clims</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">sst_ALL_clim_base &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(decades <span class="op">==</span><span class="st"> "clim_30"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>doy, seas<span class="op">:</span>var, <span class="op">-</span>decades) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>()</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co"># For each doy, calculate the RMSE of the re-sampled means relative to the true climatology (i.e. the one produced from the 30-year long time series);</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">sst_ALL_error &lt;-<span class="st"> </span>sst_ALL_smooth <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>doy, seas<span class="op">:</span>var) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="st">  </span><span class="kw">left_join</span>(sst_ALL_clim_base, <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"site"</span>, <span class="st">"doy"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">seas.er =</span> seas.x <span class="op">-</span><span class="st"> </span>seas.y,</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">         <span class="dt">thresh.er =</span> thresh.x <span class="op">-</span><span class="st"> </span>thresh.y,</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">         <span class="dt">var.er =</span> var.x <span class="op">-</span><span class="st"> </span>var.y)</a>
<a class="sourceLine" id="cb8-15" data-line-number="15"></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">sst_ALL_RMSE &lt;-<span class="st"> </span>sst_ALL_error <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, id, doy) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">seas_RMSE =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(seas.er<span class="op">^</span><span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">            <span class="dt">thresh_RMSE =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(thresh.er<span class="op">^</span><span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb8-20" data-line-number="20">            <span class="dt">var_RMSE =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(var.er<span class="op">^</span><span class="dv">2</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21"><span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>id, <span class="op">-</span>doy)</a>
<a class="sourceLine" id="cb8-22" data-line-number="22"></a>
<a class="sourceLine" id="cb8-23" data-line-number="23"><span class="kw">ggplot</span>(sst_ALL_RMSE, <span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-24" data-line-number="24"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> id)) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25"><span class="st">  </span><span class="kw">facet_grid</span>(variable <span class="op">~</span><span class="st"> </span>site)</a></code></pre></div>
<!-- As with the SD values in the previous figure, we see in the RMSE figure above that 10 years of re-sampling produce noticeably larger errors than the rather similar 20 and 30 year re-samples. That being said, the differences aren't large. -->
</div>
<div id="anova-p-values" class="section level4">
<h4 class="hasAnchor">
<a href="#anova-p-values" class="anchor"></a>ANOVA <em>p</em>-values</h4>
<p>We will now see if the 100 re-sampled climatologies differ significantly.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">sst_ALL_smooth_aov &lt;-<span class="st"> </span>sst_ALL_smooth <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">decades =</span> id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>rep, <span class="op">-</span>t, <span class="op">-</span>temp, <span class="op">-</span>doy) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">decades =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(decades)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_p)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="st">  </span><span class="kw">unnest</span>()</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="kw">ggplot</span>(sst_ALL_smooth_aov, <span class="kw">aes</span>(<span class="dt">x =</span> site, <span class="dt">y =</span> metric)) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> p.value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(p.value, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="dt">midpoint =</span> <span class="fl">0.1</span>)</a></code></pre></div>
<!-- The figure above shows what we have been seeing consistently. The variance values differ significantly, but the climatologies do not.  -->
</div>
<div id="kolmogorov-smirnov-tests" class="section level4">
<h4 class="hasAnchor">
<a href="#kolmogorov-smirnov-tests" class="anchor"></a>Kolmogorov-Smirnov tests</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># Extract climatology values only</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">sst_ALL_both_clim_only &lt;-<span class="st"> </span>sst_ALL_both_clim <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>t, <span class="op">-</span>temp) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(site, trend, year_index, doy)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">KS_sub &lt;-<span class="st"> </span><span class="cf">function</span>(df, year_index_<span class="dv">1</span>, year_index_<span class="dv">2</span>){</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  df_<span class="dv">1</span> &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(year_index <span class="op">==</span><span class="st"> </span>year_index_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  df_<span class="dv">2</span> &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(year_index <span class="op">==</span><span class="st"> </span>year_index_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  res &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">seas =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/ks.test">ks.test</a></span>(df_<span class="dv">1</span><span class="op">$</span>seas, df_<span class="dv">2</span><span class="op">$</span>seas)<span class="op">$</span>p.value, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">                    <span class="dt">thresh =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/ks.test">ks.test</a></span>(df_<span class="dv">1</span><span class="op">$</span>thresh, df_<span class="dv">2</span><span class="op">$</span>thresh)<span class="op">$</span>p.value, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">                    <span class="dt">year_1 =</span> year_index_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">                    <span class="dt">year_2 =</span> year_index_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb10-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb10-18" data-line-number="18"></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="co"># The KS results</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">sst_ALL_both_clim_KS_p &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>()</a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(sst_ALL_both_clim_only<span class="op">$</span>year_index))){</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">  year_index_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(sst_ALL_both_clim_only<span class="op">$</span>year_index)[i]</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(sst_ALL_both_clim_only<span class="op">$</span>year_index))){</a>
<a class="sourceLine" id="cb10-24" data-line-number="24">    year_index_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(sst_ALL_both_clim_only<span class="op">$</span>year_index)[j]</a>
<a class="sourceLine" id="cb10-25" data-line-number="25">    <span class="cf">if</span>(year_index_<span class="dv">1</span> <span class="op">&lt;</span><span class="st"> </span>year_index_<span class="dv">2</span>){</a>
<a class="sourceLine" id="cb10-26" data-line-number="26">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/warning">suppressWarnings</a></span>(</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">      res &lt;-<span class="st"> </span>sst_ALL_both_clim_only <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28"><span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, trend) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29"><span class="st">        </span><span class="kw">do</span>(<span class="kw">KS_sub</span>(., <span class="dt">year_index_1 =</span> year_index_<span class="dv">1</span>, <span class="dt">year_index_2 =</span> year_index_<span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30"><span class="st">        </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31"><span class="st">        </span><span class="kw">as.tibble</span>(.)</a>
<a class="sourceLine" id="cb10-32" data-line-number="32">      )</a>
<a class="sourceLine" id="cb10-33" data-line-number="33">      sst_ALL_both_clim_KS_p &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(sst_ALL_both_clim_KS_p, res)</a>
<a class="sourceLine" id="cb10-34" data-line-number="34">    }</a>
<a class="sourceLine" id="cb10-35" data-line-number="35">  }</a>
<a class="sourceLine" id="cb10-36" data-line-number="36">}</a>
<a class="sourceLine" id="cb10-37" data-line-number="37"></a>
<a class="sourceLine" id="cb10-38" data-line-number="38">sst_ALL_both_clim_KS_p_long &lt;-<span class="st"> </span>sst_ALL_both_clim_KS_p <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-39" data-line-number="39"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key =</span> <span class="st">"metric"</span>, <span class="dt">value =</span> <span class="st">"p.value"</span>, <span class="op">-</span>site, <span class="op">-</span>trend, <span class="op">-</span>year_<span class="dv">1</span>, <span class="op">-</span>year_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-40" data-line-number="40"></a>
<a class="sourceLine" id="cb10-41" data-line-number="41"><span class="kw">ggplot</span>(sst_ALL_both_clim_KS_p_long, <span class="kw">aes</span>(<span class="dt">x =</span> year_<span class="dv">1</span>, <span class="dt">y =</span> year_<span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-42" data-line-number="42"><span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> p.value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-43" data-line-number="43"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(sst_ALL_both_clim_KS_p_long, p.value <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>),</a>
<a class="sourceLine" id="cb10-44" data-line-number="44">             <span class="dt">size =</span> <span class="fl">0.01</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-45" data-line-number="45"><span class="st">  </span><span class="co"># geom_text(aes(label = round(adj.p.value, 2))) +</span></a>
<a class="sourceLine" id="cb10-46" data-line-number="46"><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="dt">midpoint =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-47" data-line-number="47"><span class="st">  </span><span class="kw">coord_equal</span>(<span class="dt">expand =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-48" data-line-number="48"><span class="st">  </span><span class="kw">facet_grid</span>(site<span class="op">~</span>metric<span class="op">+</span>trend) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-49" data-line-number="49"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">""</span>, <span class="dt">y =</span> <span class="st">""</span>)</a></code></pre></div>
<!-- The table above shows that while climatology values only generated from short time series against long time series tend to be significantly different when tested with an ANOVA, Kolmogorov-Smirnov tests on the shape of these distributions say otherwise. For the `WA` time series, nearly any comparison being made will show that the climatology distributions are significantly different. However, we also see different patterns in each of the other two time series. These results do not show one clear pattern and so one is left to wonder how representative these results are. This will require that this analysis be run on a global scale as well. -->
<!-- We may see in the figure above that the distributions of the variance are significantly different from the real (non-re-sampled) distributions regardless of how many re-samples are run. That is somewhat surprising. We also see that 10 and 20 years of re-sampling tend to produce significantly different climatologies, but that at 30 years of re-sampling the results come more in line with reality. The exception here is that the climatologies for Mediterranean seem to happily be able to be reproduced with only 10 years of re-sampling. I think this is because it has a smaller decadal trend than the other two time series as well as less inter-annual variability. But this needs to be more thoroughly quantified. -->
</div>
</div>
<div id="mhw-metrics" class="section level3">
<h3 class="hasAnchor">
<a href="#mhw-metrics" class="anchor"></a>MHW metrics</h3>
<div id="anova-p-values-1" class="section level4">
<h4 class="hasAnchor">
<a href="#anova-p-values-1" class="anchor"></a>ANOVA <em>p</em>-values</h4>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># It is necessary to replace the 'temp' values in the smoothed data with the real values</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">sst_ALL_smooth_real &lt;-<span class="st"> </span>sst_ALL_smooth <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>temp) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="st">  </span><span class="kw">left_join</span>(sst_ALL, <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"site"</span>, <span class="st">"t"</span>))</a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Then caluclate events using the many re-smapled clims on the real temperature data</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">sst_ALL_smooth_event &lt;-<span class="st"> </span>sst_ALL_smooth_real <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, id, rep) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_event)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(res) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(date_start <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, date_end <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(index_start<span class="op">:</span>index_end, date_start<span class="op">:</span>date_end))</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(sst_ALL_smooth_event, <span class="dt">file =</span> <span class="st">"data/sst_ALL_smooth_event.Rdata"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># This file is not uploaded to GitHub as it is too large</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co"># One must first run the above code locally to generate and save the file</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(<span class="st">"data/sst_ALL_smooth_event.Rdata"</span>)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co"># Rename for project-wide consistency</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">sst_ALL_smooth_event &lt;-<span class="st"> </span>sst_ALL_smooth_event <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">decades =</span> id)</a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># ANOVA p</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">sst_ALL_smooth_aov_p &lt;-<span class="st"> </span>sst_ALL_smooth_event <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(site, decades, duration, intensity_mean, intensity_max, intensity_cumulative) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_p)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>() <span class="co">#%&gt;% </span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  <span class="co"># spread(key = metric, value = p.value) %&gt;%</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  <span class="co"># select(names(select(sst_ALL_event, -decades, -event_no)))</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="co"># sst_ALL_smooth_aov_p</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co"># visualise</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="kw">ggplot</span>(sst_ALL_smooth_aov_p, <span class="kw">aes</span>(<span class="dt">x =</span> site, <span class="dt">y =</span> metric)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> p.value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(p.value, <span class="dv">2</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="dt">midpoint =</span> <span class="fl">0.1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="fl">0.5</span>))</a></code></pre></div>
<p>The heatmap above shows the ANOVA results (<em>p</em>-values) when one compares the events detected in the 100 replicated re-samples of 10, 20, or 30 years of data. Meaning that these are very large pools of events being compared against one another.</p>
<p>(RWS: It would be worthwhile to compare the MHW metrics for each individual re-sampled time series against the MHW metrics from the real time series of the same length.)</p>
</div>
<div id="confidence-intervals" class="section level4">
<h4 class="hasAnchor">
<a href="#confidence-intervals" class="anchor"></a>Confidence intervals</h4>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># ANOVA CI</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">sst_ALL_smooth_aov_CI &lt;-<span class="st"> </span>sst_ALL_smooth_event <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(site, decades, duration, intensity_mean, intensity_max, intensity_cumulative) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_CI)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>()</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co"># Plot</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="kw">ggplot</span>(sst_ALL_aov_CI, <span class="kw">aes</span>(<span class="dt">x =</span> site)) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.9</span>), <span class="dt">width =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">"black"</span>,</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">                <span class="kw">aes</span>(<span class="dt">ymin =</span> conf.low, <span class="dt">ymax =</span> conf.high, <span class="dt">linetype =</span> decades)) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="dt">data =</span> sst_ALL_smooth_aov_CI, <span class="dt">show.legend =</span> F,</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">                <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.9</span>), <span class="dt">width =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">"red"</span>,</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">                <span class="kw">aes</span>(<span class="dt">ymin =</span> conf.low, <span class="dt">ymax =</span> conf.high, <span class="dt">linetype =</span> decades)) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>metric, <span class="dt">scales =</span> <span class="st">"free_y"</span>)</a></code></pre></div>
<p>The CI plot above demonstrates that the general increase in MHW metrics in longer time series detected in the first round of experiments (when the real 10, 20, and 30 year baselines were used to generate a single clim each) does not hold up when we re-sample the data 100 times. The centre around which the CI spread shrinks dramatically with re-sampling, but we also see how the three different time periods converge around 0, whereas the samples from the real data show the effect that the long-term trend has in the calculation of the metrics. The reason that we do not see the trend of increasing MHW duration/intensity with the re-sampling is that re-sampling effectively removes the decadal trend from the data. It is for this reason that I recommended at the start of this document that a second type of re-sampling be performed that would better maintain the effect that the decadal trend has on the data.</p>
<p>Note that in an earlier version of this vignette bootstrapping was also tested. It has since been removed as it was shown to not be effective. This was because the bootstrapping of random values to create climatologies created much lower values than the real data because while the bootstrapping does sample the data randomly, it then takes those <em>n</em> random samples and creates one mean value from them. This then makes artificially even values and so when one wants to calculate a 90th percentile threshold from this it is almost identical to the seasonal climatology.</p>
</div>
</div>
</div>
<div id="categories" class="section level2">
<h2 class="hasAnchor">
<a href="#categories" class="anchor"></a>Categories</h2>
<p>In this section we want to look at how the categories in the different time periods compare. I’ll start out with doing basic calculations and comparisons of the categories of events with the different time periods. And then based on how that looks, see if I can think of a way of quantifying the differences.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># Calculate categories from events in one function for nesting</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">detect_event_category &lt;-<span class="st"> </span><span class="cf">function</span>(df, <span class="dt">y =</span> temp){</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  ts_y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/eval">eval</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">substitute</a></span>(y), df)</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">  df<span class="op">$</span>temp &lt;-<span class="st"> </span>ts_y</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">  res &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/category">category</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event</a></span>(df))</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">  res<span class="op">$</span>event_name &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">as.character</a></span>(res<span class="op">$</span>event_name)</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">  }</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># Calculate categories and filter only those from 2002 -- 2011</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">sst_ALL_clim_category &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, decades) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_category)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(res) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(peak_date <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, peak_date <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="co">#%&gt;% </span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9">  <span class="co"># select(-c(index_start:index_end, date_start:date_end))</span></a></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># Indeed... but how to compare qualitative data?</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="co"># Let's start out by counting the occurrence of the categories</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">sst_ALL_clim_category_count &lt;-<span class="st"> </span>sst_ALL_clim_category <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, decades, category) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">category =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(category,</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">                           <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"I Moderate"</span>, <span class="st">"II Strong"</span>,</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">                                      <span class="st">"III Severe"</span>, <span class="st">"IV Extreme"</span>)))</a>
<a class="sourceLine" id="cb18-9" data-line-number="9"></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="kw">ggplot</span>(sst_ALL_clim_category_count, <span class="kw">aes</span>(<span class="dt">x =</span> decades, <span class="dt">y =</span> count, <span class="dt">fill =</span> decades)) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> count, <span class="dt">y =</span> count<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="st">  </span><span class="kw">facet_grid</span>(category<span class="op">~</span>site)</a></code></pre></div>
<p>The results in the figure above are about what I was expecting. We tend to see more larger events when the climatologies are based on 30 years of data, rather than 10.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># Calculate categories and filter only those from 2002 -- 2011</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">sst_ALL_smooth_real_category &lt;-<span class="st"> </span>sst_ALL_smooth_real <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, id, rep) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_category)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(res) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(peak_date <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, peak_date <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="co">#%&gt;% </span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9">  <span class="co"># select(-c(index_start:index_end, date_start:date_end))</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(sst_ALL_smooth_real_category, <span class="dt">file =</span> <span class="st">"data/sst_ALL_smooth_real_category.Rdata"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(<span class="st">"data/sst_ALL_smooth_real_category.Rdata"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="co"># Indeed... but how to compare qualitative data?</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="co"># Let's start out by counting the occurrence of the categories</span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">sst_ALL_smooth_real_category_count &lt;-<span class="st"> </span>sst_ALL_smooth_real_category <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">decades =</span> id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, decades, category) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>()<span class="op">/</span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">category =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(category,</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">                           <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"I Moderate"</span>, <span class="st">"II Strong"</span>,</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">                                      <span class="st">"III Severe"</span>, <span class="st">"IV Extreme"</span>)))</a>
<a class="sourceLine" id="cb21-10" data-line-number="10"></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="kw">ggplot</span>(sst_ALL_smooth_real_category_count, <span class="kw">aes</span>(<span class="dt">x =</span> decades, <span class="dt">y =</span> count, <span class="dt">fill =</span> decades)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(count), <span class="dt">y =</span> count<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-14" data-line-number="14"><span class="st">  </span><span class="kw">facet_grid</span>(category<span class="op">~</span>site)</a></code></pre></div>
<p>When re-sampling we actually see the detection of <em>more</em> larger category events with the 10 year periods than with either 20 or 30, but this is negligible. As noted earlier, this re-sampling removes the decadal trend from the data, which seems to cause the climatologies to become more similar, not less. Remember that the real temperature values are being used to detect these events, not the re-sampled temperature values that were used to calculate the climatologies. This was because the re-sampled temperatures were too jumbled to detect events with reliably.</p>
<div id="comparing-top-events" class="section level3">
<h3 class="hasAnchor">
<a href="#comparing-top-events" class="anchor"></a>Comparing top events</h3>
<p>(AJS: I was thinking about the event categories. What we need to do is detect the top five events using the 30 yr climatology. Then, using the sections of time series that overlap with these events, use reduced time series, make climatologies, and see how those top five events compare in their event metrics to those detected using the shorter climatologies. Then we do the reverse. Detect events in the reduced time series, find the top five, and see what the matching ones in the full time series are like in comparison. So, compare specific events in addition to the way in which you have done it. Then do the same for median-sized events, and the smallest ones. Maybe even those at the 2nd and 5th quantiles.)</p>
<p>(RWS: Parts of this proposed methodology proved to be rather tricky given how the rest of the methodology has been framed thus far so I have not yet made all of the suggestion posed here. I have only compared the top five events, as proposed by AJS above.)</p>
<p>(ECJO)[All of this section is really just pulling out the effect of the long-term trend. It is not quantifying the uncertainty due to a short time series.]</p>
<p>(RWS)[This again is the same problem running throughout. It would perhaps be best just to detrend everything…]</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co"># Calculate all event categories, not just the last ten years as done above</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">sst_ALL_clim_category_ALL &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, decades) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_category)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(res)</a>
<a class="sourceLine" id="cb22-8" data-line-number="8"></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="co"># The top 5 events froom 30 years</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10">sst_ALL_clim_category_<span class="dv">30</span>_top_<span class="dv">5</span> &lt;-<span class="st"> </span>sst_ALL_clim_category_ALL <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(decades <span class="op">==</span><span class="st"> "clim_30"</span>,</a>
<a class="sourceLine" id="cb22-12" data-line-number="12">         peak_date <span class="op">&gt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"1982-01-01"</span>),</a>
<a class="sourceLine" id="cb22-13" data-line-number="13">         peak_date <span class="op">&lt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"2011-12-31"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-15" data-line-number="15"><span class="st">  </span><span class="kw">arrange</span>(<span class="op">-</span>i_max) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-16" data-line-number="16"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb22-17" data-line-number="17"></a>
<a class="sourceLine" id="cb22-18" data-line-number="18"><span class="co"># The top 5 events froom 20 years</span></a>
<a class="sourceLine" id="cb22-19" data-line-number="19">sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span> &lt;-<span class="st"> </span>sst_ALL_clim_category_ALL <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-20" data-line-number="20"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(decades <span class="op">==</span><span class="st"> "clim_20"</span>,</a>
<a class="sourceLine" id="cb22-21" data-line-number="21">         peak_date <span class="op">&gt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"1992-01-01"</span>),</a>
<a class="sourceLine" id="cb22-22" data-line-number="22">         peak_date <span class="op">&lt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"2011-12-31"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-23" data-line-number="23"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-24" data-line-number="24"><span class="st">  </span><span class="kw">arrange</span>(<span class="op">-</span>i_max) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-25" data-line-number="25"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb22-26" data-line-number="26"></a>
<a class="sourceLine" id="cb22-27" data-line-number="27"><span class="co"># The top 5 events froom 10 years</span></a>
<a class="sourceLine" id="cb22-28" data-line-number="28">sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span> &lt;-<span class="st"> </span>sst_ALL_clim_category_ALL <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-29" data-line-number="29"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(decades <span class="op">==</span><span class="st"> "clim_10"</span>,</a>
<a class="sourceLine" id="cb22-30" data-line-number="30">         peak_date <span class="op">&gt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"2002-01-01"</span>),</a>
<a class="sourceLine" id="cb22-31" data-line-number="31">         peak_date <span class="op">&lt;=</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"2011-12-31"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-32" data-line-number="32"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-33" data-line-number="33"><span class="st">  </span><span class="kw">arrange</span>(<span class="op">-</span>i_max) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-34" data-line-number="34"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># RWS: This is a bit of a schlep as it requires a much more nuanced take on how to go about comparing relavent lengths of clim periods. The method used throughout here, that of the most recent 10, 20, or 30 years for the clim period won't work here and I hesitate to create a new methodology this late in the section...</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="co"># RWS: So for now I'm skipping forward to the next step as that will work with the current methodology.</span></a></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="co"># Function for pulling out comparable events based on closest peak dates</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2">peak_date_index &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">  sst_<span class="dv">30</span> &lt;-<span class="st"> </span>sst_ALL_clim_category_ALL <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(decades <span class="op">==</span><span class="st"> "clim_30"</span>)</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">  peak_index &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/FNN/topics/knn.index">knnx.index</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(sst_<span class="dv">30</span><span class="op">$</span>peak_date), </a>
<a class="sourceLine" id="cb24-6" data-line-number="6">                                         <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(df<span class="op">$</span>peak_date), <span class="dt">k =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb24-7" data-line-number="7">  res &lt;-<span class="st"> </span>sst_<span class="dv">30</span>[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(peak_index),]</a>
<a class="sourceLine" id="cb24-8" data-line-number="8">}</a></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co"># Find matching events based on nearest peak_date</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2">sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span>_match &lt;-<span class="st"> </span><span class="kw">peak_date_index</span>(sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span>_match &lt;-<span class="st"> </span><span class="kw">peak_date_index</span>(sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span>)</a></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">sst_ALL_clim_category_top_<span class="dv">5</span>_match &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span>_match, <span class="dt">match =</span> <span class="st">"clim_10"</span>),</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">                                           <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span>_match, <span class="dt">match =</span> <span class="st">"clim_20"</span>),</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">                                           <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(sst_ALL_clim_category_<span class="dv">30</span>_top_<span class="dv">5</span>, <span class="dt">match =</span> <span class="st">"clim_30"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, match, category) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">category =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(category,</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">                           <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"I Moderate"</span>, <span class="st">"II Strong"</span>,</a>
<a class="sourceLine" id="cb26-8" data-line-number="8">                                      <span class="st">"III Severe"</span>, <span class="st">"IV Extreme"</span>)))</a>
<a class="sourceLine" id="cb26-9" data-line-number="9"></a>
<a class="sourceLine" id="cb26-10" data-line-number="10"><span class="kw">ggplot</span>(sst_ALL_clim_category_top_<span class="dv">5</span>_match, <span class="kw">aes</span>(<span class="dt">x =</span> match, <span class="dt">y =</span> count, <span class="dt">fill =</span> match)) <span class="op">+</span></a>
<a class="sourceLine" id="cb26-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb26-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> count, <span class="dt">y =</span> count<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="st">  </span><span class="kw">facet_grid</span>(category<span class="op">~</span>site)</a></code></pre></div>
<p>The bar plots above are perhaps a bit difficult to interpret. What they are showing is the top five events detected in either the real 10, 20, or 30 year time series, but then those events are compared against the same event in the 30 year time series, and it is the category for that same event from the 30 year time series that is shown in the figure. For example, look at the event categories from the 10 year time series for the Northwest Atlantic (<code>NW_Atl</code>). We see that three of these events are ‘I Moderate’, and two are ‘II Strong’. When we look at the events based on 30 years of data we see that all of the top five are ‘II Strong’. This is because the 90th percentile threshold is higher when one uses only 10 years of data, so the events have a lower category. Oddly, this doesn’t hold up in the Mediterranean time series.</p>
<p>With the differences in the count of categories for the detected events in the given time series lengths shown above, we will now compare the categories of the matching events between the different climatologies used.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span>_compare &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span>, <span class="dt">match =</span> <span class="st">"clim_10"</span>),</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">                                           <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span>_match, <span class="dt">match =</span> <span class="st">"clim_30"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, match, category) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">category =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(category,</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">                           <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"I Moderate"</span>, <span class="st">"II Strong"</span>,</a>
<a class="sourceLine" id="cb27-7" data-line-number="7">                                      <span class="st">"III Severe"</span>, <span class="st">"IV Extreme"</span>)))</a>
<a class="sourceLine" id="cb27-8" data-line-number="8"></a>
<a class="sourceLine" id="cb27-9" data-line-number="9"><span class="kw">ggplot</span>(sst_ALL_clim_category_<span class="dv">10</span>_top_<span class="dv">5</span>_compare, <span class="kw">aes</span>(<span class="dt">x =</span> match, <span class="dt">y =</span> count, <span class="dt">fill =</span> match)) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> count, <span class="dt">y =</span> count<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-12" data-line-number="12"><span class="st">  </span><span class="kw">facet_grid</span>(category<span class="op">~</span>site)</a></code></pre></div>
<p>Now we are somewhat doing the opposite of the previous figure. In the figure above we are showing what the categories of the top five events in the 10 year time series really are, compared against what the matching events in the 30 year time series are. We see that the 30 year time series event categories are consistently larger to some degree.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span>_compare &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span>, <span class="dt">match =</span> <span class="st">"clim_20"</span>),</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">                                           <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span>_match, <span class="dt">match =</span> <span class="st">"clim_30"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">group_by</a></span>(site, match, category) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggpubr/topics/reexports">mutate</a></span>(<span class="dt">category =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(category,</a>
<a class="sourceLine" id="cb28-6" data-line-number="6">                           <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"I Moderate"</span>, <span class="st">"II Strong"</span>,</a>
<a class="sourceLine" id="cb28-7" data-line-number="7">                                      <span class="st">"III Severe"</span>, <span class="st">"IV Extreme"</span>)))</a>
<a class="sourceLine" id="cb28-8" data-line-number="8"></a>
<a class="sourceLine" id="cb28-9" data-line-number="9"><span class="kw">ggplot</span>(sst_ALL_clim_category_<span class="dv">20</span>_top_<span class="dv">5</span>_compare, <span class="kw">aes</span>(<span class="dt">x =</span> match, <span class="dt">y =</span> count, <span class="dt">fill =</span> match)) <span class="op">+</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> count, <span class="dt">y =</span> count<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb28-12" data-line-number="12"><span class="st">  </span><span class="kw">facet_grid</span>(category<span class="op">~</span>site)</a></code></pre></div>
<p>The above figure shows a similar pattern to the previous one, except that the discrepancy in category classifications between the top five events from 20 vs 30 year time periods is less than 10 vs 30 years. This is to be expected.</p>
<p>(RWS: As proposed by AJS, were this section of the analysis to be completed, the median and minimum five events should also be compared.)</p>
</div>
</div>
<div id="trend-control" class="section level2">
<h2 class="hasAnchor">
<a href="#trend-control" class="anchor"></a>Trend control</h2>
<p>(RWS)[This section will seek to understand the elationship between long-term trends and the effects they have on MHW results. This will be accomplished by adding known amounts of trends to de-trended time series and quantifying the results.]</p>
<!-- ## Arguments -->
<!-- With the amount of variance etc. that may be accounted for through re-sampling known, we will now look into how one may go about more confidently creating a climatology that will consistently detect events as similarly as possible by experimenting with how the various arguments within the detection pipeline may affect our results, given the different lengths of time series employed. After this has been done we will look into using the Fourier transform climatology generating method (https://robwschlegel.github.io/MHWdetection/articles/Climatologies_and_baselines.html) to see if that can't be more effective. The efficacy of these techniques will be judged through a number of statistical measurements of variance and similarity. -->
<!-- We will see how these different techniques may differ for corrections to both the 10 and 20 year time periods. -->
</div>
<div id="can-we-fix-it" class="section level2">
<h2 class="hasAnchor">
<a href="#can-we-fix-it" class="anchor"></a>Can we fix it?</h2>
<div id="fourier-transform-climatologies" class="section level3">
<h3 class="hasAnchor">
<a href="#fourier-transform-climatologies" class="anchor"></a>Fourier transform climatologies</h3>
<p>Lastly we will now go about reproducing all of the checks made above, but based on a climatology derived from a Fourier transformation, and not the default climatology creation method.</p>
<p>(RWS: I’ve not gotten to the Fourier transformations yet either. I’m also not convinced that this is going to be the way forward. I am thinking that it may be better to just increase the smoothing window width to produce a more sinusoidal climatology line. But I suppose that in order to know that it must be tested.)</p>
<p>(ECJO)[One advantage of the Fourier transform method (or, I think equivalently harmonic regression) is that it is VERY fast. Much faster than the method used in the MHW code. I also think you can probably get away with shorter time series using this method than with the “standard MHW climatology” method]</p>
<p>(RWS)[I suppose then that I will need to look into this.]</p>
</div>
</div>
<div id="best-practices" class="section level2">
<h2 class="hasAnchor">
<a href="#best-practices" class="anchor"></a>Best practices</h2>
<p>(RWS: I envision this last section distilling everything learned above into a nice bullet list. These bulletted items for each different vignette would then all be added up in one central <a href="https://robwschlegel.github.io/MHWdetection/articles/best_practices.html">best practices</a> vignette that would be ported over into the final write-up in the discussion/best-practices section of the paper. Ideally these best-practices could also be incorporated into the R/python distributions of the MHW detection code to allow users to make use of the findings from the paper in their own work.)</p>
<div id="options-for-improving-climatology-precision-in-short-time-series" class="section level3">
<h3 class="hasAnchor">
<a href="#options-for-improving-climatology-precision-in-short-time-series" class="anchor"></a>Options for improving climatology precision in short time series</h3>
</div>
<div id="options-for-improving-mhw-metric-precision-in-short-time-series" class="section level3">
<h3 class="hasAnchor">
<a href="#options-for-improving-mhw-metric-precision-in-short-time-series" class="anchor"></a>Options for improving MHW metric precision in short time series</h3>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Oliver2018">
<p>Oliver, Eric C.J., Markus G. Donat, Michael T. Burrows, Pippa J. Moore, Dan A. Smale, Lisa V. Alexander, Jessica A. Benthuysen, et al. 2018. “Longer and more frequent marine heatwaves over the past century.” <em>Nature Communications</em> 9 (1). <a href="https://doi.org/10.1038/s41467-018-03732-9">https://doi.org/10.1038/s41467-018-03732-9</a>.</p>
</div>
<div id="ref-Schlegel2016">
<p>Schlegel, Robert W., and Albertus J. Smit. 2016. “Climate Change in Coastal Waters: Time Series Properties Affecting Trend Estimation.” <em>Journal of Climate</em> 29 (24): 9113–24. <a href="https://doi.org/10.1175/JCLI-D-16-0014.1">https://doi.org/10.1175/JCLI-D-16-0014.1</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#time-series-shortening">Time series shortening</a></li>
      <li><a href="#re-sampling">Re-sampling</a></li>
      <li><a href="#categories">Categories</a></li>
      <li><a href="#trend-control">Trend control</a></li>
      <li><a href="#can-we-fix-it">Can we fix it?</a></li>
      <li><a href="#best-practices">Best practices</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert W. Schlegel, Eric C. J. Oliver, Alistair J. Hobday, Albertus J. Smit.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
