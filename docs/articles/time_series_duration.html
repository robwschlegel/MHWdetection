<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assessing the effect of time series duration • MHWdetection</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Assessing the effect of time series duration">
<meta property="og:description" content="This vignette goes into depth on the effects of time series duration for the detection of events.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MHWdetection</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/r_vs_python.html">Python vs. R - default outputs</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_arguments.html">Python vs. R - default arguments</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_additional.html">Python vs. R - additional functions</a>
    </li>
    <li>
      <a href="../articles/Short_climatologies.html">Short climatologies</a>
    </li>
    <li>
      <a href="../articles/Climatologies_and_baselines.html">Alternative climatologies and baselines</a>
    </li>
    <li>
      <a href="../articles/time_series_duration.html">Effects of short time series</a>
    </li>
    <li>
      <a href="../articles/random_missing_data.html">Effects of random missing data</a>
    </li>
    <li>
      <a href="../articles/non_random_missing_data.html">Effects of non-random mising data</a>
    </li>
    <li>
      <a href="../articles/gridded_products.html">Difference between gridded products</a>
    </li>
    <li>
      <a href="../articles/best_practices.html">Best practices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/robwschlegel/MHWdetection">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Assessing the effect of time series duration</h1>
                        <h4 class="author">Robert Schlegel</h4>
            
            <h4 class="date">2018-06-08</h4>
      
      
      <div class="hidden name"><code>time_series_duration.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The purpose of this vignette is to lay out, in detail, how one goes about testing a range of variables, and analysing the effects they have on the detection of MHWs. This has a plurality of meanings, which will be discussed at more depth in the following sections.</p>
</div>
<div id="time-series-shortening" class="section level2">
<h2 class="hasAnchor">
<a href="#time-series-shortening" class="anchor"></a>Time series shortening</h2>
<p>Two different shortening methodologies are proposed here. The first would be to simply take the last n years in a given time series (e.g. 30, 20, 10) and then compare the detected events in the overlapping period of time. This method will help to address the question of how may longer time series affect the events detected. This is an important consideration and one that needs to be investigated to ascertain how large the effect actually is. The second technique proposed here is re-sampling (AJS has used 100 re-samples, as seen <a href="https://robwschlegel.github.io/MHWdetection/articles/Short_climatologies.html" class="uri">https://robwschlegel.github.io/MHWdetection/articles/Short_climatologies.html</a>, which can be increased if desired). The issue with re-sampling the time series at the three different lengths is that it will prevent direct comparison of the results. Rather, re-sampling the time series in this way is useful for the comparison of events in the same time series detected with differing climatologies produced via the aforementioned re-sampling technique.</p>
<p>And that is how this vignette will break down. The first very straightforward investigation will simply be to quantify how much the detected events change when historic data is neglected. The second, much longer investigation will then look into best practices on how to consistently detect events when time series are not of optimal length. As part of this the following measurement metrics will be quantified:</p>
<ul>
<li>for each day-of-year (doy) in the climatology, calculate the SD of the climatological means of the 100 re-sampled samples;</li>
<li>for each doy, calculate the RMSE of the re-sampled means relative to the true climatology (i.e. the one produced from the 30-year long time series);</li>
<li>correspondence of detected events when using climatologies calculated from reduced time series vs. when using the full duration time series climatologies.</li>
</ul>
<p>A third possible type of time series shortening to look into would be rather than re-sampling the shorter (e.g. 10 and 20 year) time series, to incrementally calculate climatologies by moving the 10 or 20 year window forward one year at a time. And then quantify how this particular choice of historic data affects event detection.</p>
<p>Finally, this brings us to the direct consideration of the inherent decadal trend in the time series themselves. Ultimately, this tends to come out as the primary driver for much of the event detection changes over time <span class="citation">(Oliver et al. 2018)</span>. First prize for all of this research would be to develop an equation (model) that could look at a time series and determine for the user how best to calculate a climatology. It seems to me that an important ingredient must be the decadal (or annual) trend. So one would then need to take into account everything learned from the methodologies proposed above and investigate what relationship decadal trends have with whatever may be found. It would be somewhat poetic if this could be used as a variable for the better detection of events.</p>
</div>
<div id="simply-shorter" class="section level2">
<h2 class="hasAnchor">
<a href="#simply-shorter" class="anchor"></a>Simply shorter</h2>
<p>In this section we will compare the detection of events when we simply nip off the earlier decades in the three pre-package time series in <strong><code>heatwaveR</code></strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(broom)
<span class="kw">library</span>(heatwaveR)
<span class="kw">library</span>(lubridate) <span class="co"># This is intentionally activated after data.table</span>
<span class="kw">library</span>(fasttime)
<span class="kw">library</span>(ggpubr)
<span class="kw">library</span>(boot)</code></pre></div>
<p>In order to control more tightly for the effect of shorter time series I am going to standardise the length of the 30 year time series as well. Because the built in time series are actually 32 years long I am going to nip off those last two years. The WMO recommends that climatologies be 30 years in length, starting on the first year of a decade (e.g. 1981). Unfortunately the OISST data from which the built-in time series have been drawn only start in 1982. For this reason we will set the 30 year climatology period as being from 1982 – 2011. To match this period, but shorter, 2011 will be taken as the last year for comparison and the data from 2012 onward will not be used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First put all of the data together and create a site column</span>
sst_ALL &lt;-<span class="st"> </span><span class="kw">rbind</span>(sst_Med, sst_NW_Atl, sst_WA) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">site =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">"Med"</span>, <span class="st">"NW_Atl"</span>, <span class="st">"WA"</span>), <span class="dt">each =</span> <span class="dv">12053</span>))

<span class="co"># Then calculate the different clims</span>
sst_ALL_clim &lt;-<span class="st"> </span>sst_ALL <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">clim_10 =</span> <span class="kw">map</span>(data, ts2clm, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"2002-01-01"</span>, <span class="st">"2011-12-31"</span>)),
         <span class="dt">clim_20 =</span> <span class="kw">map</span>(data, ts2clm, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1992-01-01"</span>, <span class="st">"2011-12-31"</span>)),
         <span class="dt">clim_30 =</span> <span class="kw">map</span>(data, ts2clm, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> decades, <span class="dt">value =</span> output, <span class="op">-</span>site) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()

<span class="co"># Quick peak at mean seas clims</span>
sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, decades) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">seas_mean =</span> <span class="kw">mean</span>(seas))</code></pre></div>
<pre><code>## # A tibble: 9 x 3
## # Groups:   site [?]
##   site   decades seas_mean
##   &lt;chr&gt;  &lt;chr&gt;       &lt;dbl&gt;
## 1 Med    clim_10     18.1 
## 2 Med    clim_20     17.8 
## 3 Med    clim_30     17.7 
## 4 NW_Atl clim_10      8.68
## 5 NW_Atl clim_20      8.57
## 6 NW_Atl clim_30      8.58
## 7 WA     clim_10     21.6 
## 8 WA     clim_20     21.6 
## 9 WA     clim_30     21.5</code></pre>
<p>Quickly take note of the fact that for all three time series, the mean seasonal climatology becomes warmer the shorter (closer to the present) the period used is. This is to be expected due to the overall warming signal present throughout the worlds seas and oceans. We’ll return to the impact of this phenomenon later.</p>
<p>Now let’s compare the results of the events detected in the final decade of each time series using the different climatologies calculated using 1, 2, or 3 decades.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A clomp of functions used below</span>
<span class="co"># Written out here for tidiness/convenience</span>

<span class="co"># Calculate only events</span>
detect_event_event &lt;-<span class="st"> </span><span class="cf">function</span>(df, <span class="dt">y =</span> temp){
  ts_y &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">substitute</span>(y), df)
  df<span class="op">$</span>temp &lt;-<span class="st"> </span>ts_y
  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event</a></span>(df)<span class="op">$</span>event
  <span class="kw">return</span>(res)
  }

<span class="co"># Run an ANOVA on each metric of the combined event results and get the p-value</span>
event_aov_p &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  aov_models &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw">grep</span>(<span class="st">"decades"</span>, <span class="kw">names</span>(df))] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">aov</span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>decades)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/tidy">tidy</a></span>(.), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">p.value =</span> <span class="kw">round</span>(p.value, <span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(term <span class="op">!=</span><span class="st"> "Residuals"</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(metric, p.value)
  <span class="kw">return</span>(aov_models)
  }

<span class="co"># Run an ANOVA on each metric of the combined event results and get CI</span>
event_aov_CI &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  aov_models &lt;-<span class="st"> </span>df[ , <span class="op">-</span><span class="kw">grep</span>(<span class="st">"decades"</span>, <span class="kw">names</span>(df))] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">aov</span>(.x <span class="op">~</span><span class="st"> </span>df<span class="op">$</span>decades)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map_dfr</span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/confint_tidy">confint_tidy</a></span>(., <span class="dt">parm =</span> ), <span class="dt">.id =</span> <span class="st">'metric'</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">decades =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">"clim_10"</span>, <span class="st">"clim_20"</span>, <span class="st">"clim_30"</span>), <span class="kw">nrow</span>(.)<span class="op">/</span><span class="dv">3</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(metric, decades, <span class="kw">everything</span>())
  <span class="kw">return</span>(aov_models)
  }

<span class="co"># A particular summary output</span>
event_output &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(decades) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>event_no) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise_all</span>(<span class="kw">c</span>(<span class="st">"mean"</span>, <span class="st">"sd"</span>))
  <span class="kw">return</span>(res)
  }</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate events and filter only those from 2002 -- 2011</span>
sst_ALL_event &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, decades) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_event)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(res) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(date_start <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, date_end <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(index_start<span class="op">:</span>index_end, date_start<span class="op">:</span>date_end))

<span class="co"># ANOVA p</span>
sst_ALL_aov_p &lt;-<span class="st"> </span>sst_ALL_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_p)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> metric, <span class="dt">value =</span> p.value) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">names</span>(<span class="kw">select</span>(sst_ALL_event, <span class="op">-</span>decades, <span class="op">-</span>event_no)))
sst_ALL_aov_p</code></pre></div>
<pre><code>## # A tibble: 3 x 16
##   site   duration intensity_mean intensity_max intensity_var
##   &lt;chr&gt;     &lt;dbl&gt;          &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
## 1 Med      0.0776          0.343         0.202        0.0916
## 2 NW_Atl   0.382           0.338         0.424        0.887 
## 3 WA       0.977           0.731         0.979        0.989 
## # ... with 11 more variables: intensity_cumulative &lt;dbl&gt;,
## #   intensity_mean_relThresh &lt;dbl&gt;, intensity_max_relThresh &lt;dbl&gt;,
## #   intensity_var_relThresh &lt;dbl&gt;, intensity_cumulative_relThresh &lt;dbl&gt;,
## #   intensity_mean_abs &lt;dbl&gt;, intensity_max_abs &lt;dbl&gt;,
## #   intensity_var_abs &lt;dbl&gt;, intensity_cumulative_abs &lt;dbl&gt;,
## #   rate_onset &lt;dbl&gt;, rate_decline &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ANOVA CI</span>
sst_ALL_aov_CI &lt;-<span class="st"> </span>sst_ALL_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_CI)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(metric <span class="op">!=</span><span class="st"> "event_no"</span>)
sst_ALL_aov_CI</code></pre></div>
<pre><code>## # A tibble: 135 x 5
##    site  metric         decades conf.low conf.high
##    &lt;chr&gt; &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;
##  1 Med   duration       clim_10   7.09      12.6  
##  2 Med   duration       clim_20  -2.18       5.22 
##  3 Med   duration       clim_30   0.472      7.87 
##  4 Med   intensity_mean clim_10   1.58       2.24 
##  5 Med   intensity_mean clim_20  -0.293      0.598
##  6 Med   intensity_mean clim_30  -0.117      0.774
##  7 Med   intensity_max  clim_10   1.89       2.74 
##  8 Med   intensity_max  clim_20  -0.367      0.778
##  9 Med   intensity_max  clim_30  -0.0603     1.08 
## 10 Med   intensity_var  clim_10   0.201      0.361
## # ... with 125 more rows</code></pre>
<p>Whereas the results for the different metrics do differ, they are not significantly different for any of the three time series.</p>
<p>Now that we know that the detected events do not differ significantly, we still want to know by what amounts they do differ. This information will then later be used during the re-sampling to see if this gap can be reduced through the clever use of statistics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_ALL_out &lt;-<span class="st"> </span>sst_ALL_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_output)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>()
sst_ALL_out</code></pre></div>
<pre><code>## # A tibble: 9 x 32
##   site   decades duration_mean intensity_mean_mean intensity_max_mean
##   &lt;chr&gt;  &lt;chr&gt;           &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt;
## 1 Med    clim_10          9.83                1.91               2.32
## 2 Med    clim_20         11.3                 2.06               2.52
## 3 Med    clim_30         14                   2.23               2.83
## 4 NW_Atl clim_10          7.62                1.79               2.12
## 5 NW_Atl clim_20          9.44                1.87               2.25
## 6 NW_Atl clim_30          8.84                1.98               2.38
## 7 WA     clim_10         14.9                 1.77               2.37
## 8 WA     clim_20         16.1                 1.69               2.32
## 9 WA     clim_30         15.6                 1.72               2.32
## # ... with 27 more variables: intensity_var_mean &lt;dbl&gt;,
## #   intensity_cumulative_mean &lt;dbl&gt;, intensity_mean_relThresh_mean &lt;dbl&gt;,
## #   intensity_max_relThresh_mean &lt;dbl&gt;,
## #   intensity_var_relThresh_mean &lt;dbl&gt;,
## #   intensity_cumulative_relThresh_mean &lt;dbl&gt;,
## #   intensity_mean_abs_mean &lt;dbl&gt;, intensity_max_abs_mean &lt;dbl&gt;,
## #   intensity_var_abs_mean &lt;dbl&gt;, intensity_cumulative_abs_mean &lt;dbl&gt;,
## #   rate_onset_mean &lt;dbl&gt;, rate_decline_mean &lt;dbl&gt;, duration_sd &lt;dbl&gt;,
## #   intensity_mean_sd &lt;dbl&gt;, intensity_max_sd &lt;dbl&gt;,
## #   intensity_var_sd &lt;dbl&gt;, intensity_cumulative_sd &lt;dbl&gt;,
## #   intensity_mean_relThresh_sd &lt;dbl&gt;, intensity_max_relThresh_sd &lt;dbl&gt;,
## #   intensity_var_relThresh_sd &lt;dbl&gt;,
## #   intensity_cumulative_relThresh_sd &lt;dbl&gt;, intensity_mean_abs_sd &lt;dbl&gt;,
## #   intensity_max_abs_sd &lt;dbl&gt;, intensity_var_abs_sd &lt;dbl&gt;,
## #   intensity_cumulative_abs_sd &lt;dbl&gt;, rate_onset_sd &lt;dbl&gt;,
## #   rate_decline_sd &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create long data.frames for plotting</span>
<span class="co"># Mean values</span>
sst_ALL_out_mean_long &lt;-<span class="st"> </span>sst_ALL_out <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>rate_decline_mean)
<span class="kw">colnames</span>(sst_ALL_out_mean_long) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="kw">names</span>(sst_ALL_out_mean_long))
sst_ALL_out_mean_long &lt;-<span class="st"> </span>sst_ALL_out_mean_long <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>decades)
<span class="co"># SD values</span>
sst_ALL_out_sd_long &lt;-<span class="st"> </span>sst_ALL_out <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site, decades, duration_sd<span class="op">:</span>rate_decline_sd)
<span class="kw">colnames</span>(sst_ALL_out_sd_long) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">"_sd"</span>, <span class="st">""</span>, <span class="kw">names</span>(sst_ALL_out_sd_long))
sst_ALL_out_sd_long &lt;-<span class="st"> </span>sst_ALL_out_sd_long <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>decades)
<span class="co"># Steek'm</span>
sst_ALL_out_mean_long<span class="op">$</span>value_sd &lt;-<span class="st"> </span>sst_ALL_out_sd_long<span class="op">$</span>value

<span class="co"># Visuals... man</span>
<span class="kw">ggplot</span>(sst_ALL_out_mean_long, <span class="kw">aes</span>(<span class="dt">x =</span> site, <span class="dt">y =</span> value, <span class="dt">fill =</span> decades)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>()) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> value <span class="op">-</span><span class="st"> </span>value_sd, <span class="dt">ymax =</span> value <span class="op">+</span><span class="st"> </span>value_sd), 
                <span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.9</span>), <span class="dt">width =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>variable, <span class="dt">scales =</span> <span class="st">"free_y"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="time_series_duration_files/figure-html/event-bar-1.png" alt="Bar plots of the mean values for each metric of the events detected using one of three different climatology periods. Error bars show the standard deviation of the mean values." width="768"><p class="caption">
Bar plots of the mean values for each metric of the events detected using one of three different climatology periods. Error bars show the standard deviation of the mean values.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Long data.frame for plotting</span>
sst_ALL_event_long &lt;-<span class="st"> </span>sst_ALL_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>event_no) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>decades)

<span class="co"># Visualisations</span>
  <span class="co"># Notches are unhelpful and noisey here</span>
<span class="kw">ggplot</span>(sst_ALL_event_long, <span class="kw">aes</span>(<span class="dt">x =</span> site, <span class="dt">y =</span> value)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> decades), <span class="dt">position =</span> <span class="st">"dodge"</span>, <span class="dt">notch =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>variable, <span class="dt">scales =</span> <span class="st">"free_y"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="time_series_duration_files/figure-html/event-box1-1.png" alt="Boxplots showing the spread of the values for the metrics of the events detected with the three different clim periods." width="768"><p class="caption">
Boxplots showing the spread of the values for the metrics of the events detected with the three different clim periods.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">CI_plot_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">ggplot</span>(sst_ALL_aov_CI, <span class="kw">aes</span>(<span class="dt">x =</span> site)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.9</span>), <span class="dt">width =</span> <span class="fl">0.5</span>,
                <span class="kw">aes</span>(<span class="dt">ymin =</span> conf.low, <span class="dt">ymax =</span> conf.high, <span class="dt">linetype =</span> decades)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>metric, <span class="dt">scales =</span> <span class="st">"free_y"</span>)
CI_plot_<span class="dv">1</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="time_series_duration_files/figure-html/event-CI-plot1-1.png" alt="Confidence intervals of the different metrics for the three different clim periods from the population mean." width="768"><p class="caption">
Confidence intervals of the different metrics for the three different clim periods from the population mean.
</p>
</div>
<p>The difference between the three different time series is intriguing. The <code>NW_Atl</code> events have less cumulative intensity when one only uses the final decade for the climatology, but there is little difference between two and three decades. The <code>Med</code> data changed over time in a more predictable, linear fashion. Strangest was that the <code>WA</code> data change very little depending on the number of decades used for the climatology, and that the trend displayed by the other two time series is reversed for some of the metrics in the WA time series. This is most certainly due to that one huge event near the end.</p>
<p>When we look at the confidence intervals (CI) we see that the max and mean intensities calculated from the 10 year clim periods may be significantly different from those calculated at the 20 and 30 year period. But that the 20 and 30 year values are remarkably similar. This is a good indication that 10 years is too short, but that 20 years appears to be acceptable in place of the (still preferable) 30 year period.</p>
<p>(RWS: Could there be a relationship between normality and change due to decade of choice?)</p>
<p>With these benchmarks established, we will now move on to re-sampling to see if the effect of a shorter time series on the detected climatology can be mitigated.</p>
</div>
<div id="re-sampling" class="section level2">
<h2 class="hasAnchor">
<a href="#re-sampling" class="anchor"></a>Re-sampling</h2>
<p>With the effect of shortening time series on the detection of events quantified, we will now perform <a href="https://robwschlegel.github.io/MHWdetection/articles/Short_climatologies.html">re-sampling</a> to simulate one hundred 10, 20, and 30 year time series in order to quantify how much more variance one may expect from shorter time series. This will be measured through the following statistics:</p>
<ul>
<li>for each day-of-year (doy) in the climatology, calculate the SD of the climatological means of the 100 re-samplings;</li>
<li>for each doy, calculate the RMSE of the re-sampled means relative to the true climatology (i.e. the one produced from the 30-year long time series);</li>
<li>correspondence of detected events when using climatologies calculated from reduced time series vs. when using the full duration time series climatologies.</li>
</ul>
<p>The secondary goal of this step in this section of the methodology is to also identify how much more accurate this re-sampling may be able to make the climatologies generated from shorter time series as a technique for addressing this potential short-coming (yes, that was a pun).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_repl &lt;-<span class="st"> </span><span class="cf">function</span>(sst) {
  sst.sampled &lt;-<span class="st"> </span>sst <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sample_10 =</span> <span class="kw">map</span>(data, sample_n, <span class="dv">10</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),
           <span class="dt">sample_20 =</span> <span class="kw">map</span>(data, sample_n, <span class="dv">20</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),
           <span class="dt">sample_30 =</span> <span class="kw">map</span>(data, sample_n, <span class="dv">30</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>))
  <span class="kw">return</span>(sst.sampled)
}

parse_date_sst &lt;-<span class="st"> </span><span class="cf">function</span>(data, rep_col, len) {
  parsed &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">id =</span> rep_col,
           <span class="dt">y =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(t),
           <span class="dt">m =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/month.html">month</a></span>(t),
           <span class="dt">d =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/day.html">day</a></span>(t)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(site, rep, doy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">y =</span> <span class="kw">seq</span>(<span class="dv">2012</span><span class="op">-</span>len, <span class="dt">by =</span> <span class="dv">1</span>, <span class="dt">len =</span> len)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">t =</span> <span class="kw">as.Date</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/fasttime/topics/fastPOSIXct">fastPOSIXct</a></span>(<span class="kw">paste</span>(y, m, d, <span class="dt">sep =</span> <span class="st">"-"</span>)))) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>y, <span class="op">-</span>m, <span class="op">-</span>d) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">na.omit</span>() <span class="co"># because of complications due to leap years</span>
  <span class="kw">return</span>(parsed)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_ALL_doy &lt;-<span class="st"> </span>sst_ALL <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">doy =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/day.html">yday</a></span>(<span class="kw">as.Date</span>(t))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site, <span class="op">-</span>doy)

sst_ALL_repl &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/rerun">rerun</a></span>(<span class="dv">100</span>, <span class="kw">sst_repl</span>(sst_ALL_doy)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">map_df</span>(as.data.frame, <span class="dt">.id =</span> <span class="st">"rep"</span>)

sample_<span class="dv">10</span> &lt;-<span class="st"> </span>sst_ALL_repl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(sample_<span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parse_date_sst</span>(<span class="st">"sample_10"</span>, <span class="dt">len =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(site, id, rep) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw">map</span>(data, <span class="cf">function</span>(x) <span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(x, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"2002-01-01"</span>, <span class="st">"2011-12-31"</span>)))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(smoothed)

sample_<span class="dv">20</span> &lt;-<span class="st"> </span>sst_ALL_repl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(sample_<span class="dv">20</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parse_date_sst</span>(<span class="st">"sample_20"</span>, <span class="dt">len =</span> <span class="dv">20</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(site, id, rep) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw">map</span>(data, <span class="cf">function</span>(x) <span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(x, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1992-01-01"</span>, <span class="st">"2011-12-31"</span>)))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(smoothed)

sample_<span class="dv">30</span> &lt;-<span class="st"> </span>sst_ALL_repl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(sample_<span class="dv">30</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parse_date_sst</span>(<span class="st">"sample_30"</span>, <span class="dt">len =</span> <span class="dv">30</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(site, id, rep) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw">map</span>(data, <span class="cf">function</span>(x) <span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(x, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1982-01-01"</span>, <span class="st">"2011-12-31"</span>)))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(smoothed)

sst_ALL_smooth &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(sample_<span class="dv">10</span>, sample_<span class="dv">20</span>, sample_<span class="dv">30</span>)
<span class="kw">save</span>(sst_ALL_smooth, <span class="dt">file =</span> <span class="st">"data/sst_ALL_smooth.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This file is not uploaded to GitHub as it is too large</span>
<span class="co"># One must first run the above code locally to generate and save the file</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_smooth.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># for each day-of-year (doy) in the climatology, calculate the SD of the climatological means of the 100 re-samplings;</span>
sst_ALL_sd &lt;-<span class="st"> </span>sst_ALL_smooth <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, id, doy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">seas_sd =</span> <span class="kw">sd</span>(seas),
            <span class="dt">thresh_sd =</span> <span class="kw">sd</span>(thresh),
            <span class="dt">var_sd =</span> <span class="kw">sd</span>(var)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>id, <span class="op">-</span>doy)

<span class="kw">ggplot</span>(sst_ALL_sd, <span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> value)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> id)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(variable <span class="op">~</span><span class="st"> </span>site)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="time_series_duration_files/figure-html/re-sample-stats-sd-1.png" alt="Line plot showing the standard deviation (sd) of each day of the year (doy) for the three different sites. The line colours denote the number of samples used for each doy. All re-samples were run 100 times, thus n = 100 for each sd of each doy for each id." width="768"><p class="caption">
Line plot showing the standard deviation (sd) of each day of the year (doy) for the three different sites. The line colours denote the number of samples used for each doy. All re-samples were run 100 times, thus n = 100 for each sd of each doy for each id.
</p>
</div>
<p>Hmmm…. Interesting how the seasonal and threshold signals of increased summer variance comes through so nicely in the <code>Med</code> data the fewer samples are taken. The other two time series produce somewhat strange signals. We can see that the 30 year, and to a lesser extent 20 year, re-sampled time series are much smoother than the 10 year re-sample. The <code>WA</code> data are either very strange, or very exposed to particularly intense events.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst_ALL_sd <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, variable, id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">sd_mean =</span> <span class="kw">mean</span>(value))</code></pre></div>
<pre><code>## # A tibble: 27 x 4
## # Groups:   site, variable [?]
##    site   variable  id        sd_mean
##    &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;
##  1 Med    seas_sd   sample_10  0.0565
##  2 Med    seas_sd   sample_20  0.0393
##  3 Med    seas_sd   sample_30  0.0328
##  4 Med    thresh_sd sample_10  0.0969
##  5 Med    thresh_sd sample_20  0.0706
##  6 Med    thresh_sd sample_30  0.0593
##  7 Med    var_sd    sample_10  0.0397
##  8 Med    var_sd    sample_20  0.0283
##  9 Med    var_sd    sample_30  0.0235
## 10 NW_Atl seas_sd   sample_10  0.0621
## # ... with 17 more rows</code></pre>
<p>A quick glimpse at the overall mean of the SD values for each site and re-sample period shows how similar they are. Actually, there is not a linear relationship between increased re-sample size and decreased variance. That being said, an increased re-sample size does appear to produce a more stable variance profile. Meaning that even though the mean SD for the 10 year re-samples are very similar to the 20 and 30 year re-samples, to an extent this is because the variance is more variable, ultimately flattening itself out somewhat. This may be seen in the figure above how the slight peaks come out for the 10 year samples both above and below the other lines based on larger samples. Afain, this appears almost negligible.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Base 30 year clims</span>
sst_ALL_clim_base &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(decades <span class="op">==</span><span class="st"> "clim_30"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>doy, seas<span class="op">:</span>var, <span class="op">-</span>decades) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>()

<span class="co"># For each doy, calculate the RMSE of the re-sampled means relative to the true climatology (i.e. the one produced from the 30-year long time series);</span>
sst_ALL_error &lt;-<span class="st"> </span>sst_ALL_smooth <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>doy, seas<span class="op">:</span>var) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(sst_ALL_clim_base, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"site"</span>, <span class="st">"doy"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">seas.er =</span> seas.x <span class="op">-</span><span class="st"> </span>seas.y,
         <span class="dt">thresh.er =</span> thresh.x <span class="op">-</span><span class="st"> </span>thresh.y,
         <span class="dt">var.er =</span> var.x <span class="op">-</span><span class="st"> </span>var.y)

sst_ALL_RMSE &lt;-<span class="st"> </span>sst_ALL_error <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, id, doy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">seas_RMSE =</span> <span class="kw">sqrt</span>(<span class="kw">mean</span>(seas.er<span class="op">^</span><span class="dv">2</span>)),
            <span class="dt">thresh_RMSE =</span> <span class="kw">sqrt</span>(<span class="kw">mean</span>(thresh.er<span class="op">^</span><span class="dv">2</span>)),
            <span class="dt">var_RMSE =</span> <span class="kw">sqrt</span>(<span class="kw">mean</span>(var.er<span class="op">^</span><span class="dv">2</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>id, <span class="op">-</span>doy)

<span class="kw">ggplot</span>(sst_ALL_RMSE, <span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> value)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> id)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(variable <span class="op">~</span><span class="st"> </span>site)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="time_series_duration_files/figure-html/re-sample-stats-RMSE-1.png" alt="Line graph, as above, but now showing the RMSE for each doy for the three different climatology durations." width="768"><p class="caption">
Line graph, as above, but now showing the RMSE for each doy for the three different climatology durations.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># It appears as though the actual time series constructed from re-sampling, </span>
<span class="co"># while useful for creating climatologies, are totally deurmekaar </span>
<span class="co"># and do not actually lend themselves to the detection of heatwaves</span>
<span class="co"># Therefore it is necessary to replace the 'temp' values in the smoothes data with the real values</span>
sst_ALL_smooth_real &lt;-<span class="st"> </span>sst_ALL_smooth <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>temp) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(sst_ALL, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"site"</span>, <span class="st">"t"</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Then caluclate events using the many re-smapled clims on the real temperature data</span>
sst_ALL_smooth_event &lt;-<span class="st"> </span>sst_ALL_smooth_real <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, id, rep) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_event)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(res) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(date_start <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, date_end <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(index_start<span class="op">:</span>index_end, date_start<span class="op">:</span>date_end))

<span class="kw">save</span>(sst_ALL_smooth_event, <span class="dt">file =</span> <span class="st">"data/sst_ALL_smooth_event.Rdata"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This file is not uploaded to GitHub as it is too large</span>
<span class="co"># One must first run the above code locally to generate and save the file</span>
<span class="kw">load</span>(<span class="st">"data/sst_ALL_smooth_event.Rdata"</span>)

<span class="co"># Rename for project-wide consistency</span>
sst_ALL_smooth_event &lt;-<span class="st"> </span>sst_ALL_smooth_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">decades =</span> id)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># correspondence of detected events when using climatologies calculated from reduced time series vs. when using the full duration time series climatologies.</span>
<span class="co"># ANOVA p</span>
sst_ALL_smooth_aov_p &lt;-<span class="st"> </span>sst_ALL_smooth_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_p)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> metric, <span class="dt">value =</span> p.value) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">names</span>(<span class="kw">select</span>(sst_ALL_event, <span class="op">-</span>decades, <span class="op">-</span>event_no)))
sst_ALL_smooth_aov_p</code></pre></div>
<pre><code>## # A tibble: 3 x 16
##   site   duration intensity_mean intensity_max intensity_var
##   &lt;chr&gt;     &lt;dbl&gt;          &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
## 1 Med       0.945         0.194          0.363         0.977
## 2 NW_Atl    0.724         0.0607         0.603         0.310
## 3 WA        0.636         0.488          0.998         0.963
## # ... with 11 more variables: intensity_cumulative &lt;dbl&gt;,
## #   intensity_mean_relThresh &lt;dbl&gt;, intensity_max_relThresh &lt;dbl&gt;,
## #   intensity_var_relThresh &lt;dbl&gt;, intensity_cumulative_relThresh &lt;dbl&gt;,
## #   intensity_mean_abs &lt;dbl&gt;, intensity_max_abs &lt;dbl&gt;,
## #   intensity_var_abs &lt;dbl&gt;, intensity_cumulative_abs &lt;dbl&gt;,
## #   rate_onset &lt;dbl&gt;, rate_decline &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ANOVA CI</span>
sst_ALL_smooth_aov_CI &lt;-<span class="st"> </span>sst_ALL_smooth_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, event_aov_CI)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(metric <span class="op">!=</span><span class="st"> "event_no"</span>,
         metric <span class="op">!=</span><span class="st"> "rep"</span>)
sst_ALL_smooth_aov_CI</code></pre></div>
<pre><code>## # A tibble: 135 x 5
##    site  metric         decades  conf.low conf.high
##    &lt;chr&gt; &lt;chr&gt;          &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;
##  1 Med   duration       clim_10  14.2       14.8   
##  2 Med   duration       clim_20  -0.465      0.374 
##  3 Med   duration       clim_30  -0.395      0.447 
##  4 Med   intensity_mean clim_10   2.05       2.11  
##  5 Med   intensity_mean clim_20  -0.0128     0.0618
##  6 Med   intensity_mean clim_30  -0.00413    0.0706
##  7 Med   intensity_max  clim_10   2.66       2.73  
##  8 Med   intensity_max  clim_20  -0.0254     0.0773
##  9 Med   intensity_max  clim_30  -0.0153     0.0877
## 10 Med   intensity_var  clim_10   0.395      0.410 
## # ... with 125 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Long data.frame for plotting</span>
sst_ALL_smooth_event_long &lt;-<span class="st"> </span>sst_ALL_smooth_event <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>event_no) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>site, <span class="op">-</span>decades)

<span class="co"># Visualisations</span>
  <span class="co"># Notches are unhelpful and noisey here</span>
<span class="co"># ggplot(sst_ALL_smooth_event_long, aes(x = site, y = value)) +</span>
<span class="co">#   geom_boxplot(aes(fill = decades), position = "dodge", notch = FALSE) +</span>
<span class="co">#   facet_wrap(~variable, scales = "free_y")</span>
<span class="co"># NB: This visualisation is too beefy</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># CI_plot_2 &lt;- ggplot(sst_ALL_smooth_aov_CI, aes(x = site)) +</span>
<span class="co">#   geom_errorbar(position = position_dodge(0.9), width = 0.5,</span>
<span class="co">#                aes(ymin = conf.low, ymax = conf.high, linetype = decades)) +</span>
<span class="co">#   facet_wrap(~metric, scales = "free_y")</span>
<span class="co"># ggarrange(CI_plot_1, CI_plot_2, ncol = 1, nrow = 2)</span>

<span class="kw">ggplot</span>(sst_ALL_aov_CI, <span class="kw">aes</span>(<span class="dt">x =</span> site)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.9</span>), <span class="dt">width =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">"black"</span>,
                <span class="kw">aes</span>(<span class="dt">ymin =</span> conf.low, <span class="dt">ymax =</span> conf.high, <span class="dt">linetype =</span> decades)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="dt">data =</span> sst_ALL_smooth_aov_CI,
                <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.9</span>), <span class="dt">width =</span> <span class="fl">0.5</span>, <span class="dt">colour =</span> <span class="st">"red"</span>,
                <span class="kw">aes</span>(<span class="dt">ymin =</span> conf.low, <span class="dt">ymax =</span> conf.high, <span class="dt">linetype =</span> decades)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>metric, <span class="dt">scales =</span> <span class="st">"free_y"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="time_series_duration_files/figure-html/event-CI-plot2-1.png" alt="Confidence intervals of the different metrics for the three different clim periods from the population mean based on the 100 times re-sampling of each clim period in red, and the single sample based on the real data in black." width="768"><p class="caption">
Confidence intervals of the different metrics for the three different clim periods from the population mean based on the 100 times re-sampling of each clim period in red, and the single sample based on the real data in black.
</p>
</div>
<p>Though I was not able to run the boxplot, because my computer kept falling over, the CI plot above demonstrates that the difference detected in the first round of experiments (when the real 10, 20, and 30 year baselines were used to generate a single clim each) holds up when we re-sample the clim generation 100 times. The centre around which the CI spread may be found remains very similar between the two experiments, with the distance between the upper and lower limits shrinking drammatically with re-sampling. Through resampling we see that there is a difference between the 10 year clims and the 20 and 30 year clims. But that there is no difference between the 20 and 30 year clims. Next we will use bootstrapping to see if we can lessen this gap.</p>
</div>
<div id="bootstrapping" class="section level2">
<h2 class="hasAnchor">
<a href="#bootstrapping" class="anchor"></a>Bootstrapping</h2>
<p>Bootstrapping differs from re-sampling in that we will be creating new data based on the known distribution of data we will be sampling from. These known distributions are to be the temperature values on each Julian day of the year. The steps to take for a basic bootstraping approach are thus:</p>
<ul>
<li>Take distributions of each Julian doy</li>
<li>Do so for the 10, 20, and 30 year real periods</li>
<li>Bootstrap those distributions and create clims from there</li>
</ul>
<p>So without any further ado.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First create the base time series for bootstrapping</span>
sst_ALL_clim_<span class="dv">10</span> &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(decades <span class="op">==</span><span class="st"> "clim_10"</span>, t <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, t <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>temp)
sst_ALL_clim_<span class="dv">20</span> &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(decades <span class="op">==</span><span class="st"> "clim_20"</span>, t <span class="op">&gt;=</span><span class="st"> "1992-01-01"</span>, t <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>temp)
sst_ALL_clim_<span class="dv">30</span> &lt;-<span class="st"> </span>sst_ALL_clim <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(decades <span class="op">==</span><span class="st"> "clim_30"</span>, t <span class="op">&gt;=</span><span class="st"> "1982-01-01"</span>, t <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site<span class="op">:</span>temp)
sst_ALL_clim_period &lt;-<span class="st"> </span><span class="kw">rbind</span>(sst_ALL_clim_<span class="dv">10</span>, sst_ALL_clim_<span class="dv">20</span>, sst_ALL_clim_<span class="dv">30</span>)
<span class="kw">rm</span>(sst_ALL_clim_<span class="dv">10</span>, sst_ALL_clim_<span class="dv">20</span>, sst_ALL_clim_<span class="dv">30</span>)

<span class="co"># function to obtain a mean for each julian date</span>
mjd &lt;-<span class="st"> </span><span class="cf">function</span>(data, indices) {
  d &lt;-<span class="st"> </span>data[indices,] <span class="co"># allows boot to select sample</span>
  res &lt;-<span class="st"> </span><span class="kw">mean</span>(d<span class="op">$</span>temp)
  <span class="kw">return</span>(res)
}

<span class="co"># Function for running a bootstrap within a nest</span>
mjd_boot &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  res &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/boot/topics/boot">boot</a></span>(<span class="dt">data =</span> df, <span class="dt">statistic =</span> mjd, <span class="dt">R =</span> <span class="dv">100</span>)
  res1 &lt;-<span class="st"> </span><span class="kw">mean</span>(res<span class="op">$</span>t)
  res2 &lt;-<span class="st"> </span>res<span class="op">$</span>t0
  res3 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">boot =</span> res1, <span class="dt">real =</span> res2)
  <span class="kw">return</span>(res3)
}

<span class="co"># Boot the values</span>
sst_ALL_clim_period_boot &lt;-<span class="st"> </span>sst_ALL_clim_period <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site, <span class="op">-</span>decades, <span class="op">-</span>doy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">temp_boot =</span> <span class="kw">map</span>(data, mjd_boot)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(temp_boot) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(site, decades, doy) <span class="co">#%&gt;% </span>
  <span class="co"># mutate(t = rep(seq(as.Date("2016-01-01"), as.Date("2016-12-31"), by = "day"), 9))</span>

<span class="co"># Then join these values into the pre-existing data frames</span>
sst_ALL_clim_period &lt;-<span class="st"> </span>sst_ALL_clim_period <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(sst_ALL_clim_period_boot, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"site"</span>, <span class="st">"decades"</span>, <span class="st">"doy"</span>))

<span class="co"># Create clims from the booted and real mean values per Julian day</span>
sst_ALL_clim_multi &lt;-<span class="st"> </span>sst_ALL_clim_period <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>site, <span class="op">-</span>decades) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">clim_boot =</span> <span class="kw">map</span>(data, ts2clm, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"2002-01-01"</span>, <span class="st">"2011-12-31"</span>), 
                         <span class="dt">y =</span> boot, <span class="dt">robust =</span> <span class="ot">FALSE</span>, <span class="dt">clmOnly =</span> <span class="ot">TRUE</span>),
         <span class="dt">clim_real =</span> <span class="kw">map</span>(data, ts2clm, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"2002-01-01"</span>, <span class="st">"2011-12-31"</span>), 
                         <span class="dt">y =</span> real, <span class="dt">robust =</span> <span class="ot">FALSE</span>, <span class="dt">clmOnly =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data)

<span class="co"># Extract the boot mean clims and calculate events</span>
sst_ALL_clim_boot &lt;-<span class="st"> </span>sst_ALL_clim_multi <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(clim_boot) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(sst_ALL_clim_period, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"site"</span>, <span class="st">"decades"</span>, <span class="st">"doy"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site, decades, doy, t, temp, seas, thresh, var) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(site, decades, t)
sst_ALL_event_boot &lt;-<span class="st"> </span>sst_ALL_clim_boot <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, decades) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_event)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(res) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(date_start <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, date_end <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(index_start<span class="op">:</span>index_end, date_start<span class="op">:</span>date_end))

<span class="co"># Extract the real mean clims and calculate events</span>
sst_ALL_clim_real &lt;-<span class="st"> </span>sst_ALL_clim_multi <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(clim_real) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(sst_ALL_clim_period, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"site"</span>, <span class="st">"decades"</span>, <span class="st">"doy"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(site, decades, doy, t, temp, seas, thresh, var) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(site, decades, t)
sst_ALL_event_real &lt;-<span class="st"> </span>sst_ALL_clim_real <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(site, decades) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">res =</span> <span class="kw">map</span>(data, detect_event_event)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(res) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(date_start <span class="op">&gt;=</span><span class="st"> "2002-01-01"</span>, date_end <span class="op">&lt;=</span><span class="st"> "2011-12-31"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(index_start<span class="op">:</span>index_end, date_start<span class="op">:</span>date_end))</code></pre></div>
<p>The bootstrapping of the value used to create the climatologies produces a suspiciously larger number of events. Need to take a closer look.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Line graph showing different seas columns from different methods</span>
<span class="kw">ggplot</span>(sst_ALL_clim, <span class="kw">aes</span>(<span class="dt">x =</span> t, <span class="dt">y =</span> seas)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> sst_ALL_clim_boot, <span class="dt">colour =</span> <span class="st">"red"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> sst_ALL_clim_real, <span class="dt">colour =</span> <span class="st">"blue"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(site <span class="op">~</span><span class="st"> </span>decades, <span class="dt">scales =</span> <span class="st">"free_y"</span>)</code></pre></div>
<p><img src="time_series_duration_files/figure-html/unnamed-chunk-4-1.png" width="768" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Line graph showing different seas columns from different methods</span>
<span class="kw">ggplot</span>(sst_ALL_clim, <span class="kw">aes</span>(<span class="dt">x =</span> t, <span class="dt">y =</span> thresh)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> sst_ALL_clim_boot, <span class="dt">colour =</span> <span class="st">"red"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> sst_ALL_clim_real, <span class="dt">colour =</span> <span class="st">"blue"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(site <span class="op">~</span><span class="st"> </span>decades, <span class="dt">scales =</span> <span class="st">"free_y"</span>)</code></pre></div>
<p><img src="time_series_duration_files/figure-html/unnamed-chunk-4-2.png" width="768" style="display: block; margin: auto;"></p>
<p>So it looks like bootstrapping isn’t going to work as the creation of mean values from the bootstrapped ones artificially lowers the 90th percentile threshold and prevents the accurate detection of events. The events detected in the bootstrapped data are more than double those detected in the real data. The next logical step would be to then not create means from the bootstrapped values, but rather to use bootstrapping to select values per <code>doy</code> and stitch those together into the time series that would be used to generate another set of clims. But that is no different from re-sampling. The only difference proposed here from what has already been done above is that the previous re-sampling drew on the full 33 years of data for the creation of the re-sampled 10, 20, and 30 year time series. I suppose one could do that again, except this time only draw from the diminished time periods. Meaning, first reduce the time series down to the 10, 20, or 30 year periods and then re-sample. But this would be nearly pointless as one would just be shuffling the years of data around and the climatology creation doesn’t care what order the data are in. Meaning it would have no effect. I am confident enough about this that I don’t think it needs to be tested. But then, how else may one improve a short time series? I’m thinking that it may work to just subtract the decadal signal from the threshold, but how would one know what that is without 30+ years of data? Perhaps one could find it from a longer SST product and then transpose that onto the shorter SST times series/product being used. But that seems like a lot could go wrong.</p>
</div>
<div id="categories" class="section level2">
<h2 class="hasAnchor">
<a href="#categories" class="anchor"></a>Categories</h2>
<p>In this section we want to look at how the categories in the different time periods compare. I’ll start out with doing basic calculations and comparisons of the categories of events with the different time periods. And then based on how that looks, see if I can think of a way of quantifying the differences.</p>
</div>
<div id="arguments" class="section level2">
<h2 class="hasAnchor">
<a href="#arguments" class="anchor"></a>Arguments</h2>
<p>With the amount of variance that may be accounted for through re-sampling and bootstrapping known, we will now look into how we may go about more confidently creating a climatology that will consistently detect events as similarly as possible by experimenting with how the various arguments within the detection pipeline may affect our results, given the different lengths of time series employed. After this has been done we will look into using the Fourier transform climatology generating method (<a href="https://robwschlegel.github.io/MHWdetection/articles/Climatologies_and_baselines.html" class="uri">https://robwschlegel.github.io/MHWdetection/articles/Climatologies_and_baselines.html</a>) to see if that can’t be more effective. The efficacy of these techniques will be judged through a number of statistical measurements of variance and similarity.</p>
<p>Seeing as how 20 and 30 year periods produce very similar results, we will be focussing primarily on what may be done about the 10 year period to make it more similar to the 30 year period. I don’t think it is necessary to do so for the 20 year period.</p>
</div>
<div id="fourier-transform-climatologies" class="section level2">
<h2 class="hasAnchor">
<a href="#fourier-transform-climatologies" class="anchor"></a>Fourier transform climatologies</h2>
<p>Lastly we will now go about reproducing all of the checks made above, but based on a climatology derived from a FOurier transformation, and not the default methodology.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Oliver2018">
<p>Oliver, Eric C.J., Markus G. Donat, Michael T. Burrows, Pippa J. Moore, Dan A. Smale, Lisa V. Alexander, Jessica A. Benthuysen, et al. 2018. “Longer and more frequent marine heatwaves over the past century.” <em>Nature Communications</em> 9 (1). doi:<a href="https://doi.org/10.1038/s41467-018-03732-9">10.1038/s41467-018-03732-9</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#time-series-shortening">Time series shortening</a></li>
      <li><a href="#simply-shorter">Simply shorter</a></li>
      <li><a href="#re-sampling">Re-sampling</a></li>
      <li><a href="#bootstrapping">Bootstrapping</a></li>
      <li><a href="#categories">Categories</a></li>
      <li><a href="#arguments">Arguments</a></li>
      <li><a href="#fourier-transform-climatologies">Fourier transform climatologies</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert W. Schlegel, Eric C. J. Oliver, Alistair J. Hobday, Albertus J. Smit.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
