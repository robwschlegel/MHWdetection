<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to create climatologies from short time series • MHWdetection</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="How to create climatologies from short time series">
<meta property="og:description" content="This vignette is about the creation of climatologies starting with short time series.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MHWdetection</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/r_vs_python.html">Python vs. R - default outputs</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_arguments.html">Python vs. R - default arguments</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_additional.html">Python vs. R - additional functions</a>
    </li>
    <li>
      <a href="../articles/Short_climatologies.html">Short climatologies</a>
    </li>
    <li>
      <a href="../articles/Climatologies_and_baselines.html">Alternative climatologies and baselines</a>
    </li>
    <li>
      <a href="../articles/time_series_duration.html">Effects of short time series</a>
    </li>
    <li>
      <a href="../articles/random_missing_data.html">Effects of random missing data</a>
    </li>
    <li>
      <a href="../articles/non_random_missing_data.html">Effects of non-random mising data</a>
    </li>
    <li>
      <a href="../articles/gridded_products.html">Difference between gridded products</a>
    </li>
    <li>
      <a href="../articles/best_practices.html">Best practices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/robwschlegel/MHWdetection">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>How to create climatologies from short time series</h1>
                        <h4 class="author">AJ Smit</h4>
            
            <h4 class="date">2018-05-29</h4>
      
      
      <div class="hidden name"><code>Short_climatologies.Rmd</code></div>

    </div>

    
    
<p>How does one create the best climatology? What if the time series is shorter than the recommended 30 years?</p>
<p>Lets look at all the SACTN data that’s longer than 30 years first. Can each site’s annual signal be represented by a sine/cosine curve derived from a Fourier analysis? First I find all the sites within the South African Coastal Temperature Network that are approaimately 30 years or more in duration.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">"~/SACTNraw/data/4_products/SACTN_daily_v4.2.RData"</span>)
daily.in &lt;-<span class="st"> </span>SACTN_daily_v4.<span class="dv">2</span>
<span class="kw">rm</span>(SACTN_daily_v4.<span class="dv">2</span>)
long_sites &lt;-<span class="st"> </span>daily.in <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(index) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">365</span> <span class="op">*</span><span class="st"> </span><span class="dv">30</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()</code></pre></div>
<p>Now, for each site that has ≥30 years of data, I create a daily climatology by taking the mean for each Julian day, using all data across the full duration of each time series.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">daily &lt;-<span class="st"> </span>daily.in <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(index <span class="op">%in%</span><span class="st"> </span>long_sites<span class="op">$</span>index) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">index =</span> <span class="kw">as.character</span>(index)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># droplevels() %&gt;% </span>
<span class="st">  </span><span class="kw">group_by</span>(index) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">doy =</span> <span class="kw">yday</span>(date)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(index, doy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">temp =</span> <span class="kw">mean</span>(temp, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()</code></pre></div>
<p>I make a function that will fit a Fourier series with seven basis functions (3 sine, 3 cosine and the constant) to the data. This is the same approach I used to create the smooth climatology in “Climatologies and baseline” elsewhere on this site, and it is also the one favoured in the creation of the dialy Optimally Interpolated Sea Surface Temperature climatology <span class="citation">(Banzon et al. 2014)</span>. Here it is wrapped in a function so I can easily apply it to each time series.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fFun &lt;-<span class="st"> </span><span class="cf">function</span>(data) {
  <span class="kw">require</span>(fda)
  b7 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fda/topics/create.fourier.basis">create.fourier.basis</a></span>(<span class="dt">rangeval =</span> <span class="kw">range</span>(data<span class="op">$</span>doy), <span class="dt">nbasis =</span> <span class="dv">7</span>)

  <span class="co"># create smooth seasonal climatology</span>
  b7.smth &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fda/topics/smooth.basis">smooth.basis</a></span>(<span class="dt">argvals =</span> data<span class="op">$</span>doy, <span class="dt">y =</span> data<span class="op">$</span>temp, <span class="dt">fdParobj =</span> b7)<span class="op">$</span>fd
  data.smth &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fda/topics/eval.fd">eval.fd</a></span>(data<span class="op">$</span>doy, b7.smth)
  <span class="kw">return</span>(data.smth)
}
<span class="co"># currently this function fails when the 1st of January is an NA</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># which sites have NAs?</span>
excl.sites &lt;-<span class="st"> </span><span class="kw">c</span>(daily[<span class="kw">is.na</span>(daily<span class="op">$</span>temp), <span class="dv">1</span>])<span class="op">$</span>index

daily.nest &lt;-<span class="st"> </span>daily <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>index <span class="op">%in%</span><span class="st"> </span>excl.sites) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>index)

daily.smth &lt;-<span class="st"> </span>daily.nest <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw">map</span>(data, fFun)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(data, smoothed)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plt1 &lt;-<span class="st"> </span>daily.smth <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> temp)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape =</span> <span class="st">"+"</span>, <span class="dt">colour =</span> <span class="st">"red"</span>, <span class="dt">alpha =</span> <span class="fl">0.6</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> smoothed, <span class="dt">group =</span> index), <span class="dt">size =</span> <span class="fl">0.6</span>, <span class="dt">colour =</span> <span class="st">"black"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>index) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Julian day"</span>, <span class="dt">y =</span> <span class="st">"Temperature (°C)"</span>, <span class="dt">title =</span> <span class="st">"SACTN: daily climatology"</span>,
       <span class="dt">subtitle =</span> <span class="st">"Fourier series: 7 basis functions"</span>)
<span class="kw">ggsave</span>(plt1, <span class="dt">file =</span> <span class="st">"fig/SACTN_Fourier7.png"</span>, <span class="dt">width =</span> <span class="dv">12</span>, <span class="dt">height =</span> <span class="dv">9</span>, <span class="dt">dpi =</span> <span class="dv">120</span>)</code></pre></div>
<div class="figure">
<img src="fig/SACTN_Fourier7.png" alt="Figure 1. Smooth climatologies derived from a Fourier analysis fitted to coastal seawater time series along the South African coast. Climatologies were produced only for sites with at least 30 year long time series." style="width:100.0%"><p class="caption"><strong>Figure 1.</strong> Smooth climatologies derived from a Fourier analysis fitted to coastal seawater time series along the South African coast. Climatologies were produced only for sites with at least 30 year long time series.</p>
</div>
<div id="time-series-length" class="section level2">
<h2 class="hasAnchor">
<a href="#time-series-length" class="anchor"></a>Time series length</h2>
<div id="fourier-series" class="section level3">
<h3 class="hasAnchor">
<a href="#fourier-series" class="anchor"></a>Fourier series</h3>
<p>There are instances when we might need to create climatologies when we don’t have access to time series of 30 years or longer. To look at this problem, I created a quick bootstrap analysis to see what the effect of time series length is on the resultant climatology. In this instance I used a Fourier analysis (see Banzon et al., 2014) to calculate six modes within an annual cycle, and used these to reconstruct a smooth climatology. This technique is quite forgiving of SST seasonalities that depart from typical sinusoidal profiles, such as which we find along upwelling areas (I have tested this on our coastal seawater temperatures).</p>
<p>I used the Western Australian data that’s packaged with the python and R marine heat wave scripts. Later I’ll test this more widely on other time series. The WA time series is 32 years long. I treat all temperatures over the duration of the time series as a pool of data, separately for each day-of-year (doy); i.e. doy 1 has 32 temperatures, doy 2 also has 32 temperatures, etc. I assume that the temperature on doy 1 of 1982 is independent of that on doy 1 in every other year (etc.), so the sample of doy 1 temperatures is therefore independent and identically distributed (i.i.d.). I further assume that there’s no autocorrelation from day-to-day (definitely erroneous, but I don’t think it matters here).</p>
<p>For each day’s pool of samples I then randomly take 10 samples and find the mean of that. This is the same as averaging over 10 years to obtain the mean for each of the 365 days (one year). Note that I did not apply the 11 day sliding window as per the heat wave function (windowHalfWidth), and rather opted to treat each doy independently as per Banzon et al. (2014). I repeat this 100 times, and so I effectively have estimates of a 100 annual cycles. I then do the same with 20 samples and 30 samples taken from the pool of available samples for each doy.</p>
<p>In total I now have 300 annual cycles: 100 of them representing a 10-year long times series, 100 representing a 20-year long time series, and 100 for a 30 year time series. To each of them, separately, I then fit the smooth climatology assembled from their Fourier components.</p>
<p>The attached plots show the outcome. The three panels represent 10, 20 and 30 year long time series. In Figure 2, each of the 100 daily time series is plotted as a line graph. In Figure 3, the red crosses show, for each doy, each of the 100 mean temperatures that I obtained. The black lines are of course the smooth climatologies–there is also 100 of these lines on each of the three panels.</p>
<p>So, using bootstrapping and a Fourier analysis we can get away with using shorter time series. I can see later what happens if I shrink even further the time series down to only five years long. I will also test how well the python and R heatwave scripts’ internal climatology functions (windowHalfWidth and smoothPercentile) are able to produce reliable climatologies from short time series.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(heatwaveR)
sst.in &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(heatwaveR<span class="op">::</span>sst_WA)
sst &lt;-<span class="st"> </span>sst.in <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">doy =</span> <span class="kw">yday</span>(<span class="kw">as.Date</span>(t))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>doy)

meanFun &lt;-<span class="st"> </span><span class="cf">function</span>(data) {
  m &lt;-<span class="st"> </span><span class="kw">mean</span>(data<span class="op">$</span>temp, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  <span class="kw">return</span>(m)
}

sstRepl &lt;-<span class="st"> </span><span class="cf">function</span>(sst) {
  sst.sampled &lt;-<span class="st"> </span>sst <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sample_10 =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, sample_n, <span class="dv">10</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),
           <span class="dt">sample_20 =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, sample_n, <span class="dv">20</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),
           <span class="dt">sample_30 =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, sample_n, <span class="dv">30</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sample_10_m =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(sample_<span class="dv">10</span>, meanFun),
           <span class="dt">sample_20_m =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(sample_<span class="dv">20</span>, meanFun),
           <span class="dt">sample_30_m =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(sample_<span class="dv">30</span>, meanFun)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>data, <span class="op">-</span>sample_<span class="dv">10</span>, <span class="op">-</span>sample_<span class="dv">20</span>, <span class="op">-</span>sample_<span class="dv">30</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">unnest</span>(sample_10_m, sample_20_m, sample_30_m)
  <span class="kw">return</span>(sst.sampled)
}

<span class="kw">library</span>(purrr)
sst.repl &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/rerun">rerun</a></span>(<span class="dv">100</span>, <span class="kw">sstRepl</span>(sst)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_df</a></span>(as.data.frame, <span class="dt">.id =</span> <span class="st">"rep"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">"ts.len"</span>, <span class="dt">value =</span> <span class="st">"temp"</span>, <span class="op">-</span>rep, <span class="op">-</span>doy)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plt2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> sst.repl, <span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> temp)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> rep), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">size =</span> <span class="fl">0.1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ts.len, <span class="dt">nrow =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Julian day"</span>, <span class="dt">y =</span> <span class="st">"SST (°C)"</span>, <span class="dt">title =</span> <span class="st">"Raw daily climatology"</span>,
       <span class="dt">subtitle =</span> <span class="st">"100 daily climatological means"</span>)
<span class="kw">ggsave</span>(plt2, <span class="dt">file =</span> <span class="st">"fig/WA_100_simul.png"</span>, <span class="dt">width =</span> <span class="dv">12</span>, <span class="dt">height =</span> <span class="dv">6</span>, <span class="dt">dpi =</span> <span class="dv">120</span>)</code></pre></div>
<div class="figure">
<img src="fig/WA_100_simul.png" alt="Figure 2. Bootstrapped reconstructions of daily climatologies based on mean SSTs derived from time series fo 10, 20 and 30 years long. Each of 100 realisations are plotted as individual black traces on the three panels." style="width:100.0%"><p class="caption"><strong>Figure 2.</strong> Bootstrapped reconstructions of daily climatologies based on mean SSTs derived from time series fo 10, 20 and 30 years long. Each of 100 realisations are plotted as individual black traces on the three panels.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sst.repl.nest &lt;-<span class="st"> </span>sst.repl <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>rep, <span class="op">-</span>ts.len)

sst.repl.smth &lt;-<span class="st"> </span>sst.repl.nest <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, fFun)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(data, smoothed)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plt3 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> sst.repl.smth, <span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> smoothed)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> temp), <span class="dt">shape =</span> <span class="st">"+"</span>, <span class="dt">colour =</span> <span class="st">"red"</span>, <span class="dt">alpha =</span> <span class="fl">0.1</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> rep), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">size =</span> <span class="fl">0.1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ts.len, <span class="dt">nrow =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Julian day"</span>, <span class="dt">y =</span> <span class="st">"SST (°C)"</span>, <span class="dt">title =</span> <span class="st">"WA SST: daily climatology"</span>,
       <span class="dt">subtitle =</span> <span class="st">"Fourier series: 7 basis functions"</span>) <span class="op">+</span>
<span class="kw">ggsave</span>(plt3, <span class="dt">file =</span> <span class="st">"fig/WA_Fourier7.png"</span>, <span class="dt">width =</span> <span class="dv">12</span>, <span class="dt">height =</span> <span class="dv">6</span>, <span class="dt">dpi =</span> <span class="dv">120</span>)</code></pre></div>
<div class="figure">
<img src="fig/WA_Fourier7.png" alt="Figure 3. Bootstrapped reconstructions of daily climatologies based on mean SSTs derived from time series of 10, 20 and 30 years long. Red lines are the smoothed climatologies obtained from a Fourier analysis." style="width:100.0%"><p class="caption"><strong>Figure 3.</strong> Bootstrapped reconstructions of daily climatologies based on mean SSTs derived from time series of 10, 20 and 30 years long. Red lines are the smoothed climatologies obtained from a Fourier analysis.</p>
</div>
</div>
<div id="heatwavers-climatology-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#heatwavers-climatology-functions" class="anchor"></a>heatwaveR’s climatology functions</h3>
<p>The heatwaveR climatology tool creates the mean and 90th percentiles (threshold) for all the data within a sliding window with certain window width (by default 11 days centered on a day-of-year), and then this is followed by a running mean smoother for both the mean and the threshold. Using he approach I created for the Fourier series, lets do the same here.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sstRepl2 &lt;-<span class="st"> </span><span class="cf">function</span>(sst) {
  sst.sampled &lt;-<span class="st"> </span>sst <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sample_10 =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, sample_n, <span class="dv">10</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),
           <span class="dt">sample_20 =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, sample_n, <span class="dv">20</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),
           <span class="dt">sample_30 =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, sample_n, <span class="dv">30</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>))
  <span class="kw">return</span>(sst.sampled)
}

sst.repl2 &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/rerun">rerun</a></span>(<span class="dv">100</span>, <span class="kw">sstRepl2</span>(sst)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_df</a></span>(as.data.frame, <span class="dt">.id =</span> <span class="st">"rep"</span>)

parseDates &lt;-<span class="st"> </span><span class="cf">function</span>(data, rep_col, len) {
  parsed &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">id =</span> rep_col,
           <span class="dt">y =</span> <span class="kw">year</span>(t),
           <span class="dt">m =</span> <span class="kw">month</span>(t),
           <span class="dt">d =</span> <span class="kw">day</span>(t)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(rep, doy) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">y =</span> <span class="kw">seq</span>(<span class="dv">1983</span>, <span class="dt">by =</span> <span class="dv">1</span>, <span class="dt">len =</span> len)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">t =</span> <span class="kw">ymd</span>(<span class="kw">paste</span>(y, m, d, <span class="dt">sep =</span> <span class="st">"-"</span>))) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>y, <span class="op">-</span>m, <span class="op">-</span>d) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">na.omit</span>() <span class="co"># because of complications due to leap years</span>
  <span class="kw">return</span>(parsed)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sample_<span class="dv">10</span> &lt;-<span class="st"> </span>sst.repl2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(sample_<span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parseDates</span>(<span class="st">"sample_10"</span>, <span class="dt">len =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, rep) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, <span class="cf">function</span>(x) <span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(x, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1983-01-01"</span>, <span class="st">"1992-12-31"</span>)))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(smoothed)

sample_<span class="dv">20</span> &lt;-<span class="st"> </span>sst.repl2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(sample_<span class="dv">20</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parseDates</span>(<span class="st">"sample_20"</span>, <span class="dt">len =</span> <span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, rep) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, <span class="cf">function</span>(x) <span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(x, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1983-01-01"</span>, <span class="st">"2002-12-31"</span>)))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(smoothed)

sample_<span class="dv">30</span> &lt;-<span class="st"> </span>sst.repl2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(sample_<span class="dv">30</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parseDates</span>(<span class="st">"sample_30"</span>, <span class="dt">len =</span> <span class="dv">30</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(id, rep) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">smoothed =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(data, <span class="cf">function</span>(x) <span class="kw"><a href="http://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(x, <span class="dt">climatologyPeriod =</span> <span class="kw">c</span>(<span class="st">"1983-01-01"</span>, <span class="st">"2012-12-31"</span>)))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">unnest</span>(smoothed)

sst.repl2.smth &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(sample_<span class="dv">10</span>, sample_<span class="dv">20</span>, sample_<span class="dv">30</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plt4 &lt;-<span class="st"> </span>sst.repl2.smth <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> doy, <span class="dt">y =</span> temp)) <span class="op">+</span>
<span class="st">  </span><span class="co"># geom_point(shape = "+", colour = "red", alpha = 0.1, size = 1) +</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> <span class="kw">filter</span>(sst.repl2.smth, t <span class="op">&lt;=</span><span class="st"> "1984-01-01"</span>), <span class="kw">aes</span>(<span class="dt">y =</span> seas, <span class="dt">group =</span> rep), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">size =</span> <span class="fl">0.1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>id, <span class="dt">nrow =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Julian day"</span>, <span class="dt">y =</span> <span class="st">"SST (°C)"</span>, <span class="dt">title =</span> <span class="st">"WA SST: daily climatology"</span>,
       <span class="dt">subtitle =</span> <span class="st">"MHW climatology, default settings"</span>)
<span class="kw">ggsave</span>(plt4, <span class="dt">file =</span> <span class="st">"fig/rand_mat_smoothed_2.png"</span>, <span class="dt">width =</span> <span class="dv">12</span>, <span class="dt">height =</span> <span class="dv">6</span>, <span class="dt">dpi =</span> <span class="dv">120</span>)</code></pre></div>
<div class="figure">
<img src="fig/rand_mat_smoothed_2.png" alt="Figure 4. Bootstrapped daily climatologies based on 10, 20 and 30 years long SST time series that were randomly assembled from the original 32-year long Western Australian SST data set included with the heatwaveR package. The lines are the smoothed climatologies obtained from applying the default heatwaveR climatology algorithm that includes a mean computed from all data withing a sliding 11-day wide window, centered on the doy, followed by a 31-day wide moving averages smoother." style="width:100.0%"><p class="caption"><strong>Figure 4.</strong> Bootstrapped daily climatologies based on 10, 20 and 30 years long SST time series that were randomly assembled from the original 32-year long Western Australian SST data set included with the heatwaveR package. The lines are the smoothed climatologies obtained from applying the default heatwaveR climatology algorithm that includes a mean computed from all data withing a sliding 11-day wide window, centered on the doy, followed by a 31-day wide moving averages smoother.</p>
</div>
<div id="refs" class="references">
<div id="ref-Banzon2014">
<p>Banzon, Viva F., Richard W. Reynolds, Diane Stokes, and Yan Xue. 2014. “A 1/4°-Spatial-resolution daily sea surface temperature climatology based on a blended satellite and in situ analysis.” <em>Journal of Climate</em> 27 (21): 8221–8. doi:<a href="https://doi.org/10.1175/JCLI-D-14-00293.1">10.1175/JCLI-D-14-00293.1</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#time-series-length">Time series length</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert W. Schlegel, Eric C. J. Oliver, Alistair J. Hobday, Albertus J. Smit.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
