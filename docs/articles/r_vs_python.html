<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Default MHW outputs in R and Python • MHWdetection</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Default MHW outputs in R and Python">
<meta property="og:description" content="This vignette compares the code/work flow one would use to calculate default (Hobday et al. 2016) MHWs in both R and Python as well as the different outputs and speeds.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MHWdetection</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/r_vs_python.html">Python vs. R - default outputs</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_arguments.html">Python vs. R - default arguments</a>
    </li>
    <li>
      <a href="../articles/r_vs_python_additional.html">Python vs. R - additional functions</a>
    </li>
    <li>
      <a href="../articles/Short_climatologies.html">Short climatologies</a>
    </li>
    <li>
      <a href="../articles/Climatologies_and_baselines.html">Alternative climatologies and baselines</a>
    </li>
    <li>
      <a href="../articles/time_series_duration.html">Effects of short time series</a>
    </li>
    <li>
      <a href="../articles/missing_data.html">Effects of missing data</a>
    </li>
    <li>
      <a href="../articles/gridded_products.html">Difference between gridded products</a>
    </li>
    <li>
      <a href="../articles/best_practices.html">Best practices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/robwschlegel/MHWdetection">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Default MHW outputs in R and Python</h1>
                        <h4 class="author">Robert W Schlegel</h4>
            
            <h4 class="date">2019-01-23</h4>
      
      
      <div class="hidden name"><code>r_vs_python.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The purpose of this vignette is to walk one through how to calculate MHWs in both the R and Python languages. It will use code from both languages throughout. The secondary purpose of this vignette is to show that the outputs are identical. The tertiary purpose of this vignette is to run benchmarks on the code to compare their speeds.</p>
</div>
<div id="calculating-events" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-events" class="anchor"></a>Calculating events</h2>
<p>First up, let’s look at the two different ways in which one may calculate MHWs. First we will look at the R code, then Python.</p>
<div id="r-code" class="section level3">
<h3 class="hasAnchor">
<a href="#r-code" class="anchor"></a>R code</h3>
<div id="setup" class="section level4">
<h4 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h4>
<p>The basic functionality for calculating marine heatwaves (MHWs) in R may be found in the <strong><code>heatwaveR</code></strong> package that may currently be downloaded and installed with the following lines of code. Note that if one has already installed these packages they do not need to be installed again. To run one of the lines in the following code chunk will require that the hash-tag first be removed.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># install.packages("devtools")</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">## Development version from GitHub</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co"># devtools::install_github("robwschlegel/heatwaveR") </span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">## Stable version from CRAN</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co"># install.packages("heatwaveR")</span></a></code></pre></div>
<p>With the necessary packages installed, we activate <code>heatwaveR</code> with the following line of code.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(heatwaveR)</a></code></pre></div>
</div>
<div id="default-output" class="section level4">
<h4 class="hasAnchor">
<a href="#default-output" class="anchor"></a>Default output</h4>
<p>With everything downloaded and ready for us to use we may now calculate some events. The <code>heatwaveR</code> package has three built in time series (<code>sst_WA</code>, <code>sst_Med</code>, <code>sst_NW_Atl</code>) that we may use to more easily demonstrate how the code works. The general pipeline in <code>R</code> for calculating events is first to create a climatology from a chosen time series using <code><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm()</a></code>, and then to feed that output into <code><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event()</a></code>, as seen below.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># First we create a default climatology as outlined in Hobday et al. (2016)</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="co"># NB: We use a longer climatology period here as this matches the Python default</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">ts_clim &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(<span class="dt">data =</span> sst_WA, <span class="dt">climatologyPeriod =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"1982-01-01"</span>, <span class="st">"2014-12-31"</span>))</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co"># Then we feed that object into the second and final function</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">res_r &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event</a></span>(ts_clim)</a></code></pre></div>
<p>To look at these outputs we would use the following options. For now we’ll just look at the event output.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co"># Look at the top six rows of the first 6 columns of the events</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">res_r<span class="op">$</span>event[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
##   event_no index_start index_peak index_end duration date_start
##      &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;date&gt;    
## 1        1         884        887       895       12 1984-06-02
## 2        2         899        901       904        6 1984-06-17
## 3        3         908        922       926       19 1984-06-26
## 4        4        1008       1010      1012        5 1984-10-04
## 5        5        1023       1027      1029        7 1984-10-19
## 6        6        1033       1034      1052       20 1984-10-29</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Or perhaps the most intense event</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">res_r<span class="op">$</span>event[res_r<span class="op">$</span>event<span class="op">$</span>intensity_max <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(res_r<span class="op">$</span>event<span class="op">$</span>intensity_max), <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]</a></code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   event_no index_start index_peak index_end duration date_start
##      &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;date&gt;    
## 1       42       10629      10651     10689       61 2011-02-06</code></pre>
</div>
</div>
<div id="python-code" class="section level3">
<h3 class="hasAnchor">
<a href="#python-code" class="anchor"></a>Python code</h3>
<div id="setup-1" class="section level4">
<h4 class="hasAnchor">
<a href="#setup-1" class="anchor"></a>Setup</h4>
<p>To download and install the Python package for calculating MHWs one may run the following line of code in a console:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">## This is a bash chunk ##</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co"># Note that the hashtag must be removed in orde for the code to run</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co"># pip install git+git://github.com/ecjoliver/marineHeatWaves@master</span></a></code></pre></div>
<p>Or simply download the <a href="https://github.com/ecjoliver/marineHeatWaves">GitHub repository</a> and follow the instructions there for downloading. Or if still lost, phone a friend!</p>
<p>Before we begin the calculations we need to create a time series. I’ve chosen to take the <code>sst_WA</code> time series from the <strong><code>heatwaveR</code></strong> package to ensure consistency between the results. The python code prefers to have the dates and the temperatures fed into it as two separate vectors, so I will first split these up in R before we feed them to Python.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># Get the built-in time series from heatwaveR</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">ts &lt;-<span class="st"> </span>sst_WA</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># Take only the temperature column</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">sst &lt;-<span class="st"> </span>ts<span class="op">$</span>temp</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co"># Take only date column</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">dates &lt;-<span class="st"> </span>ts<span class="op">$</span>t</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co"># If one wants to save the sst values to load into Python</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/write.table">write.csv</a></span>(ts<span class="op">$</span>temp, <span class="st">"data/sst_WA.csv"</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
</div>
<div id="default-calculations" class="section level4">
<h4 class="hasAnchor">
<a href="#default-calculations" class="anchor"></a>Default calculations</h4>
<p>With the package installed, and our time series prepped, the basic MHW calculation is performed as follows:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">## This is a Python chunk ##</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># Required for data prep and export</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="im">from</span> datetime <span class="im">import</span> date</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co"># The MHW functions</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="im">import</span> marineHeatWaves <span class="im">as</span> mhw</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co"># The date values</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">  <span class="co"># We could take the date values we created above,</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  <span class="co"># But let's rather create the date values in Python</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">t <span class="op">=</span> np.arange(date(<span class="dv">1982</span>,<span class="dv">1</span>,<span class="dv">1</span>).toordinal(),date(<span class="dv">2014</span>,<span class="dv">12</span>,<span class="dv">31</span>).toordinal()<span class="op">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co"># The temperature values</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">  <span class="co"># Note that to fetch an object created in R we use 'r.*'</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">  <span class="co"># Where '*' is the name of the R object</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">sst <span class="op">=</span> np.asarray(r.sst)</a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co"># Or if one rather wants to load the data from a csv file</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co"># sst = np.loadtxt("data/sst_WA.csv", delimiter=',', skiprows=1) # because a heading row needs to be skipped</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co"># The event metrics</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">mhws, clim <span class="op">=</span> mhw.detect(t, sst)</a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="co"># If one wants to save the results as csv files</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="co"># Save event results</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">mhws_df <span class="op">=</span> pd.DataFrame.from_dict(mhws)</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">mhws_df.to_csv(<span class="st">'data/mhws_py.csv'</span>, sep <span class="op">=</span> <span class="st">','</span>, index<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="co"># Save climatology results</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26">clim_df <span class="op">=</span> pd.DataFrame.from_dict(clim)</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">clim_df.to_csv(<span class="st">'data/clim_py.csv'</span>, sep <span class="op">=</span> <span class="st">','</span>, index<span class="op">=</span><span class="va">False</span>)</a></code></pre></div>
</div>
</div>
<div id="reticulate-code" class="section level3">
<h3 class="hasAnchor">
<a href="#reticulate-code" class="anchor"></a>Reticulate code</h3>
<p>It is also possible to run the Python code through R with the use of the R package <strong><code>reticulate</code></strong>. This is particularly useful as it allows us to perform the comparisons and benchmarking all within the same language.</p>
<div id="setup-2" class="section level4">
<h4 class="hasAnchor">
<a href="#setup-2" class="anchor"></a>Setup</h4>
<p>Here we load the <strong><code>reticulate</code></strong> package and choose the conda environment I’ve already created called <code>py27</code>. For help on how to set up a conda environment go <a href="https://conda.io/docs/user-guide/tasks/manage-environments.html">here</a>. I’ve ensured that all of the required python modules are installed within this environment.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co"># install.packages("reticulate")</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(reticulate)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/use_python">use_condaenv</a></span>(<span class="st">"py27"</span>)</a></code></pre></div>
<p>Once we’ve told R which version/environment we would like to use for Python we may then load the necessary modules.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">np &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/import">import</a></span>(<span class="st">"numpy"</span>)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">datetime &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/import">import</a></span>(<span class="st">"datetime"</span>)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">mhw &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/import">import</a></span>(<span class="st">"marineHeatWaves"</span>)</a></code></pre></div>
<p>One may run python code in it’s native form within R by passing it as a character vector to <code><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_run">py_run_string()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_run">py_run_string</a></span>(<span class="st">"t = np.arange(date(1982,1,1).toordinal(),date(2014,12,31).toordinal()+1)"</span>)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/reticulate/topics/py_run">py_run_string</a></span>(<span class="st">"sst = np.loadtxt(open('data/sst_WA.csv', 'r'), delimiter=',', skiprows=1)"</span>)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co"># py_run_string("sst.flags.writeable = True")</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co"># py_run_string("sst.setflags(write = True)")</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co"># py_run_string("sst = np.array(sst).copy()")</span></a></code></pre></div>
<p>Or we may just create the objects in native R.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co"># These numbers were taken from print(t) in the python code above</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">t &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">array</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">723546</span>, <span class="dv">735598</span>)))</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">sst &lt;-<span class="st"> </span>np<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">array</a></span>(sst_WA<span class="op">$</span>temp)</a></code></pre></div>
</div>
<div id="default-calculations-1" class="section level4">
<h4 class="hasAnchor">
<a href="#default-calculations-1" class="anchor"></a>Default calculations</h4>
<p>Either way, once we have created the necessary parts of the time series in either language, we may call the Python functions in R directly with the line of code below.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co"># The following line appears not to run because the numpy array that Python expects is given to it by R in a read-only format...</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co"># Thus far I've not found a way to correct for this.</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># So it appears that one may pass R objects to Python code directly, but not to reticulate code...</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">res_python &lt;-<span class="st"> </span>mhw<span class="op">$</span><span class="kw">detect</span>(<span class="dt">t =</span> t, <span class="dt">temp =</span> sst)</a></code></pre></div>
</div>
</div>
</div>
<div id="comparisons" class="section level2">
<h2 class="hasAnchor">
<a href="#comparisons" class="anchor"></a>Comparisons</h2>
<p>With some climatologies and events calculated with both languages we may now compare the results of the two. I’ll do so here natively in R to avoid any potential hiccups from translating across languages. I’ll create the R output here, and load the Python output created in the Python code chunk above.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co"># Load libraries for data manipulation and visualisation</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb16-5" data-line-number="5"></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co"># Set R results</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7">res_event_R &lt;-<span class="st"> </span>res_r<span class="op">$</span>event</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">res_clim_R &lt;-<span class="st"> </span>res_r<span class="op">$</span>climatology</a>
<a class="sourceLine" id="cb16-9" data-line-number="9"></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="co"># Set Python results</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">res_event_Python &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"data/mhws_py.csv"</span>)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">res_clim_Python &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"data/clim_py.csv"</span>)</a></code></pre></div>
<p>With these default results loaded in the same format in the same language we can now start to look at how they compare. For starters I am just doing some simple sums and correlations.</p>
<div id="climatologies" class="section level3">
<h3 class="hasAnchor">
<a href="#climatologies" class="anchor"></a>Climatologies</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(res_clim_R<span class="op">$</span>seas, res_clim_Python<span class="op">$</span>seas)</a></code></pre></div>
<pre><code>## [1] 0.9999999</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_R<span class="op">$</span>seas) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_Python<span class="op">$</span>seas)</a></code></pre></div>
<pre><code>## [1] -2.053821</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(res_clim_R<span class="op">$</span>thresh, res_clim_Python<span class="op">$</span>thresh)</a></code></pre></div>
<pre><code>## [1] 0.9999996</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_R<span class="op">$</span>thresh) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_Python<span class="op">$</span>thresh)</a></code></pre></div>
<pre><code>## [1] -6.573385</code></pre>
<p>The seasonal and threshold climatologies correlate very well, but adding them up we see that the Python values are consistently higher. This is due to rounding differences between the languages. Even though the sum difference between the thresholds may look large at a value of ~6.5, considering this is over 12053 days of data, the difference is only ~0.0005/day. So I think it is safe to move on and look at the events.</p>
</div>
<div id="february-29th" class="section level3">
<h3 class="hasAnchor">
<a href="#february-29th" class="anchor"></a>February 29th</h3>
<p>It was also recently brought to my attention by Zijie Zhao, author of the MATLAB distribution for MHW code, that Python and R calculate February 29th differently. With Python calculating the climatologies first, and then filling in the missing days, whereas R calculates February 29th first, and then the climatologies from that. So with that being said let’s have a peek at the difference this may cause.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"></a>
<a class="sourceLine" id="cb25-3" data-line-number="3">res_clim_R_<span class="dv">29</span> &lt;-<span class="st"> </span>res_clim_R <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(doy <span class="op">==</span><span class="st"> </span><span class="dv">60</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(seas, thresh) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb25-7" data-line-number="7">res_clim_Python_<span class="dv">29</span> &lt;-<span class="st"> </span>res_clim_Python <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(res_clim_R<span class="op">$</span>doy <span class="op">==</span><span class="st"> </span><span class="dv">60</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(seas, thresh) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb25-11" data-line-number="11"></a>
<a class="sourceLine" id="cb25-12" data-line-number="12">res_clim_R_<span class="dv">29</span><span class="op">$</span>seas <span class="op">-</span><span class="st"> </span>res_clim_Python_<span class="dv">29</span><span class="op">$</span>seas</a></code></pre></div>
<pre><code>## [1] 0.0003321473</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">res_clim_R_<span class="dv">29</span><span class="op">$</span>thresh <span class="op">-</span><span class="st"> </span>res_clim_Python_<span class="dv">29</span><span class="op">$</span>thresh</a></code></pre></div>
<pre><code>## [1] -0.005438159</code></pre>
<p>Another thing pointed out by Zijie is that Python and MATLAB calculate percentiles differently, this then is likely also true for R and Python. This would explain why the seasonal climatologies (<code>seas</code>) are always much closer than the thresholds (<code>thresh</code>) for all of these tests.</p>
</div>
<div id="events" class="section level3">
<h3 class="hasAnchor">
<a href="#events" class="anchor"></a>Events</h3>
<p>Below we have a for loop that will run a correlation on all rows with the same name, as well as find the sum difference between them.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="co"># Remove non-numeric columns</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4">res_event_num &lt;-<span class="st"> </span>res_event_R <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="st">  </span><span class="kw">select_if</span>(is.numeric)</a>
<a class="sourceLine" id="cb29-6" data-line-number="6"></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="co"># Run the loop</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8">res_event &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>()</a>
<a class="sourceLine" id="cb29-9" data-line-number="9"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_num))){</a>
<a class="sourceLine" id="cb29-10" data-line-number="10">  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_num)[i] <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_Python)){</a>
<a class="sourceLine" id="cb29-11" data-line-number="11">    x1 &lt;-<span class="st"> </span>res_event_R[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_R) <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_num)[i]]</a>
<a class="sourceLine" id="cb29-12" data-line-number="12">    x2 &lt;-<span class="st"> </span>res_event_Python[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_Python) <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_num)[i]]</a>
<a class="sourceLine" id="cb29-13" data-line-number="13">    x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">r =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(x1, x2, <span class="dt">use =</span> <span class="st">"complete.obs"</span>),</a>
<a class="sourceLine" id="cb29-14" data-line-number="14">                    <span class="dt">difference =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(x1, <span class="dt">na.rm =</span> T) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(x2, <span class="dt">na.rm =</span> T), <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb29-15" data-line-number="15">                    <span class="dt">var =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_num)[i])</a>
<a class="sourceLine" id="cb29-16" data-line-number="16">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(x)[<span class="dv">1</span>] &lt;-<span class="st"> "r"</span></a>
<a class="sourceLine" id="cb29-17" data-line-number="17">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">rownames</a></span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb29-18" data-line-number="18">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb29-19" data-line-number="19">      x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">r =</span> <span class="ot">NA</span>, <span class="dt">difference =</span> <span class="ot">NA</span>, <span class="dt">var =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_num)[i])</a>
<a class="sourceLine" id="cb29-20" data-line-number="20">      }</a>
<a class="sourceLine" id="cb29-21" data-line-number="21">  res_event &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(res_event, x)</a>
<a class="sourceLine" id="cb29-22" data-line-number="22">  }</a>
<a class="sourceLine" id="cb29-23" data-line-number="23"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/na.fail">na.omit</a></span>(res_event)</a></code></pre></div>
<pre><code>##            r difference                            var
## 2  1.0000000    60.0000                    index_start
## 3  1.0000000    60.0000                     index_peak
## 4  1.0000000    60.0000                      index_end
## 5  1.0000000     0.0000                       duration
## 6  0.9999991     0.0089                 intensity_mean
## 7  0.9999997     0.0087                  intensity_max
## 8  0.9996073     0.7347                  intensity_var
## 9  1.0000000     0.1630           intensity_cumulative
## 10 0.9999971     0.0160       intensity_mean_relThresh
## 11 0.9999994     0.0165        intensity_max_relThresh
## 12 0.9995693     0.7376        intensity_var_relThresh
## 13 0.9999996     0.4755 intensity_cumulative_relThresh
## 14 1.0000000     0.0000             intensity_mean_abs
## 15 0.9990733     1.6100              intensity_max_abs
## 16 0.9997263     0.7667              intensity_var_abs
## 17 1.0000000     0.0004       intensity_cumulative_abs
## 18 0.9999999    -0.0003                     rate_onset
## 19 0.9999999     0.0002                   rate_decline</code></pre>
<p>It is a bit odd that there is such a large difference between <code>intensity_var</code> for the two language. This implies that R is detecting larger differences in the intensity around the threshold than Python is. This may again be due to the differences in thresholds being detected, but that makes a rather small difference. It is perhaps more likely that variance is calculated slightly differently between languages. Looking at the source code one sees that this is calculated by first finding the variance of the intensity, and then the square root of that. These two calculations likely differ enough between the languages to be causing this. Ultimately it is of little concern as the variance values found throughout both packages are not of much interest to anyone.</p>
<p>We may also see that the difference in <code>intensity_max_abs</code> is a bit higher in Python than in R. This is rather surprising as <code>intensity_max_abs</code> simply shows the maximum temperature (independent of any thresholds etc.) experienced during that event. And considering that these calculations were performed on the exact same time series, <code>intensity_max_abs</code> should always be exactly the same between the two languages. Looking at the climatology output one sees that the temperature is still correct, meaning that the difference must occur somewhere within the R function <code>detect_event</code>. Looking at the R source code we see that <code>intensity_max_abs</code> is calculated on line 298, for Python this is calculated on line 376. The reason for the difference is because R is looking for the maximum temperature throughout all dates for a given event, whereas Python is simply taking the temperature on the peak date of the event. This is a subtle but significant difference as this means this value is showing two different things. I’m not certain which is more appropriate, though I’m leaning towards the Python implementation.</p>
<p>With all of our overlapping columns compared, and our differences and Pearson r values looking solid, let’s finish off this basic comparison by finding which columns are not shared between the different language outputs. Also, please note that the apparently large differences between the <code>index_start</code>, <code>index_peak</code>, and <code>index_end</code> values are due to the different indexing methods of R and Python. R starts at 1 and Python at 0. The</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"></a>
<a class="sourceLine" id="cb31-3" data-line-number="3">cols_R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_R)[<span class="op">!</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_R) <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_Python))]</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">cols_R</a></code></pre></div>
<pre><code>## [1] "event_no"</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">cols_Py &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_Python)[<span class="op">!</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_Python) <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_R))]</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">cols_Py</a></code></pre></div>
<pre><code>## [1] "category"          "duration_extreme"  "duration_moderate"
## [4] "duration_severe"   "duration_strong"   "n_events"         
## [7] "time_end"          "time_peak"         "time_start"</code></pre>
<p>Wonderful! Almost everything matches up exactly. The duration of categories of events is something added in R by another function <code><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/category">category()</a></code>, and will be left that way for now. The “time” columns in the Python output aren’t relevant as far as I can see in the present usage as these functions currently only take day values. The different methods of labelling the events will be left as they are for now as well.</p>
<p>It is also worth noting that the values for <code>index_start</code>, <code>index_peak</code>, and <code>index_end</code> are off by one between the two languages. This is due to the difference in indexing between the languages. Looking at the <code>date_start</code>, <code>date_peak</code>, and <code>date_end</code> values we see that they are the same.</p>
</div>
<div id="missing-data" class="section level3">
<h3 class="hasAnchor">
<a href="#missing-data" class="anchor"></a>Missing data</h3>
<p>A bug was discovered in v0.3.3 of the R code with regards to the handling of missing data. Specifically, in the move to a C++ back-end, the R code stopped being able to handle missing data for the climatology calculations. This has since been corrected from v0.3.4 onwards, but it is worthwhile to ensure that missing data are handled the same way.</p>
<p>First we’ll create the dataframe with missing data:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2"></a>
<a class="sourceLine" id="cb35-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(padr)</a>
<a class="sourceLine" id="cb35-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lubridate)</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">random_knockout &lt;-<span class="st"> </span><span class="cf">function</span>(df, prop){</a>
<a class="sourceLine" id="cb35-6" data-line-number="6">  res &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-7" data-line-number="7"><span class="st">    </span><span class="kw">sample_frac</span>(<span class="dt">size =</span> prop) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-8" data-line-number="8"><span class="st">    </span><span class="kw">arrange</span>(t) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-9" data-line-number="9"><span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/padr/topics/pad">pad</a></span>(<span class="dt">interval =</span> <span class="st">"day"</span>)</a>
<a class="sourceLine" id="cb35-10" data-line-number="10">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(res)</a>
<a class="sourceLine" id="cb35-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb35-12" data-line-number="12"></a>
<a class="sourceLine" id="cb35-13" data-line-number="13"><span class="co"># Remove 10% of the data randomly</span></a>
<a class="sourceLine" id="cb35-14" data-line-number="14">sst_WA_miss_random &lt;-<span class="st"> </span><span class="kw">random_knockout</span>(sst_WA, <span class="fl">0.9</span>)</a>
<a class="sourceLine" id="cb35-15" data-line-number="15"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/write.table">write.csv</a></span>(sst_WA_miss_random<span class="op">$</span>temp, <span class="dt">file =</span> <span class="st">"data/sst_WA_miss_random.csv"</span>, <span class="dt">row.names =</span> F, <span class="dt">na =</span> <span class="st">"NaN"</span>)</a>
<a class="sourceLine" id="cb35-16" data-line-number="16"></a>
<a class="sourceLine" id="cb35-17" data-line-number="17"><span class="co"># Remove simulated ice cover</span></a>
<a class="sourceLine" id="cb35-18" data-line-number="18">sst_WA_miss_ice &lt;-<span class="st"> </span>sst_WA <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">month =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/month.html">month</a></span>(t, <span class="dt">label =</span> T),</a>
<a class="sourceLine" id="cb35-20" data-line-number="20">         <span class="dt">temp =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(month <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Jan"</span>, <span class="st">"Feb"</span>, <span class="st">"Mar"</span>), <span class="ot">NA</span>, temp)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>month)</a>
<a class="sourceLine" id="cb35-22" data-line-number="22"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/write.table">write.csv</a></span>(sst_WA_miss_ice<span class="op">$</span>temp, <span class="dt">file =</span> <span class="st">"data/sst_WA_miss_ice.csv"</span>, <span class="dt">row.names =</span> F, <span class="dt">na =</span> <span class="st">"NaN"</span>)</a></code></pre></div>
<p>With the missing data saved, we can now calculate and compare the climatologies that the two different languages will create.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="co">## This is a Python chunk ##</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="co"># Required for data prep and export</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="im">from</span> datetime <span class="im">import</span> date</a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="co"># The MHW functions</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="im">import</span> marineHeatWaves <span class="im">as</span> mhw</a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="co"># The date values</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9">t <span class="op">=</span> np.arange(date(<span class="dv">1982</span>,<span class="dv">1</span>,<span class="dv">1</span>).toordinal(),date(<span class="dv">2014</span>,<span class="dv">12</span>,<span class="dv">31</span>).toordinal()<span class="op">+</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb36-10" data-line-number="10"><span class="co"># The temperature values</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11">sst_random <span class="op">=</span> np.loadtxt(<span class="st">"data/sst_WA_miss_random.csv"</span>, delimiter <span class="op">=</span> <span class="st">','</span>, skiprows <span class="op">=</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb36-12" data-line-number="12">sst_ice <span class="op">=</span> np.loadtxt(<span class="st">"data/sst_WA_miss_ice.csv"</span>, delimiter <span class="op">=</span> <span class="st">','</span>, skiprows <span class="op">=</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb36-13" data-line-number="13"><span class="co"># The event metrics</span></a>
<a class="sourceLine" id="cb36-14" data-line-number="14">mhws_random, clim_random <span class="op">=</span> mhw.detect(t, sst_random)</a>
<a class="sourceLine" id="cb36-15" data-line-number="15"><span class="co"># It appears as though the Python code can't deal with ice coverage...</span></a>
<a class="sourceLine" id="cb36-16" data-line-number="16"><span class="co">#mhws_ice, clim_ice = mhw.detect(t, sst_ice)</span></a>
<a class="sourceLine" id="cb36-17" data-line-number="17"><span class="co"># Save climatology results</span></a>
<a class="sourceLine" id="cb36-18" data-line-number="18">clim_random_df <span class="op">=</span> pd.DataFrame.from_dict(clim_random)</a>
<a class="sourceLine" id="cb36-19" data-line-number="19">clim_random_df.to_csv(<span class="st">'data/clim_py_random.csv'</span>, sep <span class="op">=</span> <span class="st">','</span>, index <span class="op">=</span> <span class="va">False</span>)</a>
<a class="sourceLine" id="cb36-20" data-line-number="20">mhws_random_df <span class="op">=</span> pd.DataFrame.from_dict(mhws_random)</a>
<a class="sourceLine" id="cb36-21" data-line-number="21">mhws_random_df.to_csv(<span class="st">'data/mhws_py_random.csv'</span>, sep <span class="op">=</span> <span class="st">','</span>, index <span class="op">=</span> <span class="va">False</span>)</a>
<a class="sourceLine" id="cb36-22" data-line-number="22"><span class="co">#clim_ice_df = pd.DataFrame.from_dict(clim_ice)</span></a>
<a class="sourceLine" id="cb36-23" data-line-number="23"><span class="co">#clim_ice_df.to_csv('data/clim_ice_py.csv', sep = ',', index = False)</span></a></code></pre></div>
<p>With the Python climatologies and events calculated from the missing data we’ll now do the same for R.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2"></a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="co"># Load and prep missing data</span></a>
<a class="sourceLine" id="cb37-4" data-line-number="4">sst_WA_miss_random &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"data/sst_WA_miss_random.csv"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">temp =</span> x) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"1982-01-01"</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"2014-12-31"</span>), <span class="dt">by =</span> <span class="st">"day"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(t, temp)</a>
<a class="sourceLine" id="cb37-8" data-line-number="8">sst_WA_miss_random<span class="op">$</span>temp[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/is.finite">is.nan</a></span>(sst_WA_miss_random<span class="op">$</span>temp)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9"></a>
<a class="sourceLine" id="cb37-10" data-line-number="10"><span class="co"># caluclate R climatologies/events</span></a>
<a class="sourceLine" id="cb37-11" data-line-number="11">res_random_R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(sst_WA_miss_random, <span class="dt">climatologyPeriod =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"1982-01-01"</span>, <span class="st">"2014-12-31"</span>)))</a>
<a class="sourceLine" id="cb37-12" data-line-number="12">res_clim_random_R &lt;-<span class="st"> </span>res_random_R<span class="op">$</span>climatology</a>
<a class="sourceLine" id="cb37-13" data-line-number="13">res_event_random_R &lt;-<span class="st"> </span>res_random_R<span class="op">$</span>event</a>
<a class="sourceLine" id="cb37-14" data-line-number="14"></a>
<a class="sourceLine" id="cb37-15" data-line-number="15"><span class="co"># Load Python results</span></a>
<a class="sourceLine" id="cb37-16" data-line-number="16">res_clim_random_Python &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"data/clim_py_random.csv"</span>)</a>
<a class="sourceLine" id="cb37-17" data-line-number="17">res_event_random_Python &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"data/mhws_py_random.csv"</span>)</a></code></pre></div>
<p>And then the comparisons of the <code>seas</code> and <code>thresh</code> values.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"></a>
<a class="sourceLine" id="cb38-3" data-line-number="3"><span class="co"># Compare clims/thresholds</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(res_clim_random_R<span class="op">$</span>seas, res_clim_random_Python<span class="op">$</span>seas)</a></code></pre></div>
<pre><code>## [1] 0.9999996</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_random_R<span class="op">$</span>seas) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_random_Python<span class="op">$</span>seas)</a></code></pre></div>
<pre><code>## [1] -2.372016</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(res_clim_random_R<span class="op">$</span>thresh, res_clim_random_Python<span class="op">$</span>thresh)</a></code></pre></div>
<pre><code>## [1] 0.9999343</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_random_R<span class="op">$</span>thresh) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(res_clim_random_Python<span class="op">$</span>thresh)</a></code></pre></div>
<pre><code>## [1] -866.0401</code></pre>
<p>We may see from the results above that the values still correlate very strongly, if slightly less so than with no missing data. We see again that the Python values are higher overall for both the seasonal climatology and the threshold. This time however the differences are much larger. The seasonal climatology is off by ~0.0004/day, which is acceptable, but the 90th percentile threshold is off by ~0.0695. This is too large of a difference and this issue will need to be investigated. It is most likely due to the difference in how quantiles are calculated between the languages though and so there may be little to do about it. Perhaps more importantly is how these differences may affect the events being detected.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"></a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(res_event_random_R)</a></code></pre></div>
<pre><code>## [1] 57</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(res_event_random_Python)</a></code></pre></div>
<pre><code>## [1] 53</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb50-2" data-line-number="2"></a>
<a class="sourceLine" id="cb50-3" data-line-number="3"><span class="co"># Remove non-numeric columns</span></a>
<a class="sourceLine" id="cb50-4" data-line-number="4">res_event_random_num &lt;-<span class="st"> </span>res_event_random_R <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="st">  </span><span class="kw">select_if</span>(is.numeric)</a>
<a class="sourceLine" id="cb50-6" data-line-number="6"></a>
<a class="sourceLine" id="cb50-7" data-line-number="7"><span class="co"># Run the loop</span></a>
<a class="sourceLine" id="cb50-8" data-line-number="8">res_event_random &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>()</a>
<a class="sourceLine" id="cb50-9" data-line-number="9"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_num))){</a>
<a class="sourceLine" id="cb50-10" data-line-number="10">  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_num)[i] <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_Python)){</a>
<a class="sourceLine" id="cb50-11" data-line-number="11">    x1 &lt;-<span class="st"> </span>res_event_random_R[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_R) <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_num)[i]]</a>
<a class="sourceLine" id="cb50-12" data-line-number="12">    x2 &lt;-<span class="st"> </span>res_event_random_Python[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_Python) <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_num)[i]]</a>
<a class="sourceLine" id="cb50-13" data-line-number="13">    x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">difference =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(x1, <span class="dt">na.rm =</span> T) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(x2, <span class="dt">na.rm =</span> T), <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb50-14" data-line-number="14">                    <span class="dt">var =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_num)[i])</a>
<a class="sourceLine" id="cb50-15" data-line-number="15">    <span class="co"># colnames(x)[1] &lt;- "r"</span></a>
<a class="sourceLine" id="cb50-16" data-line-number="16">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">rownames</a></span>(x) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb50-17" data-line-number="17">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb50-18" data-line-number="18">      x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">difference =</span> <span class="ot">NA</span>, <span class="dt">var =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(res_event_random_num)[i])</a>
<a class="sourceLine" id="cb50-19" data-line-number="19">      }</a>
<a class="sourceLine" id="cb50-20" data-line-number="20">  res_event_random &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(res_event_random, x)</a>
<a class="sourceLine" id="cb50-21" data-line-number="21">  }</a>
<a class="sourceLine" id="cb50-22" data-line-number="22"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/na.fail">na.omit</a></span>(res_event_random)</a></code></pre></div>
<pre><code>##    difference                            var
## 2  19349.0000                    index_start
## 3  19365.0000                     index_peak
## 4  19420.0000                      index_end
## 5     75.0000                       duration
## 6      3.7080                 intensity_mean
## 7      6.6284                  intensity_max
## 8      2.8726                  intensity_var
## 9     93.4348           intensity_cumulative
## 10     2.4525       intensity_mean_relThresh
## 11     5.4013        intensity_max_relThresh
## 12     2.8771        intensity_var_relThresh
## 13    57.0796 intensity_cumulative_relThresh
## 14    91.7193             intensity_mean_abs
## 15    95.5900              intensity_max_abs
## 16     3.0015              intensity_var_abs
## 17  1686.3577       intensity_cumulative_abs
## 18     3.4802                     rate_onset
## 19    -0.2195                   rate_decline</code></pre>
<p>Because the count of events detected is not the same, we cannot run correlations. We can sum up the differences to get an idea of how far off things are, and we can see that the results are troubling. The differences in the <code>index_*</code> values can be discounted as we have already established that we have a different number of events. The next largest difference is that for <code>intensity_cumulative_abs</code>. Looking at the one event that is the same between the languages one may see that this value is the same for both, meaning that we may discount this difference as it is not due to calculation differences, but rather also due to the differing number of events. Regardless, it is an indicator that overall the much lower threshold in the R language is giving us results that look much more dire than the Python language. This is problematic and stems from the quantile calculation issue.</p>
<p>I looked into this in quite some detail and it appears to stem not only from the calculation of quantiles being different, but also from the R quantile calculations never giving more than one additional decimal place of precision over the initial data, whereas the Python results float near infinity. This explains why the R results always tend to be lower, but does not account for why the presence of missing data has such a dramatic effect.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="co">## This is an R chunk ##</span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2"></a>
<a class="sourceLine" id="cb52-3" data-line-number="3">clim_only_random_R &lt;-<span class="st"> </span>res_clim_random_R <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(doy, seas, thresh) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-5" data-line-number="5"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(doy <span class="op">!=</span><span class="st"> </span><span class="dv">60</span>)</a>
<a class="sourceLine" id="cb52-7" data-line-number="7"></a>
<a class="sourceLine" id="cb52-8" data-line-number="8">clim_only_random_Python &lt;-<span class="st"> </span>res_clim_random_Python <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-9" data-line-number="9"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">365</span>)</a>
<a class="sourceLine" id="cb52-10" data-line-number="10"></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(clim_only_random_R<span class="op">$</span>seas, clim_only_random_Python<span class="op">$</span>seas)</a></code></pre></div>
<pre><code>## [1] 0.9999996</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(clim_only_random_R<span class="op">$</span>seas) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(clim_only_random_Python<span class="op">$</span>seas)</a></code></pre></div>
<pre><code>## [1] -0.07149032</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(clim_only_random_R<span class="op">$</span>seas, clim_only_random_Python<span class="op">$</span>seas)</a></code></pre></div>
<pre><code>## [1] 0.9999996</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(clim_only_random_R<span class="op">$</span>thresh) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(clim_only_random_Python<span class="op">$</span>thresh)</a></code></pre></div>
<pre><code>## [1] -26.22067</code></pre>
<p>Looking at only the values for one seasonal climatology or threshold cycle we see that the differences are the same as when we compare all of the data. I don’t know why they wouldn’t be… but I wanted to check.</p>
<p>After having gone over the R code very thoroughly I think the next course of action is to go through the step by step output of the Python code to see where exactly these changes begin to occur. It could be in the following places:</p>
<ul>
<li>clim_calc_cpp: The calculation of quantile values
<ul>
<li>The rounding of the results to 0.001 will have an influence, but can’t explain the size of the difference when missing data are present</li>
</ul>
</li>
<li>smooth_percentile: RcppRoll::roll_mean is used for the rolling means and this may differ greatly from Python when missing data are present
<ul>
<li>Line 290 in the Python code is where the function <code>runavg</code> is used for the same purpose</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="benchmarks" class="section level2">
<h2 class="hasAnchor">
<a href="#benchmarks" class="anchor"></a>Benchmarks</h2>
<p>The final thing we want to look at in this vignette is the speed differences in calculating MHWs between the two languages.</p>
<div id="r" class="section level3">
<h3 class="hasAnchor">
<a href="#r" class="anchor"></a>R</h3>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(microbenchmark)</a>
<a class="sourceLine" id="cb60-2" data-line-number="2"><span class="co"># The old R code</span></a>
<a class="sourceLine" id="cb60-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(RmarineHeatWaves)</a>
<a class="sourceLine" id="cb60-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/microbenchmark/topics/microbenchmark">microbenchmark</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/RmarineHeatWaves/topics/detect">detect</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/RmarineHeatWaves/topics/make_whole">make_whole</a></span>(<span class="dt">data =</span> sst_WA), <span class="dt">climatology_start =</span> <span class="st">"1982-01-01"</span>, <span class="dt">climatology_end =</span> <span class="st">"2014-12-31"</span>), <span class="dt">times =</span> <span class="dv">10</span>)</a></code></pre></div>
<pre><code>## Unit: seconds
##                                                                                                      expr
##  detect(make_whole(data = sst_WA), climatology_start = "1982-01-01",      climatology_end = "2014-12-31")
##       min       lq     mean   median       uq      max neval
##  1.040593 1.048529 1.211674 1.081987 1.190646 2.022516    10</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1"><span class="co"># The new R code</span></a>
<a class="sourceLine" id="cb62-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/microbenchmark/topics/microbenchmark">microbenchmark</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/detect_event">detect_event</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/ts2clm">ts2clm</a></span>(<span class="dt">data =</span> sst_WA, <span class="dt">climatologyPeriod =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"1982-01-01"</span>, <span class="st">"2014-12-31"</span>))), <span class="dt">times =</span> <span class="dv">10</span>)</a></code></pre></div>
<pre><code>## Unit: milliseconds
##                                                                                         expr
##  detect_event(ts2clm(data = sst_WA, climatologyPeriod = c("1982-01-01",      "2014-12-31")))
##       min       lq     mean   median       uq      max neval
##  192.4564 208.8704 279.6261 287.8735 319.2132 383.9136    10</code></pre>
<p>Unsurprisingly, the average for running the heatwave analysis on <strong><code>heatwaveR</code></strong> 10 times comes out at ~0.194 seconds per calculations, which is faster than the average of ~0.730 with <strong><code>RmarineHeatWaves</code></strong>.</p>
</div>
<div id="python" class="section level3">
<h3 class="hasAnchor">
<a href="#python" class="anchor"></a>Python</h3>
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb64-1" data-line-number="1"><span class="im">import</span> time</a>
<a class="sourceLine" id="cb64-2" data-line-number="2">total <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb64-3" data-line-number="3"><span class="cf">for</span> i <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Control">in</a></span> <span class="bu">range</span>(<span class="dv">10</span>):</a>
<a class="sourceLine" id="cb64-4" data-line-number="4">    start <span class="op">=</span> time.clock()</a>
<a class="sourceLine" id="cb64-5" data-line-number="5">    mhws, clim <span class="op">=</span> mhw.detect(t, sst)</a>
<a class="sourceLine" id="cb64-6" data-line-number="6">    end <span class="op">=</span> time.clock()</a>
<a class="sourceLine" id="cb64-7" data-line-number="7">    total <span class="op">+=</span> end<span class="op">-</span>start</a>
<a class="sourceLine" id="cb64-8" data-line-number="8">bench_py <span class="op">=</span> total<span class="op">/</span><span class="dv">10</span></a>
<a class="sourceLine" id="cb64-9" data-line-number="9"><span class="bu">print</span>(bench_py)</a></code></pre></div>
<pre><code>## 0.173738</code></pre>
<p>The average speed for running the Python code 10 times comes out at ~0.175 seconds, which is slightly faster than R. And the Python code is also calculating the event categories, which R is not. That is done in an additional step with <code><a href="https://www.rdocumentation.org/packages/heatwaveR/topics/category">category()</a></code>. The R code is however allowing for a wider range of options for climatologies, and may be more easily multi-cored, as shown in this <a href="https://robwschlegel.github.io/heatwaveR/articles/gridded_event_detection.html">vignette</a>.</p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>Overall the basic applications of these two languages provide near identical results, and nearly the same computational time. I would not say that one is better enough than the other to warrant switching between languages. Rather this vignette supports the argument that people collaborating on a research project while using R and Python do not need to worry about their results. The exception currently being that large amounts of missing data appear to be influencing the calculation of the 90th percentile threshold differently. This is something that will be investigated further and corrected as necessary.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#calculating-events">Calculating events</a></li>
      <li><a href="#comparisons">Comparisons</a></li>
      <li><a href="#benchmarks">Benchmarks</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert W. Schlegel, Eric C. J. Oliver, Alistair J. Hobday, Albertus J. Smit.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
